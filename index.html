<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Task Master Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* === НАСТРОЙКИ ТЕМ И ПЕРЕМЕННЫЕ === */
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --text: #111827;
      --hint: #6b7280;
      --border: #e5e7eb;
      --primary: #3b82f6;
      --primary-fg: #ffffff;
      --danger: #ef4444;
      --success: #10b981;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --glass: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.5);
    }

    html[data-theme="dark"] {
      --bg: #111827;
      --surface: #1f2937;
      --text: #f9fafb;
      --hint: #9ca3af;
      --border: #374151;
      --primary: #60a5fa;
      --primary-fg: #111827;
      --glass: rgba(31, 41, 55, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    /* Доп. темы (примеры) */
    html[data-theme="olive"] { --bg:#f0fdf4; --surface:#ffffff; --primary:#15803d; }
    html[data-theme="sunset"] { --bg:#fff7ed; --surface:#ffffff; --primary:#ea580c; }

    /* === БАЗОВЫЕ СТИЛИ === */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; transition: background-color 0.3s, color 0.3s; padding-bottom: 80px; }

    /* === УТИЛИТЫ === */
    .glass-panel {
      background: var(--glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
    }
    
    .card-3d {
      background: var(--surface);
      border-radius: 1rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-3d:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    
    .btn-primary {
      background: var(--primary);
      color: var(--primary-fg);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: transform 0.1s;
    }
    .btn-primary:active { transform: scale(0.96); }

    .input-field {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      transition: border-color 0.2s;
    }
    .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

    /* Скроллбар */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--hint); border-radius: 3px; opacity: 0.5; }

    /* Премиум анимация */
    @keyframes shine {
      0% { background-position: 200% center; }
      100% { background-position: -200% center; }
    }
    .premium-text {
      background: linear-gradient(to right, #facc15, #f59e0b, #facc15);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      background-size: 200% auto;
      animation: shine 3s linear infinite;
      font-weight: 800;
    }

    /* Модальные окна */
    .modal-enter { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes modalIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Kanban */
    .kanban-col { min-height: 50vh; background: rgba(0,0,0,0.03); border-radius: 12px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- HEADER -->
<header class="fixed top-0 inset-x-0 z-30 glass-panel border-b border-gray-200/50 dark:border-gray-700/50">
  <div class="container mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <button id="menu-btn" class="p-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 active:scale-95 transition">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <h1 class="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-[var(--primary)] to-purple-500">
        TaskMaster
      </h1>
      <div id="premium-badge-header" class="hidden text-xs font-bold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 border border-yellow-300 ml-2 shadow-sm">
        PRO
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="sync-status" class="text-xs text-[var(--hint)] mr-2 animate-pulse hidden"><i class="fas fa-sync"></i></button>
      <button id="search-toggle" class="p-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 transition">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>
</header>

<!-- SIDE MENU -->
<div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity"></div>
<aside id="sidebar" class="fixed top-0 left-0 bottom-0 w-72 bg-[var(--surface)] z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
  <div class="p-6 border-b border-[var(--border)] flex items-center gap-4">
    <div id="user-avatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold text-xl shadow-lg">?</div>
    <div>
      <div id="user-name" class="font-bold text-lg truncate">Гость</div>
      <div id="user-status" class="text-xs text-[var(--hint)]">Free Plan</div>
    </div>
  </div>
  <div class="flex-1 overflow-y-auto p-4 space-y-2">
    <button class="w-full text-left px-4 py-3 rounded-xl hover:bg-[var(--bg)] flex items-center gap-3 font-medium transition" onclick="app.openSettings()">
      <i class="fas fa-cog text-[var(--primary)]"></i> Настройки
    </button>
    <button class="w-full text-left px-4 py-3 rounded-xl hover:bg-[var(--bg)] flex items-center gap-3 font-medium transition" onclick="app.backup.exportData()">
      <i class="fas fa-file-export text-green-500"></i> Бэкап (JSON)
    </button>
    <div class="mt-4 border-t border-[var(--border)] pt-4">
      <div class="text-xs font-bold text-[var(--hint)] uppercase mb-2 px-4">Проекты</div>
      <div id="sidebar-projects" class="space-y-1"></div>
    </div>
  </div>
  <div class="p-4 border-t border-[var(--border)]">
    <button id="btn-premium-sidebar" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold shadow-lg transform hover:scale-[1.02] transition">
      <i class="fas fa-crown mr-2"></i> Получить Premium
    </button>
    <div id="admin-link-container" class="mt-2 hidden">
        <button onclick="app.openAdmin()" class="w-full py-2 text-xs text-[var(--hint)] hover:text-[var(--text)]">Админ панель</button>
    </div>
  </div>
</aside>

<!-- MAIN CONTENT -->
<main class="container mx-auto px-4 pt-20 pb-24">
  
  <!-- DASHBOARD STATS -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <div class="card-3d p-4 flex flex-col justify-between">
      <div class="text-[var(--hint)] text-xs font-bold uppercase">В работе</div>
      <div class="text-2xl font-black text-[var(--primary)]" id="stat-progress">0</div>
    </div>
    <div class="card-3d p-4 flex flex-col justify-between">
      <div class="text-[var(--hint)] text-xs font-bold uppercase">Сегодня</div>
      <div class="text-2xl font-black text-orange-500" id="stat-today">0</div>
    </div>
    <div class="card-3d p-4 flex flex-col justify-between">
      <div class="text-[var(--hint)] text-xs font-bold uppercase">Готово</div>
      <div class="text-2xl font-black text-green-500" id="stat-done">0</div>
    </div>
    <div class="card-3d p-4 flex flex-col justify-between bg-gradient-to-br from-[var(--primary)] to-purple-600 text-white border-none">
      <div class="text-white/80 text-xs font-bold uppercase">Всего</div>
      <div class="text-2xl font-black" id="stat-total">0</div>
    </div>
  </div>

  <!-- VIEW CONTROLS -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold" id="view-title">Мои задачи</h2>
    <div class="flex bg-[var(--surface)] p-1 rounded-xl border border-[var(--border)] shadow-sm">
      <button onclick="app.switchView('list')" class="p-2 rounded-lg text-[var(--hint)] hover:bg-[var(--bg)] active-view" data-view="list"><i class="fas fa-list"></i></button>
      <button onclick="app.switchView('kanban')" class="p-2 rounded-lg text-[var(--hint)] hover:bg-[var(--bg)]" data-view="kanban"><i class="fas fa-columns"></i></button>
      <button onclick="app.switchView('calendar')" class="p-2 rounded-lg text-[var(--hint)] hover:bg-[var(--bg)]" data-view="calendar"><i class="fas fa-calendar-alt"></i></button>
    </div>
  </div>

  <!-- SEARCH BAR (Toggleable) -->
  <div id="search-bar" class="hidden mb-4 relative animate-fade-in-down">
    <input type="text" id="search-input" placeholder="Поиск задач..." class="w-full pl-10 pr-4 py-3 rounded-xl input-field shadow-sm">
    <i class="fas fa-search absolute left-3 top-3.5 text-[var(--hint)]"></i>
  </div>

  <!-- VIEWS CONTAINERS -->
  <div id="view-container" class="relative min-h-[50vh]">
    <!-- LIST VIEW -->
    <div id="view-list" class="space-y-3"></div>

    <!-- KANBAN VIEW -->
    <div id="view-kanban" class="hidden overflow-x-auto pb-4">
      <div class="flex gap-4 min-w-[800px]">
        <div class="flex-1 kanban-col p-3" data-status="backlog">
          <div class="flex justify-between mb-3 px-1"><span class="font-bold text-gray-500">Бэклог</span><span class="bg-gray-200 text-xs px-2 py-0.5 rounded-full count">0</span></div>
          <div class="space-y-2 k-body"></div>
        </div>
        <div class="flex-1 kanban-col p-3" data-status="in-progress">
          <div class="flex justify-between mb-3 px-1"><span class="font-bold text-blue-500">В работе</span><span class="bg-blue-100 text-xs px-2 py-0.5 rounded-full count">0</span></div>
          <div class="space-y-2 k-body"></div>
        </div>
        <div class="flex-1 kanban-col p-3" data-status="done">
          <div class="flex justify-between mb-3 px-1"><span class="font-bold text-green-500">Готово</span><span class="bg-green-100 text-xs px-2 py-0.5 rounded-full count">0</span></div>
          <div class="space-y-2 k-body"></div>
        </div>
      </div>
    </div>

    <!-- CALENDAR VIEW -->
    <div id="view-calendar" class="hidden">
      <div class="bg-[var(--surface)] rounded-2xl shadow p-4">
        <div class="text-center text-[var(--hint)] py-10"><i class="fas fa-crown text-4xl text-yellow-400 mb-3"></i><br>Календарь доступен в Premium</div>
      </div>
    </div>
  </div>

</main>

<!-- FLOATING ACTION BUTTON -->
<button onclick="app.openTaskModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-[var(--primary)] text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl active:scale-90 transition z-30 hover:rotate-90 duration-300">
  <i class="fas fa-plus"></i>
</button>

<!-- TASK MODAL -->
<div id="task-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="app.closeTaskModal()"></div>
  <div class="relative bg-[var(--surface)] w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden modal-enter flex flex-col max-h-[90vh]">
    <div class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg)]">
      <h3 class="font-bold text-lg" id="modal-title">Задача</h3>
      <button onclick="app.closeTaskModal()" class="w-8 h-8 rounded-full hover:bg-black/10 flex items-center justify-center"><i class="fas fa-times"></i></button>
    </div>
    <div class="p-5 overflow-y-auto space-y-4 flex-1">
      <input type="hidden" id="task-id">
      <input type="text" id="task-title" placeholder="Что нужно сделать?" class="w-full text-xl font-bold bg-transparent border-none focus:ring-0 p-0 placeholder-gray-400">
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Дата</label>
          <input type="date" id="task-date" class="w-full input-field rounded-lg px-3 py-2 text-sm">
        </div>
        <div>
          <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Приоритет</label>
          <select id="task-priority" class="w-full input-field rounded-lg px-3 py-2 text-sm">
            <option value="low">Низкий</option>
            <option value="medium" selected>Средний</option>
            <option value="high">Высокий</option>
          </select>
        </div>
      </div>

      <div>
        <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Проект</label>
        <div class="flex gap-2">
            <select id="task-project" class="flex-1 input-field rounded-lg px-3 py-2 text-sm"></select>
            <button onclick="app.addProjectPrompt()" class="px-3 rounded-lg border border-dashed border-[var(--primary)] text-[var(--primary)] hover:bg-blue-50">+</button>
        </div>
      </div>

      <div>
        <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Повтор</label>
        <select id="task-repeat" class="w-full input-field rounded-lg px-3 py-2 text-sm">
            <option value="none">Не повторять</option>
            <option value="daily">Каждый день</option>
            <option value="weekly">Каждую неделю</option>
        </select>
      </div>

      <div>
        <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Описание</label>
        <textarea id="task-desc" rows="3" class="w-full input-field rounded-lg px-3 py-2 text-sm resize-none"></textarea>
      </div>

      <div>
        <label class="text-xs font-bold text-[var(--hint)] uppercase mb-1 block">Подзадачи</label>
        <div id="subtask-list" class="space-y-2 mb-2"></div>
        <div class="flex gap-2">
            <input type="text" id="new-subtask" placeholder="Новый пункт..." class="flex-1 input-field rounded-lg px-3 py-2 text-sm" onkeydown="if(event.key==='Enter') app.addSubtask()">
            <button onclick="app.addSubtask()" class="px-3 rounded-lg bg-[var(--surface)] border border-[var(--border)]">+</button>
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-[var(--border)] flex justify-end gap-3 bg-[var(--bg)]">
       <button onclick="app.deleteTask()" id="btn-delete-task" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-medium mr-auto hidden">Удалить</button>
       <button onclick="app.closeTaskModal()" class="px-4 py-2 rounded-lg hover:bg-black/5 text-sm font-medium">Отмена</button>
       <button onclick="app.saveTask()" class="btn-primary px-6 py-2 rounded-lg text-sm font-bold">Сохранить</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="document.getElementById('settings-modal').classList.add('hidden')"></div>
    <div class="relative bg-[var(--surface)] w-full max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl p-6 modal-enter">
        <h3 class="text-xl font-bold mb-4">Настройки</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">Тема оформления</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="app.setTheme('light')" class="h-10 rounded-lg bg-gray-100 border border-gray-300"></button>
                    <button onclick="app.setTheme('dark')" class="h-10 rounded-lg bg-gray-800 border border-gray-600"></button>
                    <button onclick="app.setTheme('sunset')" class="h-10 rounded-lg bg-orange-100 border border-orange-300 relative overflow-hidden"><div class="absolute inset-0 bg-gradient-to-r from-orange-200 to-red-200 opacity-50"></div></button>
                </div>
            </div>

            <div class="pt-4 border-t border-[var(--border)]">
                <h4 class="font-medium mb-2">Данные</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="app.backup.exportData()" class="py-2 px-3 rounded-lg border border-[var(--border)] text-sm hover:bg-[var(--bg)]"> Скачать JSON</button>
                    <label class="py-2 px-3 rounded-lg border border-[var(--border)] text-sm hover:bg-[var(--bg)] text-center cursor-pointer">
                        Восстановить
                        <input type="file" class="hidden" onchange="app.backup.importData(this)">
                    </label>
                </div>
            </div>
             <div class="pt-4 border-t border-[var(--border)] text-center">
                <div class="text-xs text-[var(--hint)] mb-2">Версия 2.5 (Enterprise Optimized)</div>
                <button onclick="localStorage.clear(); location.reload()" class="text-xs text-red-400 hover:text-red-500">Сброс приложения</button>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN MODAL -->
<div id="admin-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="app.closeAdmin()"></div>
    <div class="relative bg-gray-900 text-white w-full max-w-lg rounded-2xl shadow-2xl p-6 modal-enter border border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-green-400 font-mono">ADMIN_PANEL_V2</h3>
            <button onclick="app.closeAdmin()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <div class="text-xs text-gray-400">Total Users</div>
                <div class="text-2xl font-mono">1,337</div>
            </div>
            <div class="bg-gray-800 p-3 rounded border border-gray-700">
                <div class="text-xs text-gray-400">Premium Revenue</div>
                <div class="text-2xl font-mono text-green-400">$4,200</div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="bg-gray-800 p-4 rounded border border-gray-700">
                <h4 class="text-sm font-bold mb-2 text-blue-400">Generator</h4>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="admin-uid" placeholder="User ID" class="bg-gray-900 border border-gray-600 rounded px-2 py-1 flex-1 text-sm">
                    <select id="admin-plan" class="bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm">
                        <option value="1">1 мес</option>
                        <option value="12">1 год</option>
                        <option value="99">Lifetime</option>
                    </select>
                </div>
                <button onclick="app.admin.generateKey()" class="w-full bg-green-600 hover:bg-green-500 py-1.5 rounded text-sm font-bold">Generate Key</button>
                <div id="admin-key-out" class="mt-2 text-xs font-mono break-all text-yellow-300 bg-black/50 p-2 rounded hidden"></div>
            </div>

            <div class="bg-gray-800 p-4 rounded border border-gray-700">
                 <h4 class="text-sm font-bold mb-2 text-purple-400">Debug / Testing</h4>
                 <button onclick="app.admin.godMode()" class="w-full border border-purple-500 text-purple-400 hover:bg-purple-500/20 py-1.5 rounded text-sm mb-2">Toggle God Mode (Self Premium)</button>
                 <button onclick="app.admin.resetGod()" class="w-full border border-gray-600 text-gray-400 hover:bg-gray-700 py-1.5 rounded text-sm">Reset My Status</button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * TASK MASTER PRO v2.5
 * Optimized vanilla JS application
 */

const tg = window.Telegram?.WebApp;
const ADMIN_ID = 1288379477; // Замените на ваш ID

const app = {
    data: {
        tasks: [],
        projects: [
            {id: 'work', name: 'Работа', color: '#3b82f6'},
            {id: 'personal', name: 'Личное', color: '#10b981'},
            {id: 'study', name: 'Учеба', color: '#8b5cf6'}
        ],
        user: { premium: false, premiumUntil: null, theme: 'light' }
    },
    state: {
        currentView: 'list',
        searchQuery: '',
        editingId: null,
        tempSubtasks: []
    },

    init: async function() {
        // 1. Инициализация Telegram
        if(tg) {
            tg.ready();
            tg.expand();
            try { tg.enableClosingConfirmation(); } catch(e){}
        }

        // 2. Загрузка темы
        const savedTheme = localStorage.getItem('tm_theme') || 'light';
        this.setTheme(savedTheme);

        // 3. Загрузка данных (Hybrid: LocalStorage + CloudStorage)
        await this.loadData();

        // 4. Отрисовка
        this.renderAll();
        this.renderSidebarProfile();

        // 5. Листенеры
        this.setupListeners();
        
        // 6. Проверка премиума
        this.checkPremium();
    },

    // --- DATA MANAGEMENT ---
    
    loadData: async function() {
        // Сначала грузим из LocalStorage (быстро)
        const local = localStorage.getItem('tm_data_v2');
        if(local) {
            try {
                const parsed = JSON.parse(local);
                this.data = { ...this.data, ...parsed };
            } catch(e) { console.error('Corrupt local data', e); }
        }

        // Если в Telegram - пробуем подтянуть из облака (актуально при смене устройства)
        if(tg && tg.CloudStorage) {
            document.getElementById('sync-status').classList.remove('hidden');
            tg.CloudStorage.getItem('tm_backup', (err, val) => {
                document.getElementById('sync-status').classList.add('hidden');
                if(!err && val) {
                    const cloudData = JSON.parse(val);
                    // Простая стратегия слияния: если в облаке больше задач, берем их
                    // В реальном приложении нужно сравнивать timestamp
                    if(cloudData.tasks && cloudData.tasks.length > (this.data.tasks.length || 0)) {
                        this.data = cloudData;
                        this.saveData(false); // Сохранить в LocalStorage, но не отправлять обратно в облако
                        this.renderAll();
                    }
                }
            });
        }
    },

    saveData: function(syncCloud = true) {
        // Сохраняем локально
        localStorage.setItem('tm_data_v2', JSON.stringify(this.data));
        
        // Отправляем в облако TG (с дебаунсом, чтобы не спамить API)
        if(syncCloud && tg && tg.CloudStorage) {
            clearTimeout(this._cloudTimer);
            this._cloudTimer = setTimeout(() => {
                document.getElementById('sync-status').classList.remove('hidden');
                tg.CloudStorage.setItem('tm_backup', JSON.stringify(this.data), (err) => {
                    setTimeout(() => document.getElementById('sync-status').classList.add('hidden'), 500);
                });
            }, 2000);
        }
        
        this.updateStats();
    },

    // --- RENDERING ---

    renderAll: function() {
        if(this.state.currentView === 'list') this.renderList();
        else if(this.state.currentView === 'kanban') this.renderKanban();
        else if(this.state.currentView === 'calendar') this.renderCalendar();
        this.updateStats();
        this.renderProjectSelects();
    },

    renderList: function() {
        const container = document.getElementById('view-list');
        const tasks = this.getFilteredTasks();
        
        if(tasks.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 opacity-50">
                    <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                    <p>Задач не найдено</p>
                </div>`;
            return;
        }

        container.innerHTML = tasks.map(t => this.createTaskHTML(t)).join('');
    },

    createTaskHTML: function(t) {
        const project = this.data.projects.find(p => p.id === t.project) || {name: '', color: 'transparent'};
        const isDone = t.status === 'done';
        const overdue = t.date && new Date(t.date) < new Date().setHours(0,0,0,0) && !isDone;
        
        // Progress bar for subtasks
        let progressHtml = '';
        if(t.subtasks && t.subtasks.length > 0) {
            const doneCount = t.subtasks.filter(s => s.done).length;
            const pct = Math.round((doneCount / t.subtasks.length) * 100);
            progressHtml = `
                <div class="mt-2 flex items-center gap-2">
                    <div class="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-[var(--primary)]" style="width: ${pct}%"></div>
                    </div>
                    <span class="text-[10px] text-[var(--hint)]">${doneCount}/${t.subtasks.length}</span>
                </div>
            `;
        }

        return `
        <div class="card-3d p-4 relative group ${isDone ? 'opacity-60' : ''}" onclick="app.editTask('${t.id}')">
            <div class="flex items-start gap-3">
                <div class="pt-1" onclick="event.stopPropagation()">
                    <div onclick="app.toggleStatus('${t.id}')" 
                         class="w-6 h-6 rounded-full border-2 cursor-pointer flex items-center justify-center transition-colors ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-[var(--primary)]'}">
                        ${isDone ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-[var(--text)] truncate ${isDone ? 'line-through decoration-gray-400' : ''}">${this.escapeHtml(t.title)}</h4>
                        ${overdue ? '<span class="text-xs text-red-500 font-bold bg-red-100 px-2 py-0.5 rounded-md ml-2">Просрочено</span>' : ''}
                    </div>
                    <div class="flex flex-wrap gap-2 mt-1 text-xs text-[var(--hint)]">
                        ${t.date ? `<span class="flex items-center gap-1"><i class="far fa-calendar"></i> ${this.formatDate(t.date)}</span>` : ''}
                        ${t.repeat !== 'none' ? '<span class="text-blue-500"><i class="fas fa-sync-alt"></i></span>' : ''}
                        ${project.name ? `<span class="px-2 py-0.5 rounded-full" style="background:${project.color}20; color:${project.color}">${project.name}</span>` : ''}
                        ${t.priority === 'high' ? '<span class="text-orange-500 font-bold">! High</span>' : ''}
                    </div>
                    ${progressHtml}
                </div>
            </div>
        </div>
        `;
    },

    renderKanban: function() {
        if(!this.data.user.premium) {
            document.getElementById('view-kanban').innerHTML = this.getPremiumWall('Канбан доска доступна в Premium');
            return;
        }
        // Очистка и заполнение колонок
        ['backlog', 'in-progress', 'done'].forEach(status => {
            const col = document.querySelector(`.kanban-col[data-status="${status}"] .k-body`);
            const countEl = document.querySelector(`.kanban-col[data-status="${status}"] .count`);
            const tasks = this.getFilteredTasks().filter(t => t.status === status);
            countEl.textContent = tasks.length;
            col.innerHTML = tasks.map(t => `
                <div class="bg-[var(--surface)] p-3 rounded-lg shadow-sm border border-[var(--border)] cursor-pointer text-sm" onclick="app.editTask('${t.id}')">
                    <div class="font-medium mb-1">${this.escapeHtml(t.title)}</div>
                    <div class="flex justify-between items-center text-xs text-[var(--hint)]">
                        <span>${t.date ? this.formatDate(t.date) : ''}</span>
                        ${t.priority === 'high' ? '<i class="fas fa-exclamation-circle text-orange-500"></i>' : ''}
                    </div>
                </div>
            `).join('');
        });
    },

    renderCalendar: function() {
        // Простой плейсхолдер, так как полноценный календарь требует много JS
        const el = document.getElementById('view-calendar');
        if(!this.data.user.premium) {
            el.innerHTML = this.getPremiumWall('Календарь доступен в Premium');
        } else {
            // Упрощенная логика календаря (только список задач по датам)
            const tasksByDate = {};
            this.getFilteredTasks().forEach(t => {
                if(!t.date) return;
                if(!tasksByDate[t.date]) tasksByDate[t.date] = [];
                tasksByDate[t.date].push(t);
            });
            
            const dates = Object.keys(tasksByDate).sort();
            let html = '<div class="space-y-4">';
            dates.forEach(date => {
                html += `<div>
                    <h4 class="font-bold text-[var(--hint)] mb-2 sticky top-0 bg-[var(--bg)] py-1">${this.formatDate(date)}</h4>
                    <div class="space-y-2">
                        ${tasksByDate[date].map(t => this.createTaskHTML(t)).join('')}
                    </div>
                </div>`;
            });
            html += '</div>';
            el.innerHTML = dates.length ? html : '<div class="text-center py-10 opacity-50">Нет задач с датами</div>';
        }
    },

    getPremiumWall: function(msg) {
        return `
        <div class="flex flex-col items-center justify-center p-8 text-center h-64 border-2 border-dashed border-[var(--border)] rounded-2xl">
            <div class="w-16 h-16 bg-gradient-to-br from-yellow-300 to-orange-400 rounded-full flex items-center justify-center mb-4 shadow-lg text-white text-2xl">
                <i class="fas fa-crown"></i>
            </div>
            <h3 class="font-bold text-lg mb-2">${msg}</h3>
            <p class="text-sm text-[var(--hint)] mb-4">Организуйте свои задачи эффективнее с подпиской Pro.</p>
            <button onclick="app.openSettings()" class="btn-primary px-6 py-2 rounded-lg font-bold">Подробнее</button>
        </div>`;
    },

    renderSidebarProfile: function() {
        const user = tg?.initDataUnsafe?.user;
        const nameEl = document.getElementById('user-name');
        const avatarEl = document.getElementById('user-avatar');
        const statusEl = document.getElementById('user-status');
        const projectsEl = document.getElementById('sidebar-projects');

        if(user) {
            nameEl.textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            if(user.photo_url) {
                avatarEl.innerHTML = '';
                avatarEl.style.backgroundImage = `url(${user.photo_url})`;
                avatarEl.style.backgroundSize = 'cover';
            }
        }
        
        if(this.data.user.premium) {
            statusEl.innerHTML = '<span class="premium-text">Premium User</span>';
            document.getElementById('premium-badge-header').classList.remove('hidden');
            document.getElementById('btn-premium-sidebar').classList.add('hidden');
        } else {
            statusEl.textContent = 'Базовый план';
            document.getElementById('premium-badge-header').classList.add('hidden');
            document.getElementById('btn-premium-sidebar').classList.remove('hidden');
        }

        // Проекты в меню
        projectsEl.innerHTML = this.data.projects.map(p => `
            <div class="flex items-center gap-3 px-4 py-2 hover:bg-[var(--bg)] rounded-lg cursor-pointer text-sm" onclick="app.filterByProject('${p.id}')">
                <span class="w-2.5 h-2.5 rounded-full" style="background:${p.color}"></span>
                ${p.name}
            </div>
        `).join('');

        // Кнопка админки
        if(String(user?.id) === String(ADMIN_ID) || this.data.user.premium) { 
             document.getElementById('admin-link-container').classList.remove('hidden'); 
        }
    },

    // --- ACTIONS ---

    toggleStatus: function(id) {
        const t = this.data.tasks.find(x => x.id === id);
        if(t) {
            t.status = t.status === 'done' ? 'backlog' : 'done';
            // Если повторяющаяся задача выполнена - создаем новую на след. период
            if(t.status === 'done' && t.repeat !== 'none' && t.date) {
                this.createNextRepeatingTask(t);
            }
            this.saveData();
            this.renderAll();
        }
    },

    createNextRepeatingTask: function(t) {
        const nextDate = new Date(t.date);
        if(t.repeat === 'daily') nextDate.setDate(nextDate.getDate() + 1);
        if(t.repeat === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
        
        const newTask = {
            ...t,
            id: Date.now().toString(36),
            date: nextDate.toISOString().split('T')[0],
            status: 'backlog',
            subtasks: t.subtasks.map(s => ({...s, done: false}))
        };
        // Добавляем без сохранения (сохранение будет в общем потоке)
        this.data.tasks.push(newTask);
    },

    openTaskModal: function(task = null) {
        this.state.editingId = task ? task.id : null;
        this.state.tempSubtasks = task ? JSON.parse(JSON.stringify(task.subtasks || [])) : [];
        
        const titleEl = document.getElementById('task-title');
        const descEl = document.getElementById('task-desc');
        const dateEl = document.getElementById('task-date');
        const prioEl = document.getElementById('task-priority');
        const projEl = document.getElementById('task-project');
        const repEl = document.getElementById('task-repeat');
        const modalTitle = document.getElementById('modal-title');
        const delBtn = document.getElementById('btn-delete-task');

        if(task) {
            modalTitle.textContent = 'Редактировать';
            titleEl.value = task.title;
            descEl.value = task.desc || '';
            dateEl.value = task.date || '';
            prioEl.value = task.priority || 'medium';
            projEl.value = task.project || '';
            repEl.value = task.repeat || 'none';
            delBtn.classList.remove('hidden');
        } else {
            modalTitle.textContent = 'Новая задача';
            titleEl.value = '';
            descEl.value = '';
            dateEl.value = new Date().toISOString().split('T')[0];
            prioEl.value = 'medium';
            projEl.value = '';
            repEl.value = 'none';
            delBtn.classList.add('hidden');
        }

        this.renderSubtasksInModal();
        document.getElementById('task-modal').classList.remove('hidden');
    },

    closeTaskModal: function() {
        document.getElementById('task-modal').classList.add('hidden');
    },

    saveTask: function() {
        const title = document.getElementById('task-title').value.trim();
        if(!title) return alert('Введите название!');

        const taskData = {
            title,
            desc: document.getElementById('task-desc').value,
            date: document.getElementById('task-date').value,
            priority: document.getElementById('task-priority').value,
            project: document.getElementById('task-project').value,
            repeat: document.getElementById('task-repeat').value,
            subtasks: this.state.tempSubtasks
        };

        if(this.state.editingId) {
            const idx = this.data.tasks.findIndex(t => t.id === this.state.editingId);
            if(idx !== -1) {
                this.data.tasks[idx] = { ...this.data.tasks[idx], ...taskData };
            }
        } else {
            this.data.tasks.push({
                id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                status: 'backlog',
                createdAt: new Date().toISOString(),
                ...taskData
            });
        }

        this.saveData();
        this.closeTaskModal();
        this.renderAll();
    },

    editTask: function(id) {
        const t = this.data.tasks.find(x => x.id === id);
        if(t) this.openTaskModal(t);
    },

    deleteTask: function() {
        if(confirm('Удалить эту задачу?')) {
            this.data.tasks = this.data.tasks.filter(t => t.id !== this.state.editingId);
            this.saveData();
            this.closeTaskModal();
            this.renderAll();
        }
    },

    // --- SUBTASKS ---
    addSubtask: function() {
        const inp = document.getElementById('new-subtask');
        const val = inp.value.trim();
        if(val) {
            this.state.tempSubtasks.push({ title: val, done: false });
            inp.value = '';
            this.renderSubtasksInModal();
        }
    },

    toggleTempSubtask: function(idx) {
        this.state.tempSubtasks[idx].done = !this.state.tempSubtasks[idx].done;
        this.renderSubtasksInModal();
    },

    removeTempSubtask: function(idx) {
        this.state.tempSubtasks.splice(idx, 1);
        this.renderSubtasksInModal();
    },

    renderSubtasksInModal: function() {
        const list = document.getElementById('subtask-list');
        list.innerHTML = this.state.tempSubtasks.map((s, i) => `
            <div class="flex items-center gap-2 text-sm group">
                <input type="checkbox" ${s.done ? 'checked' : ''} onchange="app.toggleTempSubtask(${i})" class="rounded text-[var(--primary)] focus:ring-[var(--primary)]">
                <span class="flex-1 ${s.done ? 'line-through text-[var(--hint)]' : ''}">${this.escapeHtml(s.title)}</span>
                <button onclick="app.removeTempSubtask(${i})" class="text-[var(--hint)] hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    },

    // --- UI HELPERS ---

    switchView: function(view) {
        if(view !== 'list' && !this.data.user.premium) {
             // Allow viewing placeholder, but actual logic inside render handles content
        }
        this.state.currentView = view;
        
        document.querySelectorAll('#view-container > div').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        
        document.querySelectorAll('.active-view').forEach(b => {
            b.classList.remove('bg-white', 'shadow-sm', 'text-[var(--primary)]', 'active-view');
            b.classList.add('text-[var(--hint)]', 'hover:bg-[var(--bg)]');
        });
        const btn = document.querySelector(`button[data-view="${view}"]`);
        if(btn) {
            btn.classList.add('bg-white', 'shadow-sm', 'text-[var(--primary)]', 'active-view');
            btn.classList.remove('text-[var(--hint)]', 'hover:bg-[var(--bg)]');
        }

        document.getElementById('view-title').textContent = 
            view === 'list' ? 'Мои задачи' : view === 'kanban' ? 'Доска' : 'Календарь';

        this.renderAll();
    },

    setTheme: function(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        this.data.user.theme = theme;
        localStorage.setItem('tm_theme', theme);
    },
    
    openSettings: function() {
        document.getElementById('settings-modal').classList.remove('hidden');
    },

    toggleSearch: function() {
        const bar = document.getElementById('search-bar');
        bar.classList.toggle('hidden');
        if(!bar.classList.contains('hidden')) document.getElementById('search-input').focus();
        else {
            this.state.searchQuery = '';
            document.getElementById('search-input').value = '';
            this.renderAll();
        }
    },

    getFilteredTasks: function() {
        let tasks = this.data.tasks;
        if(this.state.searchQuery) {
            const q = this.state.searchQuery.toLowerCase();
            tasks = tasks.filter(t => t.title.toLowerCase().includes(q));
        }
        // Сортировка: Сначала невыполненные, затем по дате
        return tasks.sort((a,b) => {
            if(a.status === b.status) return (a.date || '9999') > (b.date || '9999') ? 1 : -1;
            return a.status === 'done' ? 1 : -1;
        });
    },

    updateStats: function() {
        const total = this.data.tasks.length;
        const done = this.data.tasks.filter(t => t.status === 'done').length;
        const inProgress = total - done;
        
        const todayStr = new Date().toISOString().split('T')[0];
        const doneToday = this.data.tasks.filter(t => t.status === 'done' && (t.createdAt || '').startsWith(todayStr)).length; // Simplified for demo

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-done').textContent = done;
        document.getElementById('stat-progress').textContent = inProgress;
        document.getElementById('stat-today').textContent = doneToday; // Logic simplified
    },
    
    renderProjectSelects: function() {
        const opts = `<option value="">Без проекта</option>` + 
                     this.data.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        const taskSelect = document.getElementById('task-project');
        // Сохраняем выбранное значение если возможно
        const current = taskSelect.value;
        taskSelect.innerHTML = opts;
        if(current) taskSelect.value = current;
    },

    addProjectPrompt: function() {
        const name = prompt('Название нового проекта:');
        if(name) {
            const id = 'proj_' + Date.now();
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            const color = colors[this.data.projects.length % colors.length];
            this.data.projects.push({ id, name, color });
            this.saveData();
            this.renderAll();
            this.renderSidebarProfile();
        }
    },

    escapeHtml: function(text) {
        if(!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    },
    
    formatDate: function(iso) {
        if(!iso) return '';
        const d = new Date(iso);
        return d.toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'});
    },

    setupListeners: function() {
        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-backdrop').classList.remove('hidden');
        });
        document.getElementById('sidebar-backdrop').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-backdrop').classList.add('hidden');
        });
        document.getElementById('search-toggle').addEventListener('click', () => this.toggleSearch());
        
        // Debounce search
        let timeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                this.state.searchQuery = e.target.value.trim();
                this.renderAll();
            }, 300);
        });
    },

    // --- ADMIN & PREMIUM ---
    openAdmin: function() {
        document.getElementById('admin-modal').classList.remove('hidden');
    },
    closeAdmin: function() {
        document.getElementById('admin-modal').classList.add('hidden');
    },
    
    checkPremium: function() {
        // Простая проверка (в реальном приложении - запрос на сервер)
        if(String(tg?.initDataUnsafe?.user?.id) === String(ADMIN_ID)) {
             // Админ не получает премиум автоматически, чтобы тестировать GodMode, 
             // но имеет доступ к кнопке
        }
    },

    admin: {
        godMode: function() {
            app.data.user.premium = true;
            app.saveData();
            location.reload();
        },
        resetGod: function() {
            app.data.user.premium = false;
            app.saveData();
            location.reload();
        },
        generateKey: function() {
            const uid = document.getElementById('admin-uid').value;
            const plan = document.getElementById('admin-plan').value;
            if(!uid) return alert('Enter UID');
            
            // Простая генерация сигнатуры
            const raw = `${uid}_${plan}_${Date.now()}_SECRET`;
            const key = btoa(raw).replace(/=/g,'');
            const out = document.getElementById('admin-key-out');
            out.textContent = key;
            out.classList.remove('hidden');
        }
    },
    
    // --- BACKUP ---
    backup: {
        exportData: function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.data));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "taskmaster_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(dlAnchorElem);
            dlAnchorElem.click();
            dlAnchorElem.remove();
        },
        importData: function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm('Это перезапишет текущие задачи. Продолжить?')) {
                        app.data = json;
                        app.saveData();
                        location.reload();
                    }
                } catch(err) {
                    alert('Ошибка чтения файла');
                }
            };
            reader.readAsText(file);
        }
    }
};

// Start
document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
