<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Планировщик задач</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #707579;
      --tg-theme-link-color: #3390ec;
      --tg-theme-button-color: #3390ec;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }
    .dark {
      --tg-theme-bg-color: #1c1c1d;
      --tg-theme-text-color: #ffffff;
      --tg-theme-hint-color: #aaaaaa;
      --tg-theme-link-color: #5d9ce6;
      --tg-theme-button-color: #5d9ce6;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #2c2c2e;
    }
    body { background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); transition: background .3s, color .3s; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
    .task-card { transition: transform .2s, box-shadow .2s; }
    .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }

    .priority-low { background: rgba(52,211,153,.12); color: rgb(16,185,129); }
    .priority-medium { background: rgba(96,165,250,.12); color: rgb(59,130,246); }
    .priority-high { background: rgba(251,191,36,.14); color: rgb(234,179,8); }
    .priority-critical { background: rgba(239,68,68,.14); color: rgb(239,68,68); }

    .status-backlog { background: rgba(156,163,175,.14); color: rgb(156,163,175); }
    .status-in-progress { background: rgba(59,130,246,.14); color: rgb(59,130,246); }
    .status-review { background: rgba(168,85,247,.14); color: rgb(168,85,247); }
    .status-done { background: rgba(16,185,129,.14); color: rgb(16,185,129); }

    .kanban-column { min-height: 60vh; }
    .calendar-day { min-height: 100px; }
    .calendar-day.today { background: rgba(59,130,246,.10); }
    .calendar-day:hover { background: rgba(59,130,246,.06); }

    .subtask-checkbox:checked + .subtask-label { text-decoration: line-through; color: var(--tg-theme-hint-color); }

    .command-palette { backdrop-filter: blur(12px); }

    @media (max-width: 640px) {
      .kanban-column { min-height: auto; max-height: 60vh; overflow-y: auto; }
    }
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-[var(--tg-theme-bg-color)] border-b border-[var(--tg-theme-secondary-bg-color)]">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="menu-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Меню">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl font-semibold">Планировщик задач</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="search-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Поиск (⌘/Ctrl+K)">
          <i class="fas fa-search"></i>
        </button>
        <button id="add-task-button" class="p-2 rounded-full bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]" aria-label="Новая задача (N)">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 container mx-auto px-4 py-4">
    <!-- View Selector -->
    <div class="flex justify-center mb-6">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button data-view="list" class="view-selector px-4 py-2 text-sm font-medium rounded-l-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-list mr-2"></i> Список
        </button>
        <button data-view="kanban" class="view-selector px-4 py-2 text-sm font-medium border-t border-b border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-columns mr-2"></i> Доска
        </button>
        <button data-view="calendar" class="view-selector px-4 py-2 text-sm font-medium rounded-r-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-calendar-alt mr-2"></i> Календарь
        </button>
      </div>
    </div>

    <!-- Project Selector -->
    <div class="mb-4 flex items-center">
      <select id="project-selector" class="bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]">
        <option value="all">Все проекты</option>
      </select>
      <button id="add-project-button" class="ml-2 p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Добавить проект">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <!-- List View -->
    <section id="list-view" class="view-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Задачи</h2>
        <div class="flex gap-2">
          <button id="filter-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
            <i class="fas fa-filter mr-1"></i> Фильтр
          </button>
          <button id="sort-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
            <i class="fas fa-sort mr-1"></i> Сортировка
          </button>
        </div>
      </div>
      <div id="list-container" class="space-y-3"></div>
    </section>

    <!-- Kanban View -->
    <section id="kanban-view" class="view-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3" data-status="backlog">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Бэклог</h3>
            <span class="text-xs bg-gray-200 text-gray-800 rounded-full px-2 py-1" id="count-backlog">0</span>
          </div>
          <div class="space-y-3" id="col-backlog"></div>
        </div>
        <div class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3" data-status="in-progress">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">В работе</h3>
            <span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-1" id="count-in-progress">0</span>
          </div>
          <div class="space-y-3" id="col-in-progress"></div>
        </div>
        <div class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3" data-status="review">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Ревью</h3>
            <span class="text-xs bg-purple-200 text-purple-800 rounded-full px-2 py-1" id="count-review">0</span>
          </div>
          <div class="space-y-3" id="col-review"></div>
        </div>
        <div class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3" data-status="done">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Готово</h3>
            <span class="text-xs bg-green-200 text-green-800 rounded-full px-2 py-1" id="count-done">0</span>
          </div>
          <div class="space-y-3" id="col-done"></div>
        </div>
      </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="view-content hidden">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Предыдущий месяц"><i class="fas fa-chevron-left"></i></button>
          <h2 id="calendar-title" class="text-lg font-semibold">—</h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Следующий месяц"><i class="fas fa-chevron-right"></i></button>
        </div>
        <button id="today-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Сегодня</button>
      </div>
      <div id="calendar-weekdays" class="grid grid-cols-7 gap-1 mb-1"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
    </section>
  </main>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="md:hidden sticky bottom-0 bg-[var(--tg-theme-bg-color)] border-t border-[var(--tg-theme-secondary-bg-color)]">
    <div class="flex justify-around py-2">
      <button data-view="list" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Список"><i class="fas fa-list text-lg"></i></button>
      <button data-view="kanban" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Доска"><i class="fas fa-columns text-lg"></i></button>
      <button data-view="calendar" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Календарь"><i class="fas fa-calendar-alt text-lg"></i></button>
      <button id="mobile-add-task-button" class="p-2 rounded-full bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]" aria-label="Новая задача"><i class="fas fa-plus text-lg"></i></button>
    </div>
  </nav>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-xl font-semibold">Новая задача</h2>
        <button id="close-task-modal" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Закрыть"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <input type="text" id="task-title" placeholder="Название задачи" class="w-full px-4 py-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]" />
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Приоритет</label>
            <select id="task-priority" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]">
              <option value="low">Низкий</option>
              <option value="medium" selected>Средний</option>
              <option value="high">Высокий</option>
              <option value="critical">Критичный</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Статус</label>
            <select id="task-status" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]">
              <option value="backlog">Бэклог</option>
              <option value="in-progress">В работе</option>
              <option value="review">Ревью</option>
              <option value="done">Готово</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Проект</label>
            <select id="task-project" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]"></select>
          </div>
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Срок</label>
            <input type="date" id="task-due-date" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]" />
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Описание</label>
          <textarea id="task-description" rows="3" placeholder="Добавьте подробности…" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Подзадачи (пример)</label>
          <div class="space-y-2">
            <label class="flex items-center"><input type="checkbox" class="subtask-checkbox rounded border-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-button-color)] focus:ring-[var(--tg-theme-button-color)]"><span class="subtask-label ml-2">Собрать требования</span></label>
            <label class="flex items-center"><input type="checkbox" class="subtask-checkbox rounded border-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-button-color)] focus:ring-[var(--tg-theme-button-color)]"><span class="subtask-label ml-2">Сделать черновик</span></label>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Напоминание</label>
          <select id="task-reminder" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]">
            <option value="">Без напоминания</option>
            <option value="5min">За 5 минут</option>
            <option value="15min">За 15 минут</option>
            <option value="30min">За 30 минут</option>
            <option value="1hour">За 1 час</option>
            <option value="1day">За 1 день</option>
          </select>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-task" class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Отмена</button>
          <button id="save-task" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[70vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-xl font-semibold">Новый проект</h2>
        <button id="close-project-modal" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Закрыть"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-4">
        <div class="mb-4"><input type="text" id="project-name" placeholder="Название проекта" class="w-full px-4 py-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]"/></div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Описание</label>
          <textarea id="project-description" rows="3" placeholder="Добавьте описание проекта…" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]"></textarea>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-project" class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Отмена</button>
          <button id="save-project" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative w-full max-w-md mx-4">
      <div class="command-palette bg-[var(--tg-theme-bg-color)] rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-[var(--tg-theme-secondary-bg-color)]">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-[var(--tg-theme-hint-color)]"></i></div>
            <input type="text" id="command-input" placeholder="Введите команду или ищите…" class="w-full pl-10 pr-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]"/>
          </div>
        </div>
        <div class="max-h-96 overflow-y-auto" id="command-options">
          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Задачи</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-blue-100 text-blue-800 mr-3"><i class="fas fa-plus"></i></div><div><div class="font-medium">Создать задачу</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Добавить новую задачу</div></div></div></div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-purple-100 text-purple-800 mr-3"><i class="fas fa-search"></i></div><div><div class="font-medium">Поиск задач</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Найти по названию или описанию</div></div></div></div>
          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Проекты</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-green-100 text-green-800 mr-3"><i class="fas fa-folder-plus"></i></div><div><div class="font-medium">Создать проект</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Организовать задачи по проектам</div></div></div></div>
          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Виды</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-yellow-100 text-yellow-800 mr-3"><i class="fas fa-list"></i></div><div><div class="font-medium">Переключить на «Список»</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Просмотр задач списком</div></div></div></div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-indigo-100 text-indigo-800 mr-3"><i class="fas fa-columns"></i></div><div><div class="font-medium">Переключить на «Доска»</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Kanban‑управление</div></div></div></div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer"><div class="flex items-center"><div class="p-2 rounded-full bg-red-100 text-red-800 mr-3"><i class="fas fa-calendar-alt"></i></div><div><div class="font-medium">Переключить на «Календарь»</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Просмотр задач по датам</div></div></div></div>
        </div>
        <div class="p-2 text-xs text-center text-[var(--tg-theme-hint-color)] border-t border-[var(--tg-theme-secondary-bg-color)]">Нажмите Esc, чтобы закрыть</div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <section id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
    <div class="w-24 h-24 bg-[var(--tg-theme-secondary-bg-color)] rounded-full flex items-center justify-center mb-4"><i class="fas fa-tasks text-3xl text-[var(--tg-theme-hint-color)]"></i></div>
    <h3 class="text-lg font-medium mb-2">Пока нет задач</h3>
    <p class="text-sm text-[var(--tg-theme-hint-color)] mb-4 text-center max-w-md px-4">Начните с создания первой задачи. Нажмите «+» или клавишу «N».</p>
    <button id="empty-state-add-task" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Добавить задачу</button>
  </section>
</div>

<script>
(function(){
  // --- Telegram theme / init (safe in browser) ---
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) {
    try { tg.expand(); } catch(e){}
    if (tg.colorScheme === 'dark') document.documentElement.classList.add('dark');
    const p = tg.themeParams || {};
    // Optional: map Telegram theme params to CSS vars if present
    const setVar = (k, v) => { if (v) document.documentElement.style.setProperty(k, v); };
    setVar('--tg-theme-bg-color', p.bg_color);
    setVar('--tg-theme-text-color', p.text_color);
    setVar('--tg-theme-hint-color', p.hint_color);
    setVar('--tg-theme-link-color', p.link_color);
    setVar('--tg-theme-button-color', p.button_color);
    setVar('--tg-theme-button-text-color', p.button_text_color);
    setVar('--tg-theme-secondary-bg-color', p.secondary_bg_color);
  }

  // --- State ---
  const state = {
    projects: ['Работа','Личное','Команда'],
    tasks: [
      { id: id(), title:'Сделать проектное предложение', priority:'high', status:'in-progress', project:'Работа', dueDate: isoPlusDays(1), description:'Финализировать разделы и отправить', tags:['Работа'] },
      { id: id(), title:'Командная встреча', priority:'medium', status:'backlog', project:'Команда', dueDate: isoToday(), description:'Синхронизация задач', tags:['Команда'] },
      { id: id(), title:'Купить продукты', priority:'low', status:'backlog', project:'Личное', dueDate:'', description:'Молоко, яйца, овощи', tags:['Личное'] },
      { id: id(), title:'Проверить PR #42', priority:'critical', status:'review', project:'Команда', dueDate: isoPlusDays(2), description:'Просмотреть изменения', tags:['Команда'] },
      { id: id(), title:'Настроить CI/CD', priority:'high', status:'done', project:'Команда', dueDate:'', description:'Готово', tags:['Команда'] }
    ],
    filterProject: 'all',
    currentView: 'list',
    calDate: new Date()
  };

  // --- Helpers ---
  function id(){ return 't_' + Math.random().toString(36).slice(2,10); }
  function isoToday(){ const d = new Date(); return d.toISOString().slice(0,10); }
  function isoPlusDays(n){ const d = new Date(); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
  const ruMonths = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const ruWeekdays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
  const priorityChip = { low:'priority-low', medium:'priority-medium', high:'priority-high', critical:'priority-critical' };
  const statusChip = { 'backlog':'status-backlog', 'in-progress':'status-in-progress', 'review':'status-review', 'done':'status-done' };
  const statusLabel = { 'backlog':'Бэклог', 'in-progress':'В работе', 'review':'Ревью', 'done':'Готово' };

  // --- DOM ---
  const viewContents = document.querySelectorAll('.view-content');
  const viewSelectors = document.querySelectorAll('.view-selector');
  const listContainer = document.getElementById('list-container');
  const projectSelector = document.getElementById('project-selector');
  const addProjectButton = document.getElementById('add-project-button');
  const addTaskButtons = document.querySelectorAll('#add-task-button, #mobile-add-task-button, #empty-state-add-task');

  // Kanban columns
  const colBacklog = document.getElementById('col-backlog');
  const colInProgress = document.getElementById('col-in-progress');
  const colReview = document.getElementById('col-review');
  const colDone = document.getElementById('col-done');

  // Calendar
  const calTitle = document.getElementById('calendar-title');
  const calGrid = document.getElementById('calendar-grid');
  const calWeekdays = document.getElementById('calendar-weekdays');
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  const todayBtn = document.getElementById('today-button');

  // Modals
  const taskModal = document.getElementById('task-modal');
  const closeTaskModalBtn = document.getElementById('close-task-modal');
  const cancelTaskBtn = document.getElementById('cancel-task');
  const saveTaskBtn = document.getElementById('save-task');
  const taskTitle = document.getElementById('task-title');
  const taskPriority = document.getElementById('task-priority');
  const taskStatus = document.getElementById('task-status');
  const taskProject = document.getElementById('task-project');
  const taskDue = document.getElementById('task-due-date');
  const taskDesc = document.getElementById('task-description');
  const taskReminder = document.getElementById('task-reminder');

  const projectModal = document.getElementById('project-modal');
  const closeProjectModalBtn = document.getElementById('close-project-modal');
  const cancelProjectBtn = document.getElementById('cancel-project');
  const saveProjectBtn = document.getElementById('save-project');
  const projectName = document.getElementById('project-name');

  // Command palette
  const commandPalette = document.getElementById('command-palette');
  const commandInput = document.getElementById('command-input');

  // Empty state
  const emptyState = document.getElementById('empty-state');

  // --- Init projects in selectors ---
  function refreshProjectSelectors(){
    // top filter
    projectSelector.innerHTML = '<option value="all">Все проекты</option>' + state.projects.map(p=>`<option value="${p}">${p}</option>`).join('');
    // in task modal
    taskProject.innerHTML = state.projects.map(p=>`<option value="${p}">${p}</option>`).join('');
  }

  // --- Rendering ---
  function getFilteredTasks(){
    return state.tasks.filter(t => state.filterProject==='all' || t.project===state.filterProject);
  }

  function renderList(){
    const tasks = getFilteredTasks();
    listContainer.innerHTML = tasks.map(t => {
      const due = t.dueDate ? new Date(t.dueDate) : null;
      const dueText = t.dueDate ? `Срок: ${due.toLocaleDateString('ru-RU')}` : 'Без срока';
      const checked = t.status==='done' ? 'checked' : '';
      const line = t.status==='done' ? 'line-through opacity-70' : '';
      return `
      <div class="task-card bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-4">
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <div class="mt-1"><input data-id="${t.id}" type="checkbox" ${checked} class="list-check rounded border-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-button-color)] focus:ring-[var(--tg-theme-button-color)]"></div>
            <div>
              <h3 class="font-medium ${line}">${escapeHtml(t.title)}</h3>
              <p class="text-sm text-[var(--tg-theme-hint-color)] mt-1">${dueText}</p>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="${priorityChip[t.priority]} text-xs px-2 py-1 rounded-full">${priorityRu(t.priority)}</span>
                <span class="${statusChip[t.status]} text-xs px-2 py-1 rounded-full">${statusLabel[t.status]}</span>
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${escapeHtml(t.project)}</span>
              </div>
            </div>
          </div>
          <button class="text-[var(--tg-theme-hint-color)] hover:text-[var(--tg-theme-text-color)]"><i class="fas fa-ellipsis-v"></i></button>
        </div>
      </div>`;
    }).join('');

    // bind checkboxes
    listContainer.querySelectorAll('.list-check').forEach(cb => {
      cb.addEventListener('change', (e)=>{
        const t = state.tasks.find(x=>x.id===e.target.dataset.id);
        if (!t) return;
        t.status = e.target.checked ? 'done' : 'backlog';
        renderAll();
      });
    });

    emptyState.classList.toggle('hidden', getFilteredTasks().length>0);
  }

  function renderKanban(){
    const byStatus = { 'backlog':[], 'in-progress':[], 'review':[], 'done':[] };
    getFilteredTasks().forEach(t=> byStatus[t.status]?.push(t));

    const makeCard = (t) => {
      const el = document.createElement('div');
      el.className = 'task-card bg-[var(--tg-theme-bg-color)] rounded-lg p-3 cursor-move';
      el.setAttribute('draggable','true');
      el.dataset.id = t.id;
      el.innerHTML = `
        <h4 class="font-medium">${escapeHtml(t.title)}</h4>
        <div class="flex flex-wrap gap-2 mt-2">
          <span class="${priorityChip[t.priority]} text-xs px-2 py-1 rounded-full">${priorityRu(t.priority)}</span>
          <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${escapeHtml(t.project)}</span>
        </div>`;
      // dnd
      el.addEventListener('dragstart', ()=> el.classList.add('opacity-50'));
      el.addEventListener('dragend', ()=> el.classList.remove('opacity-50'));
      return el;
    };

    colBacklog.innerHTML = '';
    colInProgress.innerHTML = '';
    colReview.innerHTML = '';
    colDone.innerHTML = '';

    byStatus['backlog'].forEach(t=> colBacklog.appendChild(makeCard(t)));
    byStatus['in-progress'].forEach(t=> colInProgress.appendChild(makeCard(t)));
    byStatus['review'].forEach(t=> colReview.appendChild(makeCard(t)));
    byStatus['done'].forEach(t=> colDone.appendChild(makeCard(t)));

    // counts
    document.getElementById('count-backlog').textContent = byStatus['backlog'].length;
    document.getElementById('count-in-progress').textContent = byStatus['in-progress'].length;
    document.getElementById('count-review').textContent = byStatus['review'].length;
    document.getElementById('count-done').textContent = byStatus['done'].length;

    // column dnd
    document.querySelectorAll('.kanban-column').forEach(col => {
      col.addEventListener('dragover', (e)=>{ e.preventDefault(); col.classList.add('bg-opacity-50'); });
      col.addEventListener('dragleave', ()=> col.classList.remove('bg-opacity-50'));
      col.addEventListener('drop', (e)=>{
        e.preventDefault(); col.classList.remove('bg-opacity-50');
        const dragged = document.querySelector('.task-card.opacity-50');
        if (!dragged) return;
        const id = dragged.dataset.id;
        const t = state.tasks.find(x=>x.id===id);
        if (!t) return;
        t.status = col.dataset.status;
        renderAll();
      });
    });
  }

  function renderCalendar(){
    // Weekdays header (Mon..Sun)
    calWeekdays.innerHTML = ruWeekdays.map(d=>`<div class="text-center text-sm font-medium py-2">${d}</div>`).join('');

    const y = state.calDate.getFullYear();
    const m = state.calDate.getMonth();
    calTitle.textContent = `${ruMonths[m]} ${y}`;

    // Build grid: Monday as first day of week
    const firstOfMonth = new Date(y, m, 1);
    const startDay = (firstOfMonth.getDay()+6)%7; // 0..6 (Mon=0)
    const daysInMonth = new Date(y, m+1, 0).getDate();

    // previous month trailing days
    const days = [];
    for (let i=0;i<startDay;i++) days.push({ type:'prev', date:new Date(y,m, -startDay + i + 1) });
    for (let d=1; d<=daysInMonth; d++) days.push({ type:'curr', date:new Date(y,m,d) });
    while (days.length % 7 !== 0) days.push({ type:'next', date:new Date(y,m, daysInMonth + (days.length - (startDay+daysInMonth)) + 1) });

    // map tasks by date yyyy-mm-dd
    const byDate = {};
    getFilteredTasks().forEach(t=>{
      if (!t.dueDate) return;
      (byDate[t.dueDate] ||= []).push(t);
    });

    calGrid.innerHTML = days.map((cell)=>{
      const d = cell.date;
      const key = d.toISOString().slice(0,10);
      const isToday = key === isoToday();
      const tasks = (byDate[key]||[]).slice(0,3);
      const more = (byDate[key]||[]).length - tasks.length;
      return `
      <div class="calendar-day border border-[var(--tg-theme-secondary-bg-color)] rounded p-1 ${isToday?'today':''}" data-date="${key}">
        <div class="text-right text-sm mb-1 ${cell.type!=='curr'?'opacity-50':''}">${d.getDate()}</div>
        ${tasks.map(t=>`<div class="text-xs truncate px-1 py-0.5 ${statusChip[t.status]} rounded mb-1">${escapeHtml(t.title)}</div>`).join('')}
        ${more>0?`<div class="text-[10px] text-[var(--tg-theme-hint-color)] px-1">ещё ${more}…</div>`:''}
      </div>`;
    }).join('');

    // click to create on date
    calGrid.querySelectorAll('.calendar-day').forEach(cell=>{
      cell.addEventListener('click', ()=>{ openTaskModal(cell.dataset.date); });
    });
  }

  function renderAll(){
    renderList();
    renderKanban();
    renderCalendar();
  }

  // --- View switching ---
  function showView(view){
    document.querySelectorAll('.view-content').forEach(c=> c.classList.add('hidden'));
    const target = document.getElementById(`${view}-view`);
    if (target) target.classList.remove('hidden');
    viewSelectors.forEach(btn=>{
      btn.classList.remove('bg-[var(--tg-theme-button-color)]','text-[var(--tg-theme-button-text-color)]');
      if (btn.dataset.view === view) btn.classList.add('bg-[var(--tg-theme-button-color)]','text-[var(--tg-theme-button-text-color)]');
    });
    state.currentView = view;
  }

  viewSelectors.forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.view)));

  // --- Modals ---
  function openTaskModal(prefillDate){
    if (prefillDate) taskDue.value = prefillDate;
    taskTitle.value = '';
    taskPriority.value = 'medium';
    taskStatus.value = 'backlog';
    taskProject.value = state.projects[0] || '';
    taskDesc.value = '';
    taskReminder.value = '';
    taskModal.classList.remove('hidden');
  }
  function closeTaskModal(){ taskModal.classList.add('hidden'); }
  function openProjectModal(){ projectName.value=''; projectModal.classList.remove('hidden'); }
  function closeProjectModal(){ projectModal.classList.add('hidden'); }

  addTaskButtons.forEach(b=> b.addEventListener('click', ()=> openTaskModal()));
  document.getElementById('close-task-modal').addEventListener('click', closeTaskModal);
  document.getElementById('cancel-task').addEventListener('click', closeTaskModal);
  addProjectButton.addEventListener('click', openProjectModal);
  closeProjectModalBtn.addEventListener('click', closeProjectModal);
  cancelProjectBtn.addEventListener('click', closeProjectModal);

  // --- Save actions ---
  saveTaskBtn.addEventListener('click', ()=>{
    const t = {
      id: id(),
      title: taskTitle.value.trim() || 'Без названия',
      priority: taskPriority.value,
      status: taskStatus.value,
      project: taskProject.value,
      dueDate: taskDue.value,
      description: taskDesc.value.trim(),
      tags: [taskProject.value]
    };
    state.tasks.unshift(t);
    closeTaskModal();
    renderAll();
  });

  saveProjectBtn.addEventListener('click', ()=>{
    const name = projectName.value.trim(); if (!name) return closeProjectModal();
    if (!state.projects.includes(name)) state.projects.push(name);
    refreshProjectSelectors();
    closeProjectModal();
  });

  // --- Project filter ---
  projectSelector.addEventListener('change', ()=>{ state.filterProject = projectSelector.value; renderAll(); });

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e)=>{
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==='k') { e.preventDefault(); openCommandPalette(); }
    if (!e.metaKey && !e.ctrlKey && !e.altKey && e.key.toLowerCase()==='n') { e.preventDefault(); openTaskModal(); }
    if (e.key==='Escape') {
      if (!commandPalette.classList.contains('hidden')) closeCommandPalette();
      else if (!taskModal.classList.contains('hidden')) closeTaskModal();
      else if (!projectModal.classList.contains('hidden')) closeProjectModal();
    }
  });

  // --- Command palette ---
  document.getElementById('search-button').addEventListener('click', openCommandPalette);
  function openCommandPalette(){ commandPalette.classList.remove('hidden'); commandPalette.classList.add('flex'); commandInput.focus(); }
  function closeCommandPalette(){ commandPalette.classList.add('hidden'); commandPalette.classList.remove('flex'); }
  commandPalette.addEventListener('click', (e)=>{ if (e.target===commandPalette) closeCommandPalette(); });
  document.querySelectorAll('.command-option').forEach(opt=>{
    opt.addEventListener('click', ()=>{
      const action = opt.querySelector('.font-medium').textContent;
      closeCommandPalette();
      if (action.includes('Создать задачу')) openTaskModal();
      else if (action.includes('Создать проект')) openProjectModal();
      else if (action.includes('Список')) showView('list');
      else if (action.includes('Доска')) showView('kanban');
      else if (action.includes('Календарь')) showView('calendar');
    });
  });

  // --- Calendar navigation ---
  prevMonthBtn.addEventListener('click', ()=>{ state.calDate.setMonth(state.calDate.getMonth()-1); renderCalendar(); });
  nextMonthBtn.addEventListener('click', ()=>{ state.calDate.setMonth(state.calDate.getMonth()+1); renderCalendar(); });
  todayBtn.addEventListener('click', ()=>{ state.calDate = new Date(); renderCalendar(); });

  // --- Utility: escaping ---
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
  function priorityRu(p){ return {low:'Низкий',medium:'Средний',high:'Высокий',critical:'Критичный'}[p] || p; }

  // --- Bootstrap ---
  refreshProjectSelectors();
  showView('list');
  renderAll();
})();
</script>
</body>
</html>
