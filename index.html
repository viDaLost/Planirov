<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* === –¢–ï–ú–´ (light/dark + 5 —Ç—ë–ø–ª—ã—Ö –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã—Ö + OLIVE) === */
    :root{
      --bg:#ffffff;
      --text:#111827;
      --hint:#6b7280;
      --secondary:#f3f4f6;
      --button:#2563eb;
      --button-text:#ffffff;
      --ring:rgba(37,99,235,.35);
      --header-gradient:linear-gradient(90deg,#ffffff,#ffffff);
      --badge-ok:#10b981;
      --badge-warn:#f59e0b;
      --badge-err:#ef4444;
    }
    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e5e7eb;
      --hint:#9ca3af;
      --secondary:#171a21;
      --button:#5b74f9;
      --button-text:#ffffff;
      --ring:rgba(91,116,249,.35);
      --header-gradient:linear-gradient(90deg,#10131a,#171a21);
    }
    /* 1) Sunset */
    html[data-theme="sunset"]{
      --bg:#fff7ed;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#ffe9d6;
      --button:#f97316;
      --button-text:#1f2937;
      --ring:rgba(249,115,22,.35);
      --header-gradient:linear-gradient(90deg,#ffedd5,#fecaca,#fde68a);
    }
    /* 2) Peach */
    html[data-theme="peach"]{
      --bg:#fff1f2;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#ffe4e6;
      --button:#fb7185;
      --button-text:#1f2937;
      --ring:rgba(251,113,133,.35);
      --header-gradient:linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68–∞);
    }
    /* 3) Sand */
    html[data-theme="sand"]{
      --bg:#faf6f0;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#f1ebe2;
      --button:#d97706;
      --button-text:#111827;
      --ring:rgba(217,119,6,.35);
      --header-gradient:linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a);
    }
    /* 4) Coral */
    html[data-theme="coral"]{
      --bg:#fff5f0;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#ffe8e0;
      --button:#f43f5e;
      --button-text:#fff;
      --ring:rgba(244,63,94,.35);
      --header-gradient:linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5);
    }
    /* 5) Plum */
    html[data-theme="plum"]{
      --bg:#f9f5ff;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#f3e8ff;
      --button:#a855f7;
      --button-text:#fff;
      --ring:rgba(168,85,247,.35);
      --header-gradient:linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6);
    }
    /* 6) OLIVE (–Ω–æ–≤–∞—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤–∞—è —Ç–µ–º–∞) */
    html[data-theme="olive"]{
      --bg:#f5f7f2;
      --text:#1f2937;
      --hint:#6b7280;
      --secondary:#e8efe1;
      --button:#7da453;
      --button-text:#111827;
      --ring:rgba(125,164,83,.35);
      --header-gradient:linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6);
    }

    /* === –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò === */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--text);
      transition:background-color .25s,color .25s;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Inter',system-ui,sans-serif
    }
    .ring-focus:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .task-card{transition:box-shadow .15s, background-color .15s}
    .task-card:hover{box-shadow:0 4px 10px rgb(0 0 0 /.08)}
    .task-card.selected{outline:2px solid var(--ring); outline-offset:2px}
    .priority-low{background:rgba(52,211,153,.12);color:rgb(16,185,129)}
    .priority-medium{background:rgba(96,165,250,.12);color:rgb(59,130,246)}
    .priority-high{background:rgba(251,191,36,.12);color:rgb(234,179,8)}
    .priority-critical{background:rgba(239,68,68,.12);color:rgb(239,68,68)}
    .status-backlog{background:rgba(156,163,175,.12);color:rgb(156,163,175)}
    .status-in-progress{background:rgba(59,130,246,.12);color:rgb(59,130,246)}
    .status-review{background:rgba(168,85,247,.12);color:rgb(168,85,247)}
    .status-done{background:rgba(16,185,129,.12);color:rgb(16,185,129)}
    .kanban-column{min-height:60vh}
    .calendar-day{min-height:100px}
    .calendar-day.today{outline:2px solid var(--ring);outline-offset:-2px;background:rgba(0,0,0,.04)}
    .calendar-day.dragover{outline:2px dashed var(--ring); outline-offset:-2px}
    .command-palette{backdrop-filter:blur(10px)}
    .subtask-checkbox:checked+.subtask-label{text-decoration:line-through;color:var(--hint)}
    @media (max-width:640px){ .kanban-column{min-height:auto;max-height:60vh;overflow-y:auto} }
    .popover{position:absolute;z-index:30;background:var(--bg);border:1px solid var(--secondary);box-shadow:0 8px 24px rgb(0 0 0 / .12);border-radius:.75rem;min-width:240px}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .progress-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--button);width:0%}
    .title-input{background:transparent;border:1px dashed var(--secondary);padding:2px 6px;border-radius:6px;width:100%}

    .header-gradient{background-image:var(--header-gradient)}
    .bg-secondary{background:var(--secondary)}
    .btn-main{background:var(--button);color:var(--button-text)}
    .border-secondary{border-color:var(--secondary)}
    .text-hint{color:var(--hint)}

    /* –ü–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤ */
    .pin-chip{background:var(--secondary); border:1px solid var(--secondary)}
    .pin-chip.dragging{opacity:.5}

    /* === –ü–†–ï–ú–ò–£–ú-–õ–ï–ô–ë–õ (–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è ¬´Premium¬ª —Å –∫–æ—Ä–æ–Ω–æ–π) === */
    .premium-label{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.25rem .6rem;border-radius:999px;
      border:1px solid var(--secondary);background:var(--secondary);
      cursor:default;user-select:none
    }
    .premium-text{
      font-weight:700;
      background:linear-gradient(90deg,#f59e0b,#f43f5e,#8b5cf6,#22c55e,#f59e0b);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      background-size:300% 100%;
      animation:shine 3s linear infinite;
      letter-spacing:.2px
    }
    .premium-crown{color:#f59e0b}
    @keyframes shine{ 0%{background-position:0 0} 100%{background-position:300% 0} }

    /* –¢–æ—Å—Ç—ã (–≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) */
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      background:var(--bg);border:1px solid var(--secondary);box-shadow:0 8px 24px rgb(0 0 0 / .15);
      padding:.75rem 1rem;border-radius:.75rem;z-index:60;min-width:260px;max-width:92vw
    }
    .toast .sub{font-size:.78rem;color:var(--hint);margin-top:.25rem}
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 border-b border-secondary header-gradient">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="menu-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
            <i class="fas fa-bars"></i>
          </button>
          <!-- Side menu -->
          <aside id="side-menu" class="hidden fixed top-0 left-0 h-full w-80 bg-[var(--bg)] shadow-xl z-20 border-r border-secondary">
            <div class="p-4 border-b border-secondary flex justify-between items-center">
              <h2 class="text-lg font-semibold">–ú–µ–Ω—é</h2>
              <button id="close-menu" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- –ü—Ä–æ—Ñ–∏–ª—å (–∞–≤—Ç–æ–≤—Ö–æ–¥ Telegram) -->
            <div id="profile-box" class="p-4 border-b border-secondary flex items-center gap-3">
              <div id="profile-avatar" class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-sm font-semibold">?</div>
              <div class="min-w-0">
                <div id="profile-name" class="font-medium truncate">–ì–æ—Å—Ç—å</div>
                <div id="profile-username" class="text-xs text-hint truncate">autologin: off</div>
              </div>
            </div>

            <div class="p-3 space-y-1">
              <button id="btn-settings" class="w-full text-left px-4 py-2 rounded-lg hover:bg-secondary">
                <i class="fas fa-gear mr-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
              </button>
              <!-- –ö–Ω–æ–ø–∫–∞ –ü—Ä–µ–º–∏—É–º –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ -->
              <button id="btn-premium" class="w-full text-left px-4 py-2 rounded-lg hover:bg-secondary">
                <i class="fas fa-crown mr-2"></i>–ü—Ä–µ–º–∏—É–º
              </button>
              <!-- –ö–Ω–æ–ø–∫–∞ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ -->
              <span id="admin-menu-slot"></span>
            </div>
          </aside>
        </div>
        <h1 class="text-xl font-semibold">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</h1>

        <!-- –ü–æ–¥–ø–∏—Å–∫–∞: –ë–∞–∑–æ–≤–∞—è | Premium -->
        <div id="subscription-label" class="ml-2"></div>
      </div>

      <div class="flex items-center gap-2">
        <button id="search-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ü–æ–∏—Å–∫">
          <i class="fas fa-search"></i>
        </button>
        <button id="add-task-button" class="p-2 rounded-full btn-main ring-focus" aria-label="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-4">

    <!-- View Selector -->
    <div class="flex justify-center mb-4">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button data-view="list" class="view-selector px-4 py-2 text-sm font-medium rounded-l-lg border border-secondary hover:bg-secondary">
          <i class="fas fa-list mr-2"></i> –°–ø–∏—Å–æ–∫
        </button>
        <button data-view="kanban" class="view-selector px-4 py-2 text-sm font-medium border-y border-secondary hover:bg-secondary">
          <i class="fas fa-columns mr-2"></i> –î–æ—Å–∫–∞
        </button>
        <button data-view="calendar" class="view-selector px-4 py-2 text-sm font-medium rounded-r-lg border border-secondary hover:bg-secondary">
          <i class="fas fa-calendar-alt mr-2"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å
        </button>
      </div>
    </div>

    <!-- Mini dashboard -->
    <div id="stats-bar" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4"></div>

    <!-- Project Selector -->
    <div class="mb-2 flex items-center gap-2">
      <select id="project-selector" class="bg-secondary rounded-lg px-4 py-2 ring-focus">
        <option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
      </select>
      <button id="add-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">
        <i class="fas fa-folder-plus"></i>
      </button>
      <button id="delete-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç">
        <i class="fas fa-trash"></i>
      </button>
    </div>

    <!-- PINNED PROJECTS STRIP -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-hint">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
        <div class="text-xs text-hint">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</div>
      </div>
      <div id="pinned-strip" class="flex gap-2 overflow-x-auto pb-1">
        <!-- Chips –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
      </div>
    </div>

    <!-- List View -->
    <section id="list-view" class="view-content">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">–ó–∞–¥–∞—á–∏</h2>
        <div class="relative flex items-center gap-2">
          <input id="search-input" placeholder="–ü–æ–∏—Å–∫..." class="hidden md:block px-3 py-2 rounded-lg bg-secondary ring-focus"/>
          <button id="filter-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">
            <i class="fas fa-filter mr-1"></i> –§–∏–ª—å—Ç—Ä
          </button>
          <div id="filter-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">–§–∏–ª—å—Ç—Ä—ã</div>
            <label class="block text-sm mb-1">–ü–æ —Å—Ä–æ–∫—É</label>
            <select id="filter-due" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">–í—Å–µ</option>
              <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
              <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
            </select>
            <label class="block text-sm mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select id="filter-priority" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">–í—Å–µ</option>
              <option value="critical">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="low">–ù–∏–∑–∫–∏–π</option>
            </select>
            <label class="block text sm mb-1">–°—Ç–∞—Ç—É—Å</label>
            <select id="filter-status" class="w-full px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">–í—Å–µ</option>
              <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
              <option value="in-progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="review">–ü—Ä–æ–≤–µ—Ä–∫–∞</option>
              <option value="done">–ì–æ—Ç–æ–≤–æ</option>
            </select>
          </div>

          <button id="sort-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">
            <i class="fas fa-sort mr-1"></i> –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
          </button>
          <div id="sort-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</div>
            <select id="sort-select" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="due-asc">–°—Ä–æ–∫—É (—Ä–∞–Ω—å—à–µ ‚Üí –ø–æ–∑–∂–µ)</option>
              <option value="due-desc">–°—Ä–æ–∫—É (–ø–æ–∑–∂–µ ‚Üí —Ä–∞–Ω—å—à–µ)</option>
              <option value="priority-desc">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—ã—Å–æ–∫–∏–π ‚Üí –Ω–∏–∑–∫–∏–π)</option>
              <option value="priority-asc">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–Ω–∏–∑–∫–∏–π ‚Üí –≤—ã—Å–æ–∫–∏–π)</option>
              <option value="project-asc">–ü—Ä–æ–µ–∫—Ç—É (–ê‚Üí–Ø)</option>
              <option value="status-asc">–°—Ç–∞—Ç—É—Å—É</option>
              <option value="title-asc">–ù–∞–∑–≤–∞–Ω–∏—é (–ê‚Üí–Ø)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
      <div class="mb-3">
        <input id="quick-add-input"
               class="w-full px-4 py-3 rounded-lg bg-secondary ring-focus"
               placeholder="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É‚Ä¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: /—Å–µ–≥–æ–¥–Ω—è /–∑–∞–≤—Ç—Ä–∞ /–ø–Ω‚Ä¶/–≤—Å /–≤—ã—Å–æ–∫–∏–π /–∫—Ä–∏—Ç–∏—á–Ω–æ, #—Ç–µ–≥–∏, @–ü—Ä–æ–µ–∫—Ç"/>
        <div class="text-xs text-hint mt-1">
          –ü—Ä–∏–º–µ—Ä—ã: ¬´–°–æ–∑–≤–æ–Ω —Å –∫–ª–∏–µ–Ω—Ç–æ–º /–∑–∞–≤—Ç—Ä–∞ @–†–∞–±–æ—Ç–∞ #–≤–∞–∂–Ω–æ¬ª, ¬´–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ /—Å–µ–≥–æ–¥–Ω—è #–¥–æ–º¬ª
        </div>
      </div>

      <div id="list-container" class="space-y-3"></div>
    </section>

    <!-- Kanban View -->
    <section id="kanban-view" class="view-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div data-col="backlog" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">–ë—ç–∫–ª–æ–≥</h3>
            <span class="text-xs bg-gray-200 text-gray-800 rounded-full px-2 py-1" id="cnt-backlog">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="in-progress" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">–í —Ä–∞–±–æ—Ç–µ</h3>
            <span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-1" id="cnt-in-progress">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="review" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">–ü—Ä–æ–≤–µ—Ä–∫–∞</h3>
            <span class="text-xs bg-purple-200 text-purple-800 rounded-full px-2 py-1" id="cnt-review">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="done" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">–ì–æ—Ç–æ–≤–æ</h3>
            <span class="text-xs bg-green-200 text-green-800 rounded-full px-2 py-1" id="cnt-done">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
      </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="view-content hidden">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h2 id="month-title" class="text-lg font-semibold">–ú–µ—Å—è—Ü –ì–ì–ì–ì</h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div>
          <button id="today-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>
      </div>
      <div id="weekday-row" class="grid grid-cols-7 gap-1 mb-1"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
    </section>

  </main>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="md:hidden sticky bottom-0 border-t border-secondary header-gradient">
    <div class="flex justify-around py-2">
      <button data-view="list" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="–°–ø–∏—Å–æ–∫">
        <i class="fas fa-list text-lg"></i>
      </button>
      <button data-view="kanban" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="–î–æ—Å–∫–∞">
        <i class="fas fa-columns text-lg"></i>
      </button>
      <button data-view="calendar" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
        <i class="fas fa-calendar-alt text-lg"></i>
      </button>
      <button id="mobile-add-task-button" class="p-2 rounded-full btn-main" aria-label="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
        <i class="fas fa-plus text-lg"></i>
      </button>
    </div>
  </nav>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="task-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 id="task-modal-title" class="text-xl font-semibold">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        <button id="close-task-modal" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="task-id"/>
        <div class="mb-4">
          <input type="text" id="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-hint mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select id="task-priority" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus">
              <option value="low">–ù–∏–∑–∫–∏–π</option>
              <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              <option value="critical">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-hint mb-1">–°—Ç–∞—Ç—É—Å</label>
            <select id="task-status" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus">
              <option value="backlog">–ë—ç–∫–ª–æ–≥</option>
              <option value="in-progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="review">–ü—Ä–æ–≤–µ—Ä–∫–∞</option>
              <option value="done">–ì–æ—Ç–æ–≤–æ</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-hint mb-1">–ü—Ä–æ–µ–∫—Ç</label>
            <select id="task-project" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></select>
          </div>
          <div>
            <label class="block text-sm text-hint mb-1">–°—Ä–æ–∫</label>
            <input type="date" id="task-due-date" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="task-description" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..." class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">–ü–æ–¥–∑–∞–¥–∞—á–∏ (—á–µ—Ä–µ–∑ Enter)</label>
          <textarea id="task-subtasks" rows="2" placeholder="–ù–∞–ø—Ä.: –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤&#10;–°–¥–µ–ª–∞—Ç—å –ø–ª–∞–Ω" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">–ú–µ—Ç–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="task-tags" placeholder="–†–∞–±–æ—Ç–∞, –í–∞–∂–Ω–æ" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-task" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">–û—Ç–º–µ–Ω–∞</button>
          <button id="save-task" class="px-4 py-2 rounded-lg btn-main">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="project-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[80vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
        <button id="close-project-modal" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="project-id"/>
        <div class="mb-4">
          <input type="text" id="project-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">–¶–≤–µ—Ç</label>
          <input type="color" id="project-color" value="#3b82f6" class="w-16 h-10 p-1 bg-secondary rounded ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="project-description" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="flex justify-between mt-6">
          <button id="delete-project" class="px-4 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50/10">
            <i class="fas fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å
          </button>
          <div class="flex gap-2">
            <button id="cancel-project" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button id="save-project" class="px-4 py-2 rounded-lg btn-main">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="settings-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[85vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <button id="close-settings" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 space-y-6">
        <div>
          <div class="text-sm font-medium mb-2">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
          <div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–µ–º –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
          </div>
        </div>
        <!-- –ü—Ä–µ–º–∏—É–º-–±–ª–æ–∫ + –∞–¥–º–∏–Ω-–±–ª–æ–∫ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        <div id="admin-slot" class="space-y-4"></div>
        <div class="text-xs text-hint">–¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.</div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative w-full max-w-md mx-4">
      <div class="command-palette bg-[var(--bg)] rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-secondary">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-hint"></i>
            </div>
            <input type="text" id="command-input" placeholder="–ö–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –ø–æ–∏—Å–∫..." class="w-full pl-10 pr-4 py-2 bg-secondary rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="max-h-96 overflow-y-auto">
          <div class="px-4 py-2 text-sm text-hint">–ó–∞–¥–∞—á–∏</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-blue-100 text-blue-800 mr-3"><i class="fas fa-plus"></i></div>
              <div>
                <div class="font-medium">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</div>
                <div class="text-xs text-hint">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</div>
              </div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-purple-100 text-purple-800 mr-3"><i class="fas fa-search"></i></div>
              <div>
                <div class="font-medium">–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á</div>
                <div class="text-xs text-hint">–ò—Å–∫–∞—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-hint">–ü—Ä–æ–µ–∫—Ç—ã</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-green-100 text-green-800 mr-3"><i class="fas fa-folder-plus"></i></div>
              <div>
                <div class="font-medium">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</div>
                <div class="text-xs text-hint">–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-hint">–í–∏–¥—ã</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-yellow-100 text-yellow-800 mr-3"><i class="fas fa-list"></i></div>
              <div><div class="font-medium">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –°–ø–∏—Å–æ–∫</div><div class="text-xs text-hint">–ü—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-indigo-100 text-indigo-800 mr-3"><i class="fas fa-columns"></i></div>
              <div><div class="font-medium">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –î–æ—Å–∫—É</div><div class="text-xs text-hint">–ö–∞–Ω–±–∞–Ω</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-red-100 text-red-800 mr-3"><i class="fas fa-calendar-alt"></i></div>
              <div><div class="font-medium">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div><div class="text-xs text-hint">–ü–æ–∫–∞–∑ –∑–∞–¥–∞—á –ø–æ –¥–∞—Ç–∞–º</div></div>
            </div>
          </div>
        </div>
        <div class="p-2 text-xs text-center text-hint border-t border-secondary">
          Esc ‚Äî –∑–∞–∫—Ä—ã—Ç—å ‚Ä¢ N ‚Äî –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ ‚Ä¢ Ctrl/Cmd+K ‚Äî –ø–∞–ª–∏—Ç—Ä–∞ ‚Ä¢ F ‚Äî –ø–æ–∏—Å–∫ ‚Ä¢ 1/2/3 ‚Äî –≤–∏–¥—ã ‚Ä¢ Del ‚Äî —É–¥–∞–ª–∏—Ç—å
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
    <div class="w-24 h-24 bg-secondary rounded-full flex items-center justify-center mb-4">
      <i class="fas fa-tasks text-3xl text-hint"></i>
    </div>
    <h3 class="text-lg font-medium mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</h3>
    <p class="text-sm text-hint mb-4 text-center max-w-md px-4">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´+¬ª –∏–ª–∏ –∫–ª–∞–≤–∏—à—É N.</p>
    <button id="empty-state-add-task" class="px-4 py-2 rounded-lg btn-main">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
  </div>
</div>
<script>
(() => {
  /* ========= –ó–ê–ü–†–ï–¢ –û–¢–ö–†–´–¢–ò–Ø –í –ë–†–ê–£–ó–ï–†–ï (—Ç–æ–ª—å–∫–æ Telegram WebApp) ========= */
  (function enforceTelegramOnly(){
    const isTg = !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData);
    const platform = Telegram?.WebApp?.platform || '';
    if (!isTg || platform === '') {
      const gate = document.createElement('div');
      gate.style.position = 'fixed';
      gate.style.inset = '0';
      gate.style.zIndex = '9999';
      gate.style.background = 'var(--bg)';
      gate.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 text-center">
          <div class="max-w-md">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-secondary flex items-center justify-center">
              <i class="fas fa-lock text-2xl"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2">–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram</h2>
            <p class="text-sm text-hint mb-4">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram ‚Äî —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ —Å—Å—ã–ª–∫—É –≤ —á–∞—Ç–µ.</p>
            <a href="https://t.me/D_a_n_Vi" target="_blank" class="px-4 py-2 rounded-lg btn-main inline-block">–ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</a>
          </div>
        </div>
      `;
      document.body.appendChild(gate);
      throw new Error('Blocked: Not inside Telegram WebApp');
    }
  })();

  /* ========= TELEGRAM AUTOLOGIN / –ü–†–û–§–ò–õ–¨ / –ö–õ–Æ–ß–ò –•–†–ê–ù–ò–õ–ò–©–ê ========= */
  const tg = window.Telegram?.WebApp;
  const tgUser = tg?.initDataUnsafe?.user || null;

  // –ê–≤—Ç–æ-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
  try {
    tg?.ready();
    tg?.expand?.();
    tg?.MainButton?.hide?.();
  } catch(_) {}

  // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ localStorage (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ Telegram ID)
  const LS_THEME_BASE = 'tp_theme_v2';
  const LS_DATA_BASE  = 'tp_data_default';
  const userSuffix    = tgUser?.id ? `tg_${tgUser.id}` : 'guest';
  const LS_THEME      = `${LS_THEME_BASE}_${userSuffix}`;
  const LS_DATA       = `${LS_DATA_BASE}_${userSuffix}`;

  // ==== PREMIUM / ADMIN –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====
  const ADMIN_TG_ID = 1288379477; // —Ç–≤–æ–π Telegram ID
  const PREMIUM_SECRET = 'tp$S3cr3t@v1'; // "–ø–æ–¥–ø–∏—Å—å" –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏—è)
  const PREMIUM_LS_KEY = tgUser?.id ? `tp_premium_${tgUser.id}` : null;

  // –°—Ç–∞—Ç—É—Å –ø—Ä–µ–º–∏—É–º–∞ (–±–µ–∑ —Å—á—ë—Ç—á–∏–∫–æ–≤ –¥–Ω–µ–π)
  const premium = {
    tier: 'free',     // 'free' | 'premium'
    mode: 'paid',     // 'paid' | null (–¥–ª—è –∞–¥–º–∏–Ω–∞ –≤—Å–µ–≥–¥–∞ 'paid')
    expiresAt: null   // 'YYYY-MM-DD' (–¥–ª—è –∞–¥–º–∏–Ω–∞ ‚Äî –¥–∞–ª–µ–∫–æ –≤ –±—É–¥—É—â–µ–º)
  };
    // –ê–¥–º–∏–Ω –≤—Å–µ–≥–¥–∞ ¬´–ø—Ä–µ–º–∏—É–º¬ª
  if (tgUser?.id && String(tgUser.id) === '1288379477') {
    premium.tier = 'premium';
    premium.mode = 'paid';
    premium.expiresAt = '2099-12-31';
  }

  /* ========= –ü–†–ï–ú–ò–£–ú: —É—Ç–∏–ª–∏—Ç—ã ========= */
  function savePremiumEnd(endISO){
    if (!PREMIUM_LS_KEY) return;
    const store = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY) || '{}');
    store.end_ts = endISO;
    localStorage.setItem(PREMIUM_LS_KEY, JSON.stringify(store));
  }
  function getPremiumEnd(){
    if (premium.expiresAt) return premium.expiresAt;
    if (!PREMIUM_LS_KEY) return null;
    const store = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY) || '{}');
    return store.end_ts ? new Date(store.end_ts).toISOString().slice(0,10) : null;
  }
  function isPremiumActive(){
    if (premium.tier === 'premium') return true;
    const end = getPremiumEnd();
    return !!(end && new Date(end) > new Date());
  }
  function premiumLabel(){
    return isPremiumActive() ? 'Premium' : '–ë–∞–∑–æ–≤–∞—è';
  }

  /* ========= UI: –ø–æ–¥–ø–∏—Å—å –≤ —à–∞–ø–∫–µ (–ü–æ–¥–ø–∏—Å–∫–∞ | –ë–∞–∑–æ–≤–∞—è/Premium) + –ª–æ–Ω–≥-—Ç–∞–ø ========= */
  function reflectSubscriptionUI(){
    const holder = document.getElementById('subscription-label');
    holder.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'premium-label';
    if (isPremiumActive()){
      wrap.innerHTML = `<i class="fas fa-crown premium-crown"></i><span class="premium-text">Premium</span>`;
    } else {
      wrap.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ | –ë–∞–∑–æ–≤–∞—è';
    }
    // –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü–æ–¥–ø–∏—Å–∫–∞ | ..." –ø—Ä–µ—Ñ–∏–∫—Å
    if (isPremiumActive()){
      const box = document.createElement('div');
      box.className = 'premium-label';
      box.innerHTML = `–ü–æ–¥–ø–∏—Å–∫–∞ | <i class="fas fa-crown premium-crown ml-2"></i><span class="premium-text ml-1">Premium</span>`;
      holder.appendChild(box);
      attachLongPressToast(box);
    } else {
      const box = document.createElement('div');
      box.className = 'premium-label';
      box.textContent = '–ü–æ–¥–ø–∏—Å–∫–∞ | –ë–∞–∑–æ–≤–∞—è';
      holder.appendChild(box);
      attachLongPressToast(box);
    }
  }

  function attachLongPressToast(el){
    let t, pressed=false;
    const start = ()=>{ pressed=true; t=setTimeout(()=> showSubToast(), 600); };
    const cancel = ()=>{ pressed=false; clearTimeout(t); };
    el.addEventListener('mousedown', start);
    el.addEventListener('touchstart', start, {passive:true});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> el.addEventListener(ev, cancel));
  }
  function showSubToast(){
    const old = document.querySelector('.toast');
    if (old) old.remove();
    const isPrem = isPremiumActive();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
      <div><b>–í–∞—à —Å—Ç–∞—Ç—É—Å:</b> ${isPrem ? '–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞' : '–ë–∞–∑–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞'}</div>
      ${isPrem ? `<div class="sub">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ: ${getPremiumEnd() || '‚Äî'}</div>` : ''}
    `;
    document.body.appendChild(toast);
    setTimeout(()=> toast.remove(), 3200);
  }

  /* ========= –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö (–±–µ–∑ –ø—Ä–æ–±–Ω—ã—Ö) ========= */
  function maybeShowExpiryBanner(){
    if (!isPremiumActive()) return;
    const end = getPremiumEnd();
    if (!end) return;
    const daysLeft = Math.ceil((new Date(end) - new Date()) / (1000*60*60*24));
    if (daysLeft !== 1) return;
    const banner = document.createElement('div');
    banner.className = 'mb-3 p-3 rounded-lg border border-secondary bg-[var(--secondary)]';
    banner.innerHTML = `
      <div class="flex items-center justify-between gap-3">
        <div>‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–∞–≤—Ç—Ä–∞ (${end}).</div>
        <button id="btn-renew" class="px-3 py-1 rounded-lg btn-main">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
      </div>`;
    document.querySelector('main').prepend(banner);
    banner.querySelector('#btn-renew').addEventListener('click', ()=> openPremiumModal());
  }

  /* ========= –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ localStorage (–±–µ–∑ —Ç—Ä–∏–∞–ª–æ–≤) ========= */
  function fetchPremiumStatus(){
    if (tgUser?.id && String(tgUser.id) === '1288379477'){
      premium.tier = 'premium';
      premium.mode = 'paid';
      premium.expiresAt = '2099-12-31';
    } else {
      const end = getPremiumEnd();
      if (end && new Date(end) > new Date()){
        premium.tier = 'premium';
        premium.mode = 'paid';
        premium.expiresAt = end;
      } else {
        premium.tier = 'free';
        premium.mode = null;
        premium.expiresAt = null;
      }
    }
    reflectSubscriptionUI();
    maybeShowExpiryBanner();
  }

  /* ========= –ü—Ä–æ–º–æ–∫–æ–¥—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º, –¥–æ–±–∞–≤–∏–ª–∏ 3 –º–µ—Å—è—Ü–∞) ========= */
  function hashFn(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
    }
    return ('0000000' + (h>>>0).toString(16)).slice(-8);
  }
  const b64u = s => btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const b64uDec = s => { s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return atob(s); };

  // payload: { tgId, plan:"M1"|"M3"|"M6", iat:number, durDays:number, expISO:string }
  function signPayload(obj){
    const payload = JSON.stringify(obj);
    const sig = hashFn(PREMIUM_SECRET + '|' + payload + '|v1');
    return `TP1.${b64u(payload)}.${sig}`;
  }
  function verifyAndParse(code){
    if (!code || typeof code!=='string') return null;
    const parts = code.trim().split('.');
    if (parts.length !== 3 || parts[0] !== 'TP1') return null;
    try{
      const payloadStr = b64uDec(parts[1]);
      const sig = parts[2];
      const ok = hashFn(PREMIUM_SECRET + '|' + payloadStr + '|v1') === sig;
      if (!ok) return null;
      return JSON.parse(payloadStr);
    }catch{ return null; }
  }
  function redeemPromo(code){
    const data = verifyAndParse(code);
    if (!data){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥'); return; }
    if (!tgUser?.id){ alert('–ù—É–∂–µ–Ω –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram'); return; }
    if (String(data.tgId) !== String(tgUser.id)){ alert('–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –≤—ã–¥–∞–Ω –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞'); return; }
    const days = Number(data.durDays) || (data.plan==='M6'? 183 : data.plan==='M3'? 92 : 31);
    const now = new Date();
    const prevEndISO = getPremiumEnd();
    let base = now;
    if (prevEndISO){
      const prev = new Date(prevEndISO);
      if (prev > now) base = prev;
    }
    const newEnd = new Date(base);
    newEnd.setDate(newEnd.getDate() + days);
    savePremiumEnd(newEnd.toISOString());
    fetchPremiumStatus();
    alert('–ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
  }

  /* ========= –ü—Ä–µ–º–∏—É–º-–º–æ–¥–∞–ª–∫–∞: –±–µ–∑ ¬´–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å id¬ª, —Å –º–µ–Ω—é —Å—Ä–æ–∫–æ–≤ 1/3/6 –∏ –∫–Ω–æ–ø–∫–æ–π ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª ========= */
  function openPremiumModal(){
    const id = 'premium-modal';
    let modal = document.getElementById(id);
    if (modal) modal.remove();

    const isPrem = isPremiumActive();
    const statusText = isPrem ? `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${getPremiumEnd() || '‚Äî'}` : '–ë–∞–∑–æ–≤–∞—è';

    modal = document.createElement('div');
    modal.id = id;
    modal.className = 'fixed inset-0 z-50';
    modal.innerHTML = `
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl p-5 space-y-4 max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">–ü—Ä–µ–º–∏—É–º</h3>
          <button id="prem-close" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)]">
          <div class="text-sm">–°—Ç–∞—Ç—É—Å: <b>${statusText}</b></div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</div>
          <div class="grid grid-cols-1 gap-2">
            <div class="flex items-center gap-2">
              <input type="radio" name="plan" id="plan1" value="M1" class="accent-[var(--button)]" checked>
              <label for="plan1">1 –º–µ—Å—è—Ü</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="radio" name="plan" id="plan3" value="M3" class="accent-[var(--button)]">
              <label for="plan3">3 –º–µ—Å—è—Ü–∞</label>
            </div>
            <div class="flex items-center gap-2">
              <input type="radio" name="plan" id="plan6" value="M6" class="accent-[var(--button)]">
              <label for="plan6">6 –º–µ—Å—è—Ü–µ–≤</label>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="btn-send" class="px-3 py-2 rounded-lg btn-main">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button id="btn-redeem" class="px-3 py-2 rounded-lg border border-secondary hover:bg-secondary">–í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</button>
          </div>
          <div id="redeem-row" class="hidden flex gap-2">
            <input id="promo-input" class="flex-1 px-3 py-2 rounded-lg bg-secondary ring-focus" placeholder="TP1.xxxxx.yyyyy"/>
            <button id="btn-apply" class="px-3 py-2 rounded-lg btn-main">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="text-xs text-hint">–û–ø–ª–∞—Ç–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äî –≤ –¥–∏–∞–ª–æ–≥–µ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</div>
      </div>
    `;
    document.body.appendChild(modal);

    const close = ()=> modal.remove();
    modal.querySelector('#prem-close').addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); });

    modal.querySelector('#btn-redeem').addEventListener('click', ()=>{
      modal.querySelector('#redeem-row').classList.remove('hidden');
    });
    modal.querySelector('#btn-apply').addEventListener('click', ()=>{
      const code = modal.querySelector('#promo-input').value.trim();
      redeemPromo(code);
      close();
    });

    modal.querySelector('#btn-send').addEventListener('click', ()=>{
      const plan = modal.querySelector('input[name="plan"]:checked')?.value || 'M1';
      const txt = plan==='M6' ? '–ø–æ–ª–≥–æ–¥–∞' : plan==='M3' ? '—Ç—Ä–∏ –º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü';
      const msg = encodeURIComponent(`–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –•–æ—Ç–µ–ª(–∞) –±—ã –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ ${txt}.`);
      const url = `https://t.me/D_a_n_Vi?text=${msg}`;
      if (tg?.openTelegramLink) tg.openTelegramLink(url);
      else window.open(url, '_blank');
      close();
    });
  }

  // –ö–Ω–æ–ø–∫–∞ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é
  document.getElementById('btn-premium')?.addEventListener('click', openPremiumModal);

  /* ========= –¢–µ–º—ã: –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ç–æ–ª—å–∫–æ light/dark, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø—Ä–µ–º–∏—É–º ========= */
  const THEMES = [
    { id:'light',  name:'–°–≤–µ—Ç–ª–∞—è',  grad:'linear-gradient(90deg,#ffffff,#f9fafb)' },
    { id:'dark',   name:'–¢—ë–º–Ω–∞—è',   grad:'linear-gradient(90deg,#0f1115,#171a21)' },
    { id:'sunset', name:'Sunset',   grad:'linear-gradient(90deg,#ffedd5,#fecaca,#fde68a)' },
    { id:'peach',  name:'Peach',    grad:'linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68a)' },
    { id:'sand',   name:'Sand',     grad:'linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a)' },
    { id:'coral',  name:'Coral',    grad:'linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5)' },
    { id:'plum',   name:'Plum',     grad:'linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6)' },
    { id:'olive',  name:'Olive',    grad:'linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6)' },
  ];
  const _origSetTheme = (id)=>{ document.documentElement.setAttribute('data-theme', id); localStorage.setItem(LS_THEME, id); };
  function setTheme(id){
    const free = (id==='light' || id==='dark');
    if (!free && !isPremiumActive()){
      openPremiumModal(); return;
    }
    _origSetTheme(id);
    buildThemeCards();
  }
  function buildThemeCards(){
    const themeGrid = document.getElementById('theme-grid');
    const current = document.documentElement.getAttribute('data-theme');
    themeGrid.innerHTML = '';
    THEMES.forEach(t=>{
      const free = (t.id==='light' || t.id==='dark');
      const locked = !free && !isPremiumActive();
      const card = document.createElement('button');
      card.className = 'w-full text-left rounded-xl border border-secondary p-3 ring-focus ' + (locked ? 'opacity-70 cursor-not-allowed' : 'hover:bg-secondary');
      card.innerHTML = `
        <div class="h-10 w-full rounded-md mb-2" style="background:${t.grad}"></div>
        <div class="flex items-center justify-between">
          <div class="font-medium">${t.name} ${locked ? '<span class="text-xs ml-2">üîí</span>' : ''}</div>
          ${current===t.id ? '<i class="fas fa-check"></i>' : ''}
        </div>`;
      card.addEventListener('click', ()=> setTheme(t.id));
      themeGrid.appendChild(card);
    });
  }

  /* ========= –ê–¥–º–∏–Ω: —Ç–æ–ª—å–∫–æ —É –≤–ª–∞–¥–µ–ª—å—Ü–∞, –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é, –±–µ–∑ ¬´–≤—Ö–æ–¥–∞¬ª ========= */
  function isAdmin(){ return tgUser?.id && String(tgUser.id) === '1288379477'; }

  function injectAdminMenuButton(){
    const slot = document.getElementById('admin-menu-slot');
    if (!slot) return;
    slot.innerHTML = '';
    if (!isAdmin()) return;
    const btn = document.createElement('button');
    btn.className = 'w-full text-left px-4 py-2 rounded-lg hover:bg-secondary';
    btn.innerHTML = `<i class="fas fa-user-shield mr-2"></i>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å`;
    btn.addEventListener('click', ()=>{
      openSettings();
      ensureAdminPanel();
      document.getElementById('admin-panel')?.scrollIntoView({behavior:'smooth',block:'start'});
    });
    slot.replaceWith(btn);
  }

  function ensureAdminPanel(){
    const slot = document.getElementById('admin-slot');
    slot.innerHTML = '';
    if (!isAdmin()) return; // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∫–æ–º—É –∫—Ä–æ–º–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    const panel = document.createElement('div');
    panel.id = 'admin-panel';
    panel.className = 'p-3 rounded-lg border border-secondary bg-[var(--secondary)] space-y-3';
    panel.innerHTML = `
      <div class="text-sm font-medium">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏</div>
      <div class="grid sm:grid-cols-2 gap-2">
        <input id="promo-user-id" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary" placeholder="Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"/>
        <select id="promo-plan" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary">
          <option value="M1">1 –º–µ—Å—è—Ü</option>
          <option value="M3">3 –º–µ—Å—è—Ü–∞</option>
          <option value="M6">6 –º–µ—Å—è—Ü–µ–≤</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="promo-generate" class="px-3 py-2 rounded-lg btn-main">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="promo-refresh" class="px-3 py-2 rounded-lg border border-secondary hover:bg-[var(--bg)]">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥</button>
      </div>
      <div>
        <label class="block text-xs text-hint mb-1">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input id="promo-output" readonly class="w-full px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary"/>
      </div>
      <div>
        <label class="block text-xs text-hint mb-1">–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input id="promo-link" readonly class="w-full px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary"/>
        <div class="text-xs text-hint mt-1">–°—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç —á–∞—Ç —Å–æ –º–Ω–æ–π –∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∫–æ–¥.</div>
      </div>
    `;
    slot.appendChild(panel);

    const uidInput = panel.querySelector('#promo-user-id');
    const planSel  = panel.querySelector('#promo-plan');
    const out      = panel.querySelector('#promo-output');
    const linkOut  = panel.querySelector('#promo-link');

    if (!uidInput.value && tgUser?.id) uidInput.value = String(tgUser.id);

    function doGen(){
      const targetId = uidInput.value.trim();
      const plan = planSel.value;
      if (!/^\d+$/.test(targetId)) { alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID'); return; }
      const days = plan==='M6'?183: plan==='M3'?92:31;
      const payload = {
        tgId: Number(targetId),
        plan,
        durDays: days,
        iat: Date.now(),
        expISO: new Date(Date.now() + days*24*60*60*1000).toISOString()
      };
      const code = signPayload(payload);
      out.value = code;
      const msg = encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–ª—É—á–∏–ª –ø—Ä–æ–º–æ–∫–æ–¥: ${code}`);
      linkOut.value = `https://t.me/D_a_n_Vi?text=${msg}`;
      navigator.clipboard?.writeText(code).catch(()=>{});
    }
    panel.querySelector('#promo-generate').addEventListener('click', doGen);
    panel.querySelector('#promo-refresh').addEventListener('click', doGen);
  }

  /* ========= –î–ê–õ–ï–ï ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ========= */

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    projects: [
      { id:'work',     name:'–†–∞–±–æ—Ç–∞',   color:'#3b82f6' },
      { id:'personal', name:'–õ–∏—á–Ω–æ–µ',   color:'#10b981' },
      { id:'team',     name:'–ö–æ–º–∞–Ω–¥–∞',  color:'#8b5cf6' }
    ],
    pinned: ['work','personal','team'],
    tasks: [
      { id: uid(), title:'–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç—É', priority:'high', status:'in-progress', project:'work', dueDate: todayISO(1), description:'–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã', tags:['–†–∞–±–æ—Ç–∞'], subtasks:['–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤','–°–∫–µ–ª–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞'], subtasksDone:[false,false], completed:false, createdAt: nowISO() },
      { id: uid(), title:'–ö–æ–º–∞–Ω–¥–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞', priority:'medium', status:'backlog', project:'team', dueDate: todayISO(0), description:'–°–∏–Ω–∫ –ø–æ –∑–∞–¥–∞—á–∞–º', tags:['–ö–æ–º–∞–Ω–¥–∞'], subtasks:[], subtasksDone:[], completed:false, createdAt: nowISO() },
      { id: uid(), title:'–ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã', priority:'low', status:'backlog', project:'personal', dueDate:'', description:'–•–ª–µ–±, –º–æ–ª–æ–∫–æ', tags:['–õ–∏—á–Ω–æ–µ'], subtasks:['–°–ø–∏—Å–æ–∫'], subtasksDone:[false], completed:false, createdAt: nowISO() },
      { id: uid(), title:'–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD', priority:'high', status:'done', project:'team', dueDate: todayISO(-3), description:'GitHub Actions', tags:['DevOps'], subtasks:[], subtasksDone:[], completed:true, completedAt: todayISO(-2)+'T10:00:00Z', createdAt: nowISO() },
    ],
    view:'list',
    search:'',
    filters:{ due:'all', priority:'all', status:'all' },
    sort:'due-asc',
    currentMonth:new Date(),
    selectedTaskId:null
  };

  // –£—Ç–∏–ª–∏—Ç—ã
  function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
  function todayISO(shift=0){ const d=new Date(); d.setDate(d.getDate()+shift); return d.toISOString().slice(0,10); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtDateHuman(iso){ if(!iso) return '–ë–µ–∑ —Å—Ä–æ–∫–∞'; const d = new Date(iso+'T00:00:00'); return d.toLocaleDateString('ru-RU',{ day:'2-digit', month:'long' }); }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function projectById(id){ return state.projects.find(p=>p.id===id) || null; }
  function projectName(id){ return (projectById(id)?.name) || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞'; }
  function priorityRu(p){ return ({low:'–ù–∏–∑–∫–∏–π', medium:'–°—Ä–µ–¥–Ω–∏–π', high:'–í—ã—Å–æ–∫–∏–π', critical:'–ö—Ä–∏—Ç–∏—á–Ω—ã–π'})[p] || p; }
  function statusRu(s){ return ({'backlog':'–ë—ç–∫–ª–æ–≥','in-progress':'–í —Ä–∞–±–æ—Ç–µ','review':'–ü—Ä–æ–≤–µ—Ä–∫–∞','done':'–ì–æ—Ç–æ–≤–æ'})[s] || s; }
  function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||''); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:59,g:130,b:246}; }
  function rgba(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function textColorForBg(hex){ const {r,g,b}=hexToRgb(hex); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#111827':'#f9fafb'; }
  function startOfWeek(d=new Date()){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-wd); return x; }
  function endOfWeek(d=new Date()){ const x=startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
  function parseRussianWeekdayToken(tok){ const map = { '/–ø–Ω':1,'/–≤—Ç':2,'/—Å—Ä':3,'/—á—Ç':4,'/–ø—Ç':5,'/—Å–±':6,'/–≤—Å':0 }; return map[tok] ?? null; }
  function nextWeekdayISO(target){ const d=new Date(); const today=d.getDay(); let delta=(target-today+7)%7; if(delta===0) delta=7; d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const savedTheme = localStorage.getItem(LS_THEME) || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);

  function load(){
    const raw = localStorage.getItem(LS_DATA);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if (Array.isArray(data.projects)) state.projects = data.projects;
      if (Array.isArray(data.pinned)) state.pinned = data.pinned.slice(0,6);
      if (Array.isArray(data.tasks)) {
        state.tasks = data.tasks.map(t=>{
          if (Array.isArray(t.subtasks) && !Array.isArray(t.subtasksDone)) {
            t.subtasksDone = t.subtasks.map(()=>false);
          }
          return t;
        });
      }
    }catch(e){ console.warn('load error', e); }
  }
  function save(){
    localStorage.setItem(LS_DATA, JSON.stringify({
      projects: state.projects,
      pinned: state.pinned,
      tasks: state.tasks
    }));
    updateAppBadge();
  }

  // –≠–ª–µ–º–µ–Ω—Ç—ã UI
  const sideMenu = document.getElementById('side-menu');
  const menuBtn = document.getElementById('menu-button');
  const closeMenu = document.getElementById('close-menu');

  const statsBar = document.getElementById('stats-bar');
  const projectSelector = document.getElementById('project-selector');
  const addProjectButton = document.getElementById('add-project-button');
  const deleteProjectButton = document.getElementById('delete-project-button');

  const pinnedStrip = document.getElementById('pinned-strip');

  const searchButton = document.getElementById('search-button');
  const searchInput = document.getElementById('search-input');
  const quickAddInput = document.getElementById('quick-add-input');

  const filterButton = document.getElementById('filter-button');
  const filterPanel = document.getElementById('filter-panel');
  const filterDue = document.getElementById('filter-due');
  const filterPriority = document.getElementById('filter-priority');
  const filterStatus = document.getElementById('filter-status');

  const sortButton = document.getElementById('sort-button');
  const sortPanel = document.getElementById('sort-panel');
  const sortSelect = document.getElementById('sort-select');

  const listContainer = document.getElementById('list-container');
  const emptyState = document.getElementById('empty-state');

  const taskModal = document.getElementById('task-modal');
  const taskBackdrop = document.getElementById('task-backdrop');
  const taskModalTitle = document.getElementById('task-modal-title');
  const addTaskButtons = document.querySelectorAll('#add-task-button, #mobile-add-task-button, #empty-state-add-task');
  const closeTaskModal = document.getElementById('close-task-modal');
  const cancelTask = document.getElementById('cancel-task');
  const saveTaskBtn = document.getElementById('save-task');

  const projectModal = document.getElementById('project-modal');
  const projectBackdrop = document.getElementById('project-backdrop');
  const closeProjectModal = document.getElementById('close-project-modal');
  const cancelProject = document.getElementById('cancel-project');
  const saveProject = document.getElementById('save-project');
  const deleteProject = document.getElementById('delete-project');
  const projectNameInput = document.getElementById('project-name');
  const projectColorInput = document.getElementById('project-color');

  const settingsModal = document.getElementById('settings-modal');
  const settingsBackdrop = document.getElementById('settings-backdrop');
  const closeSettings = document.getElementById('close-settings');
  const themeGrid = document.getElementById('theme-grid');

  const commandPalette = document.getElementById('command-palette');
  const commandInput = document.getElementById('command-input');
  const commandOptions = document.querySelectorAll('.command-option');

  const prevMonth = document.getElementById('prev-month');
  const nextMonth = document.getElementById('next-month');
  const todayButton = document.getElementById('today-button');
  const monthTitle = document.getElementById('month-title');
  const weekdayRow = document.getElementById('weekday-row');
  const calendarGrid = document.getElementById('calendar-grid');

  const viewContents = document.querySelectorAll('.view-content');
  const viewSelectors = document.querySelectorAll('.view-selector');

  /* ========= –ú–µ–Ω—é (–æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å) ========= */
  menuBtn.addEventListener('click', ()=> sideMenu.classList.remove('hidden'));
  closeMenu.addEventListener('click', ()=> sideMenu.classList.add('hidden'));
  document.addEventListener('click', (e)=>{
    if (!sideMenu.classList.contains('hidden')) {
      const inside = sideMenu.contains(e.target) || menuBtn.contains(e.target);
      if (!inside) sideMenu.classList.add('hidden');
    }
  });

  /* ========= –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ========= */
  function openSettings(){ settingsModal.classList.remove('hidden'); }
  function closeSettingsModal(){ settingsModal.classList.add('hidden'); }
  closeSettings.addEventListener('click', closeSettingsModal);
  settingsBackdrop.addEventListener('click', closeSettingsModal);

  /* ========= –ü—Ä–æ–µ–∫—Ç—ã ========= */
  function hydrateProjectSelector(){
    projectSelector.innerHTML = '<option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>';
    state.projects.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.name;
      projectSelector.appendChild(opt);
    });
  }
  function hydrateTaskProjectSelect(){
    const sel = document.getElementById('task-project');
    sel.innerHTML = '';
    state.projects.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }
  projectSelector.addEventListener('change', renderAll);

  addProjectButton.addEventListener('click', openProjectModal);
  deleteProjectButton.addEventListener('click', ()=>{
    const id = projectSelector.value;
    if (id==='all'){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç.'); return; }
    const name = projectName(id);
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´${name}¬ª? –ï–≥–æ –∑–∞–¥–∞—á–∏ —Å—Ç–∞–Ω—É—Ç ¬´–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞¬ª.`)) {
      state.projects = state.projects.filter(p=>p.id!==id);
      state.tasks.forEach(t=>{ if (t.project===id) t.project=''; });
      state.pinned = state.pinned.filter(pid=>pid!==id);
      save(); hydrateProjectSelector(); hydrateTaskProjectSelect(); renderPinnedStrip(); renderAll();
    }
  });

  function openProjectModal(){
    projectModal.classList.remove('hidden');
    document.getElementById('project-id').value='';
    projectNameInput.value='';
    projectColorInput.value='#3b82f6';
    document.getElementById('project-description').value='';
  }
  function closeProjectModalFunc(){ projectModal.classList.add('hidden'); }
  [closeProjectModal, cancelProject, projectBackdrop].forEach(x=> x.addEventListener('click', closeProjectModalFunc));

  saveProject.addEventListener('click', ()=>{
    const name = projectNameInput.value.trim();
    const color = projectColorInput.value || '#3b82f6';
    if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞'); return; }
    const id = name.toLowerCase().replace(/\s+/g,'-');
    const existing = state.projects.find(p=>p.id===id);
    if(!existing){
      state.projects.push({ id, name, color });
      if (state.pinned.length < 6) state.pinned.push(id);
    }else{
      existing.name = name; existing.color = color;
    }
    save(); hydrateProjectSelector(); hydrateTaskProjectSelect(); renderPinnedStrip(); closeProjectModalFunc(); renderAll();
  });

  deleteProject.addEventListener('click', ()=>{
    const name = projectNameInput.value.trim();
    const id = name.toLowerCase().replace(/\s+/g,'-');
    if(!id){ alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è'); return; }
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´${name}¬ª? –ï–≥–æ –∑–∞–¥–∞—á–∏ —Å—Ç–∞–Ω—É—Ç ¬´–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞¬ª.`)) {
      state.projects = state.projects.filter(p=>p.id!==id);
      state.tasks.forEach(t=>{ if(t.project===id) t.project=''; });
      state.pinned = state.pinned.filter(pid=>pid!==id);
      save(); hydrateProjectSelector(); hydrateTaskProjectSelect(); renderPinnedStrip(); renderAll(); closeProjectModalFunc();
    }
  });

  /* ========= –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã ========= */
  function renderPinnedStrip(){
    pinnedStrip.innerHTML = '';
    const makeChip = (pid)=>{
      const p = projectById(pid);
      if (!p) return;
      const chip = document.createElement('div');
      chip.className = 'pin-chip flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer select-none';
      chip.draggable = true;
      chip.dataset.id = pid;
      chip.innerHTML = `
        <span class="w-2.5 h-2.5 rounded-full" style="background:${p.color}"></span>
        <span class="text-sm">${escapeHtml(p.name)}</span>
        <button class="text-red-500 hover:text-red-600 ml-1" title="–£–±—Ä–∞—Ç—å –∏–∑ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö" data-act="unpin"><i class="fas fa-times"></i></button>
      `;
      chip.addEventListener('click', (e)=>{
        if (e.target.closest('[data-act="unpin"]')) return;
        projectSelector.value = pid;
        renderAll();
      });
      chip.querySelector('[data-act="unpin"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        state.pinned = state.pinned.filter(x=>x!==pid);
        save(); renderPinnedStrip();
      });
      pinnedStrip.appendChild(chip);
    };

    state.pinned.slice(0,6).forEach(makeChip);

    if (state.pinned.length < 6){
      const addChip = document.createElement('button');
      addChip.className = 'pin-chip px-3 py-2 rounded-lg flex items-center gap-2 hover:opacity-90 ring-focus';
      addChip.innerHTML = '<i class="fas fa-plus"></i><span class="text-sm">–î–æ–±–∞–≤–∏—Ç—å</span>';
      addChip.addEventListener('click', ()=> addPinnedFlow());
      pinnedStrip.appendChild(addChip);
    }
  }
  function addPinnedFlow(){
    const available = state.projects.filter(p=> !state.pinned.includes(p.id));
    if (!available.length){ alert('–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.'); return; }
    const lines = available.map((p,i)=> `${i+1}) ${p.name}`).join('\n');
    const ans = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è (–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä):\n${lines}`);
    const idx = parseInt(ans,10)-1;
    if (Number.isInteger(idx) && idx>=0 && idx<available.length){
      state.pinned.push(available[idx].id);
      state.pinned = state.pinned.slice(0,6);
      save(); renderPinnedStrip();
    }
  }

  /* ========= –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤ ========= */
  function showView(view){
    state.view = view;
    viewContents.forEach(el=> el.classList.toggle('hidden', el.id !== `${view}-view`));
    viewSelectors.forEach(btn=>{
      btn.classList.remove('btn-main','text-[var(--button-text)]');
      if (btn.dataset.view === view) btn.classList.add('btn-main');
    });
    if (view==='calendar') renderCalendar();
    if (view==='kanban') renderKanban();
    if (view==='list') renderList();
  }
  viewSelectors.forEach(b=> b.addEventListener('click', ()=> showView(b.dataset.view)));

  /* ========= –ü–æ–∏—Å–∫/–§–∏–ª—å—Ç—Ä—ã/–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ========= */
  searchButton.addEventListener('click', ()=> { openCommandPalette(); commandInput.value=''; commandInput.placeholder='–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...'; });
  if (searchInput) searchInput.addEventListener('input', ()=>{ state.search = searchInput.value.trim().toLowerCase(); renderAll(); });

  filterButton.addEventListener('click', (e)=>{
    filterPanel.style.left = 'auto';
    filterPanel.style.right = '0';
    filterPanel.classList.toggle('hidden');
    sortPanel.classList.add('hidden');
    e.stopPropagation();
  });
  [filterDue, filterPriority, filterStatus].forEach(elm=>{
    elm.addEventListener('change', ()=>{ state.filters.due=filterDue.value; state.filters.priority=filterPriority.value; state.filters.status=filterStatus.value; renderAll(); });
  });

  sortButton.addEventListener('click', (e)=>{
    sortPanel.style.left = 'auto';
    sortPanel.style.right = '0';
    sortPanel.classList.toggle('hidden');
    filterPanel.classList.add('hidden');
    e.stopPropagation();
  });
  sortSelect.addEventListener('change', ()=>{ state.sort = sortSelect.value; renderAll(); });
  document.addEventListener('click', ()=>{ filterPanel.classList.add('hidden'); sortPanel.classList.add('hidden'); });

  /* ========= –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ ========= */
  quickAddInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      e.preventDefault();
      const raw = quickAddInput.value.trim();
      if (!raw) return;
      const parsed = parseQuickAdd(raw);
      state.tasks.unshift({
        id: uid(),
        title: parsed.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        priority: parsed.priority || 'medium',
        status: 'backlog',
        project: parsed.project || (state.projects[0]?.id || ''),
        dueDate: parsed.dueDate || '',
        description: '',
        tags: parsed.tags || [],
        subtasks: [],
        subtasksDone: [],
        completed: false,
        createdAt: nowISO()
      });
      save();
      quickAddInput.value = '';
      renderAll();
    }
  });

  function parseQuickAdd(text){
    let t = ' ' + text + ' ';
    const res = { title:'', priority:'medium', dueDate:'', project:'', tags:[] };

    const tagRe = /#([\p{L}\p{N}_-]+)/giu;
    const tags = [];
    t = t.replace(tagRe, (_,m)=>{ tags.push(m); return ' '; });
    res.tags = tags;

    const projRe = /@([\p{L}\p{N}\s_-]+)/giu;
    let projName = '';
    t = t.replace(projRe, (_,m)=>{ projName = m.trim(); return ' '; });
    if (projName) {
      let proj = state.projects.find(p=>p.name.toLowerCase()===projName.toLowerCase());
      if (!proj) {
        const id = projName.toLowerCase().replace(/\s+/g,'-');
        const color = '#f59e0b';
        proj = { id, name: projName, color };
        state.projects.push(proj);
        hydrateProjectSelector();
        hydrateTaskProjectSelect();
      }
      res.project = proj.id;
    }

    const low = t.toLowerCase();
    if (low.includes('/—Å–µ–≥–æ–¥–Ω—è')) { res.dueDate = todayISO(0); t = t.replace('/—Å–µ–≥–æ–¥–Ω—è',' '); }
    if (low.includes('/–∑–∞–≤—Ç—Ä–∞')) { res.dueDate = todayISO(1); t = t.replace('/–∑–∞–≤—Ç—Ä–∞',' '); }
    ['/–ø–Ω','/–≤—Ç','/—Å—Ä','/—á—Ç','/–ø—Ç','/—Å–±','/–≤—Å'].forEach(tok=>{
      if (low.includes(tok)) {
        const idx = parseRussianWeekdayToken(tok);
        if (idx!==null) res.dueDate = nextWeekdayISO(idx);
        t = t.replace(tok,' ');
      }
    });

    if (low.includes('/–∫—Ä–∏—Ç–∏—á–Ω–æ')) { res.priority = 'critical'; t = t.replace('/–∫—Ä–∏—Ç–∏—á–Ω–æ',' '); }
    if (low.includes('/–≤—ã—Å–æ–∫–∏–π') || low.includes('/–≤–∞–∂–Ω–æ')) { res.priority = 'high'; t = t.replace('/–≤—ã—Å–æ–∫–∏–π',' ').replace('/–≤–∞–∂–Ω–æ',' '); }
    if (low.includes('/—Å—Ä–µ–¥–Ω–∏–π')) { res.priority = 'medium'; t = t.replace('/—Å—Ä–µ–¥–Ω–∏–π',' '); }
    if (low.includes('/–Ω–∏–∑–∫–∏–π')) { res.priority = 'low'; t = t.replace('/–Ω–∏–∑–∫–∏–π',' '); }

    res.title = t.replace(/\s+/g,' ').trim();
    return res;
  }

  /* ========= –ö–æ–º–∞–Ω–¥–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ ========= */
  function openCommandPalette(){ commandPalette.classList.remove('hidden'); commandInput.focus(); }
  function closeCommandPalette(){ commandPalette.classList.add('hidden'); }
  commandOptions.forEach(opt=>{
    opt.addEventListener('click', ()=>{
      const label = opt.querySelector('.font-medium').textContent;
      closeCommandPalette();
      if(label.includes('–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É')) openTaskModal();
      else if(label.includes('–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç')) openProjectModal();
      else if(label.includes('–°–ø–∏—Å–æ–∫')) showView('list');
      else if(label.includes('–î–æ—Å–∫—É')) showView('kanban');
      else if(label.includes('–ö–∞–ª–µ–Ω–¥–∞—Ä—å')) showView('calendar');
      else if(label.includes('–ü–æ–∏—Å–∫')) { if (searchInput) searchInput.focus(); }
    });
  });
  commandPalette.addEventListener('click', (e)=>{ if(e.target===commandPalette) closeCommandPalette(); });

  /* ========= –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è/–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ========= */
  function getFilteredTasks(){
    const q = state.search;
    const proj = projectSelector.value;
    const { due, priority, status } = state.filters;

    let arr = state.tasks.filter(t=>{
      if (proj!=='all' && t.project!==proj) return false;
      if (q) {
        const hay = (t.title+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (due!=='all') {
        const today = new Date(todayISO(0)+'T00:00:00');
        const d = t.dueDate ? new Date(t.dueDate+'T00:00:00') : null;
        if (due==='today' && (!d || d.toDateString()!==today.toDateString())) return false;
        if (due==='week') {
          const s = startOfWeek(today), e = endOfWeek(today);
          if (!d || d<s || d>e) return false;
        }
        if (due==='overdue') {
          if (!t.dueDate) return false;
          if (t.completed) return false;
          if (new Date(t.dueDate+'T00:00:00') >= today) return false;
        }
      }
      if (priority!=='all' && t.priority!==priority) return false;
      if (status!=='all' && t.status!==status) return false;
      return true;
    });

    const prRank = { critical:3, high:2, medium:1, low:0 };
    const stRank = { 'backlog':0,'in-progress':1,'review':2,'done':3 };
    const cmp = {
      'due-asc': (a,b)=> (a.dueDate||'9999') < (b.dueDate||'9999') ? -1 : (a.dueDate||'9999') > (b.dueDate||'9999') ? 1 : 0,
      'due-desc': (a,b)=> (a.dueDate||'0000') > (b.dueDate||'0000') ? -1 : (a.dueDate||'0000') < (b.dueDate||'0000') ? 1 : 0,
      'priority-desc': (a,b)=> prRank[b.priority]-prRank[a.priority],
      'priority-asc': (a,b)=> prRank[a.priority]-prRank[b.priority],
      'project-asc': (a,b)=> projectName(a.project).localeCompare(projectName(b.project),'ru'),
      'status-asc': (a,b)=> stRank[a.status]-stRank[b.status],
      'title-asc': (a,b)=> a.title.localeCompare(b.title,'ru')
    }[state.sort] || (()=>0);

    arr.sort(cmp);
    return arr;
  }

  /* ========= –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ========= */
  function renderStats(){
    const total = state.tasks.length;
    const todayStr = todayISO(0);
    const doneToday = state.tasks.filter(t=> t.completed && (t.completedAt||'').slice(0,10)===todayStr).length;
    const sWeek = startOfWeek(); const eWeek = endOfWeek();
    const doneWeek = state.tasks.filter(t=>{
      if (!t.completedAt) return false;
      const d = new Date(t.completedAt);
      return d>=sWeek && d<=eWeek;
    }).length;
    const overdue = state.tasks.filter(t=> t.dueDate && !t.completed && t.dueDate < todayStr).length;

    statsBar.innerHTML = '';
    [
      { label:'–í—Å–µ–≥–æ –∑–∞–¥–∞—á', value: total, icon:'fa-list' },
      { label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è', value: doneToday, icon:'fa-check-circle' },
      { label:'–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é', value: doneWeek, icon:'fa-calendar-check' },
      { label:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ', value: overdue, icon:'fa-clock' },
    ].forEach(s=>{
      const el = document.createElement('div');
      el.className = 'bg-secondary rounded-xl p-3 md:p-4 flex items-center gap-3';
      el.innerHTML = `
        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-[var(--bg)] border border-secondary">
          <i class="fas ${s.icon}"></i>
        </div>
        <div><div class="text-xs text-hint">${s.label}</div><div class="text-lg font-semibold">${s.value}</div></div>
      `;
      statsBar.appendChild(el);
    });
  }

  /* ========= –°–ø–∏—Å–æ–∫ ========= */
  function renderList(){
    const tasks = getFilteredTasks();
    listContainer.innerHTML = '';
    if (tasks.length===0){ emptyState.classList.remove('hidden'); return; }
    emptyState.classList.add('hidden');

    tasks.forEach(t=>{
      const project = projectById(t.project);
      const badgeStyle = project ? `style="background:${rgba(project.color,.15)};color:${textColorForBg(project.color)};border:1px solid ${rgba(project.color,.35)}"` : '';
      const doneSub = (t.subtasksDone||[]).filter(Boolean).length;
      const totalSub = (t.subtasks||[]).length;
      const progressPct = totalSub ? Math.round(doneSub/totalSub*100) : 0;

      const card = document.createElement('div');
      card.className = 'task-card bg-secondary rounded-lg p-4 relative';
      card.dataset.id = t.id;

      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="flex items-start gap-3">
            <div class="mt-1">
              <input type="checkbox" ${t.completed?'checked':''} data-act="toggle" data-id="${t.id}" class="rounded border-secondary text-[var(--button)] focus:ring-[var(--button)]">
            </div>
            <div class="w-full">
              <h3 class="font-medium ${t.completed?'line-through opacity-70':''}" data-act="inline-title" data-id="${t.id}">${escapeHtml(t.title)}</h3>
              <p class="text-sm text-hint mt-1">${t.dueDate?('–°—Ä–æ–∫: '+fmtDateHuman(t.dueDate)):'–ë–µ–∑ —Å—Ä–æ–∫–∞'}</p>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="${priorityClass(t.priority)} text-xs px-2 py-1 rounded-full">${priorityRu(t.priority)}</span>
                <span class="${statusClass(t.status)} text-xs px-2 py-1 rounded-full">${statusRu(t.status)}</span>
                ${project ? `<span class="text-xs px-2 py-1 rounded-full" ${badgeStyle}>${project.name}</span>` : ''}
                ${(t.tags||[]).map(tag=>`<span class="bg-[var(--bg)] border border-secondary text-xs px-2 py-1 rounded-full">${escapeHtml(tag)}</span>`).join('')}
              </div>
              ${ totalSub ? `
                <div class="mt-3">
                  <div class="progress-wrap" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥–∑–∞–¥–∞—á">
                    <div class="progress-bar" style="width:${progressPct}%"></div>
                  </div>
                  <div class="text-xs text-hint mt-1">${doneSub}/${totalSub} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                  <div class="mt-2 space-y-1">
                    ${t.subtasks.map((s,i)=>`
                      <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" class="subtask-checkbox" data-act="toggle-subtask" data-id="${t.id}" data-idx="${i}" ${t.subtasksDone?.[i]?'checked':''}>
                        <span class="subtask-label">${escapeHtml(s)}</span>
                      </label>
                    `).join('')}
                  </div>
                </div>
              ` : '' }
            </div>
          </div>
          <div class="flex flex-col items-end gap-1">
            <button class="text-hint hover:text-[var(--text)]" data-act="edit" data-id="${t.id}" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="fas fa-pen"></i></button>
            <button class="text-red-500 hover:text-red-600" data-act="delete" data-id="${t.id}" aria-label="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `;
      listContainer.appendChild(card);
      attachSwipeHandlers(card, t.id);
    });

    listContainer.querySelectorAll('.task-card').forEach(card=>{
      card.addEventListener('click', (e)=>{
        if (e.target.closest('button, input, textarea, select, .subtask-checkbox')) return;
        listContainer.querySelectorAll('.task-card').forEach(c=>c.classList.remove('selected'));
        card.classList.add('selected');
        state.selectedTaskId = card.dataset.id;
      });
    });

    listContainer.querySelectorAll('[data-act="toggle"]').forEach(inp=>{
      inp.addEventListener('click', e=> e.stopPropagation());
      inp.addEventListener('change', ()=>{
        const t = state.tasks.find(x=>x.id===inp.dataset.id);
        if (t){
          t.completed = inp.checked;
          if (t.completed){ t.status='done'; t.completedAt = nowISO(); }
          else { if (t.status==='done') t.status='backlog'; t.completedAt = undefined; }
          save(); renderAll();
        }
      });
    });

    listContainer.querySelectorAll('[data-act="inline-title"]').forEach(elm=>{
      elm.addEventListener('click', ()=>{
        const id = elm.dataset.id;
        const t = state.tasks.find(x=>x.id===id);
        if (!t) return;
        if (elm.querySelector('input')) return;
        const input = document.createElement('input');
        input.type='text';
        input.value = t.title;
        input.className = 'title-input';
        elm.replaceWith(input);
        input.focus();
        input.select();
        const commit = ()=>{
          const newTitle = input.value.trim() || t.title;
          t.title = newTitle;
          save(); renderList();
        };
        input.addEventListener('keydown', (e)=>{
          if (e.key==='Enter') commit();
          if (e.key==='Escape') renderList();
        });
        input.addEventListener('blur', commit);
      });
    });

    listContainer.querySelectorAll('[data-act="edit"]').forEach(b=> b.addEventListener('click', (e)=>{
      e.stopPropagation();
      const t = state.tasks.find(x=>x.id===b.dataset.id);
      if (t) openTaskModal(t);
    }));

    listContainer.querySelectorAll('[data-act="delete"]').forEach(b=> b.addEventListener('click', (e)=>{
      e.stopPropagation();
      const t = state.tasks.find(x=>x.id===b.dataset.id);
      if (t && confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); save(); renderAll(); }
    }));

    listContainer.querySelectorAll('[data-act="toggle-subtask"]').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const id = ch.dataset.id;
        const idx = +ch.dataset.idx;
        const t = state.tasks.find(x=>x.id===id);
        if (!t) return;
        if (!Array.isArray(t.subtasksDone)) t.subtasksDone = [];
        t.subtasksDone[idx] = ch.checked;
        save(); renderList();
      });
    });
  }

  function attachSwipeHandlers(card, id){
    let startX=0, currentX=0, swiping=false;
    card.addEventListener('touchstart', (e)=>{ startX = e.touches[0].clientX; swiping=true; card.style.transition='transform .0s, opacity .0s'; }, {passive:true});
    card.addEventListener('touchmove', (e)=>{
      if(!swiping) return;
      currentX = e.touches[0].clientX;
      const dx = currentX - startX;
      card.style.transform = `translateX(${dx}px)`;
      card.style.opacity = `${Math.max(0.5, 1 - Math.abs(dx)/280)}`;
    }, {passive:true});
    card.addEventListener('touchend', ()=>{
      if(!swiping) return;
      const dx = currentX - startX;
      card.style.transition='transform .18s, opacity .18s';
      card.style.transform='translateX(0)';
      card.style.opacity='1';
      swiping=false;
      if (dx > 80){
        const t = state.tasks.find(x=>x.id===id);
        if (t){ t.completed = true; t.status='done'; t.completedAt = nowISO(); save(); renderAll(); }
      } else if (dx < -80){
        const t = state.tasks.find(x=>x.id===id);
        if (t && confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')){ state.tasks = state.tasks.filter(x=>x.id!==id); save(); renderAll(); }
      }
    });
  }

  function priorityClass(p){ return ({low:'priority-low',medium:'priority-medium',high:'priority-high',critical:'priority-critical'})[p]; }
  function statusClass(s){ return ({'backlog':'status-backlog','in-progress':'status-in-progress','review':'status-review','done':'status-done'})[s]; }

  /* ========= –ö–∞–Ω–±–∞–Ω ========= */
  function renderKanban(){
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(col=>{
      const body = col.querySelector('.column-body');
      body.innerHTML = '';
      const status = col.getAttribute('data-col');
      const tasks = getFilteredTasks().filter(t=>t.status===status);
      tasks.forEach(t=>{
        const project = projectById(t.project);
        const badgeStyle = project ? `style="background:${rgba(project.color,.15)};color:${textColorForBg(project.color)};border:1px solid ${rgba(project.color,.35)}"` : '';
        const card = document.createElement('div');
        card.className='task-card bg-[var(--bg)] rounded-lg p-3 cursor-move';
        card.draggable=true;
        card.dataset.id = t.id;
        card.innerHTML = `
          <div class="flex justify-between gap-2">
            <div class="${t.completed?'line-through opacity-70':''}">
              <h4 class="font-medium" data-act="inline-title" data-id="${t.id}">${escapeHtml(t.title)}</h4>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="${priorityClass(t.priority)} text-xs px-2 py-1 rounded-full">${priorityRu(t.priority)}</span>
                ${project ? `<span class="text-xs px-2 py-1 rounded-full" ${badgeStyle}>${project.name}</span>` : ''}
              </div>
              <div class="text-xs text-hint mt-1">${t.dueDate? '–°—Ä–æ–∫: '+fmtDateHuman(t.dueDate):'–ë–µ–∑ —Å—Ä–æ–∫–∞'}</div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <button class="text-hint hover:text-[var(--text)]" data-act="edit" data-id="${t.id}" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="fas fa-pen"></i></button>
              <button class="text-red-500 hover:text-red-600" data-act="delete" data-id="${t.id}" aria-label="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        body.appendChild(card);
      });
    });
    ['backlog','in-progress','review','done'].forEach(s=>{
      const cntEl = document.getElementById('cnt-'+s);
      if (cntEl) cntEl.textContent = state.tasks.filter(t=>t.status===s).length;
    });

    document.querySelectorAll('.kanban-column .task-card').forEach(card=>{
      card.addEventListener('dragstart', ()=> card.classList.add('opacity-50'));
      card.addEventListener('dragend', ()=> card.classList.remove('opacity-50'));
    });
    document.querySelectorAll('.kanban-column').forEach(col=>{
      col.addEventListener('dragover', (e)=>{ e.preventDefault(); col.classList.add('bg-opacity-50'); });
      col.addEventListener('dragleave', ()=> col.classList.remove('bg-opacity-50'));
      col.addEventListener('drop', (e)=>{
        e.preventDefault(); col.classList.remove('bg-opacity-50');
        const dragged = document.querySelector('.kanban-column .task-card.opacity-50');
        const status = col.getAttribute('data-col');
        if(!dragged) return;
        const id = dragged.dataset.id;
        const t = state.tasks.find(x=>x.id===id);
        if(t){ t.status = status; if(status==='done'){ t.completed=true; t.completedAt=nowISO(); } else { t.completed=false; t.completedAt=undefined; } save(); renderKanban(); renderList(); renderCalendar(); }
      });
    });

    document.querySelectorAll('#kanban-view [data-act="inline-title"]').forEach(elm=>{
      elm.addEventListener('click', ()=>{
        const id = elm.dataset.id;
        const t = state.tasks.find(x=>x.id===id);
        if (!t || elm.querySelector('input')) return;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = t.title;
        input.className = 'title-input';
        elm.replaceWith(input);
        input.focus(); input.select();
        const commit = ()=>{ t.title = input.value.trim() || t.title; save(); renderKanban(); };
        input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') commit(); if (e.key==='Escape') renderKanban(); });
        input.addEventListener('blur', commit);
      });
    });

    document.querySelectorAll('#kanban-view [data-act="edit"]').forEach(b=> b.addEventListener('click', ()=>{
      const t = state.tasks.find(x=>x.id===b.dataset.id);
      if (t) openTaskModal(t);
    }));
    document.querySelectorAll('#kanban-view [data-act="delete"]').forEach(b=> b.addEventListener('click', ()=>{
      const t = state.tasks.find(x=>x.id===b.dataset.id);
      if (t && confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')){ state.tasks = state.tasks.filter(x=>x.id!==t.id); save(); renderAll(); }
    }));
  }

  /* ========= –ö–∞–ª–µ–Ω–¥–∞—Ä—å ========= */
  const WEEKDAYS = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
  const MONTHS_NOM = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

  function renderCalendar(){
    weekdayRow.innerHTML = '';
    WEEKDAYS.forEach(w=>{
      const div = document.createElement('div');
      div.className = 'text-center text-sm font-medium py-2';
      div.textContent = w;
      weekdayRow.appendChild(div);
    });

    const d = new Date(state.currentMonth);
    d.setDate(1);
    const month = d.getMonth();
    const year = d.getFullYear();
    monthTitle.textContent = `${MONTHS_NOM[month]} ${year}`;

    let startIdx = (d.getDay() + 6) % 7;
    const daysInMonth = new Date(year, month+1, 0).getDate();

    calendarGrid.innerHTML = '';
    for(let i=0;i<startIdx;i++){
      const cell = document.createElement('div');
      cell.className = 'calendar-day border border-secondary rounded p-1 opacity-50';
      calendarGrid.appendChild(cell);
    }
    const todayStr = todayISO(0);
    for(let day=1; day<=daysInMonth; day++){
      const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = 'calendar-day border border-secondary rounded p-1';
      cell.dataset.date = iso;
      if (iso===todayStr) cell.classList.add('today');

      cell.innerHTML = `<div class="text-right text-sm mb-1 ${iso===todayStr?'font-bold':''}">${day}</div>`;

      const tasks = getFilteredTasks().filter(t=>t.dueDate===iso);
      tasks.slice(0,6).forEach(t=>{
        const badge = document.createElement('div');
        badge.className = `text-xs truncate px-1 py-0.5 rounded mb-1 ${t.status==='done'?'bg-green-100 text-green-800':'bg-blue-100 text-blue-800'}`;
        badge.textContent = t.title;
        badge.draggable = true;
        badge.dataset.id = t.id;
        badge.addEventListener('dragstart', (e)=>{
          e.dataTransfer.setData('text/task-id', t.id);
          e.dataTransfer.effectAllowed = 'move';
        });
        cell.appendChild(badge);
      });
      if (tasks.length>6){
        const more = document.createElement('div');
        more.className='text-hint text-xs px-1';
        more.textContent = `+ –µ—â—ë ${tasks.length-6}`;
        cell.appendChild(more);
      }

      cell.addEventListener('dragover', (e)=>{ e.preventDefault(); cell.classList.add('dragover'); });
      cell.addEventListener('dragleave', ()=> cell.classList.remove('dragover'));
      cell.addEventListener('drop', (e)=>{
        e.preventDefault();
        cell.classList.remove('dragover');
        const id = e.dataTransfer.getData('text/task-id');
        if(!id) return;
        const t = state.tasks.find(x=>x.id===id);
        if(!t) return;
        t.dueDate = cell.dataset.date || '';
        save(); renderCalendar(); renderList();
      });

      cell.addEventListener('click', (ev)=>{
        if (ev.target && ev.target.getAttribute('draggable') === 'true') return;
        openTaskModal(null, iso);
      });
      calendarGrid.appendChild(cell);
    }
  }
  prevMonth.addEventListener('click', ()=>{ const d=new Date(state.currentMonth); d.setMonth(d.getMonth()-1); state.currentMonth=d; renderCalendar(); });
  nextMonth.addEventListener('click', ()=>{ const d=new Date(state.currentMonth); d.setMonth(d.getMonth()+1); state.currentMonth=d; renderCalendar(); });
  todayButton.addEventListener('click', ()=>{ state.currentMonth = new Date(); renderCalendar(); });

  /* ========= –ú–æ–¥–∞–ª–∫–∞ –∑–∞–¥–∞—á–∏ ========= */
  addTaskButtons.forEach(b=> b.addEventListener('click', ()=> openTaskModal()));
  function openTaskModal(task=null, prefillDate=null){
    taskModal.classList.remove('hidden');
    taskModalTitle.textContent = task ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É' : '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
    document.getElementById('task-id').value = task?.id || '';
    document.getElementById('task-title').value = task?.title || '';
    document.getElementById('task-priority').value = task?.priority || 'medium';
    document.getElementById('task-status').value = task?.status || 'backlog';
    document.getElementById('task-project').value = task?.project || state.projects[0]?.id || '';
    document.getElementById('task-due-date').value = prefillDate || (task?.dueDate || '');
    document.getElementById('task-description').value = task?.description || '';
    document.getElementById('task-subtasks').value = (task?.subtasks||[]).join('\n');
    document.getElementById('task-tags').value = (task?.tags||[]).join(', ');
  }
  function closeTaskModalFunc(){ taskModal.classList.add('hidden'); }
  [closeTaskModal, cancelTask, taskBackdrop].forEach(x=> x.addEventListener('click', closeTaskModalFunc));

  saveTaskBtn.addEventListener('click', ()=>{
    const id = document.getElementById('task-id').value;
    const title = document.getElementById('task-title').value.trim();
    if(!title){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏'); return; }
    const priority = document.getElementById('task-priority').value;
    const status = document.getElementById('task-status').value;
    const project = document.getElementById('task-project').value;
    const dueDate = document.getElementById('task-due-date').value;
    const description = document.getElementById('task-description').value.trim();
    const subtasksRaw = document.getElementById('task-subtasks').value;
    const tagsRaw = document.getElementById('task-tags').value;

    const subtasks = subtasksRaw.split('\n').map(s=>s.trim()).filter(Boolean);
    let subtasksDone = subtasks.map(()=>false);

    if(id){
      const t = state.tasks.find(t=>t.id===id);
      if(t){
        const mapPrev = new Map((t.subtasks||[]).map((s,i)=>[s, (t.subtasksDone||[])[i] || false]));
        subtasksDone = subtasks.map(s=> mapPrev.get(s) || false);
        Object.assign(t,{title,priority,status,project,dueDate,description,subtasks,subtasksDone,completed: status==='done', completedAt: status==='done'? (t.completedAt||nowISO()): undefined});
      }
    } else {
      state.tasks.unshift({
        id: uid(), title, priority, status, project, dueDate, description, tags: tagsRaw.split(',').map(s=>s.trim()).filter(Boolean),
        subtasks, subtasksDone,
        completed: status==='done', createdAt: nowISO(), completedAt: status==='done'? nowISO(): undefined
      });
    }
    save(); closeTaskModalFunc(); renderAll();
  });

  /* ========= –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ ========= */
  document.addEventListener('keydown', (e)=>{
    const activeTag = (document.activeElement?.tagName || '').toLowerCase();
    const typing = ['input','textarea'].includes(activeTag) && document.activeElement?.type!=='button';

    if ((e.key==='n' || e.key==='N') && !e.ctrlKey && !e.metaKey && !typing){
      e.preventDefault(); openTaskModal(); return;
    }
    if ((e.key.toLowerCase()==='k') && (e.ctrlKey || e.metaKey)){
      e.preventDefault(); openCommandPalette(); return;
    }
    if ((e.key==='f' || e.key==='F') && !e.ctrlKey && !e.metaKey){
      if (searchInput && !typing){ e.preventDefault(); searchInput.focus(); }
      return;
    }
    if (!typing && (e.key==='1' || e.key==='2' || e.key==='3')){
      e.preventDefault();
      const map = { '1':'list', '2':'kanban', '3':'calendar' };
      showView(map[e.key]);
      return;
    }
    if (e.key==='Delete' && !typing){
      if (state.selectedTaskId){
        const t = state.tasks.find(x=>x.id===state.selectedTaskId);
        if (t && confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${t.title}¬ª?`)){
          state.tasks = state.tasks.filter(x=>x.id!==t.id);
          state.selectedTaskId = null;
          save(); renderAll();
        }
      }
    }
    if (e.key==='Escape'){
      closeCommandPalette();
    }
  });

  /* ========= PWA Badging ========= */
  function updateAppBadge(){
    const remain = state.tasks.filter(t=>!t.completed).length;
    if ('setAppBadge' in navigator && 'clearAppBadge' in navigator) {
      if (remain>0) { navigator.setAppBadge(remain).catch(()=>{}); }
      else { navigator.clearAppBadge().catch(()=>{}); }
    }
  }

  /* ========= –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ========= */
  (function init(){
    load();
    hydrateProjectSelector();
    hydrateTaskProjectSelect();
    renderPinnedStrip();
    showView('list');
    renderAll();
    updateAppBadge();
    buildThemeCards();
    injectAdminMenuButton();
    fetchPremiumStatus();
  })();

})(); // end IIFE
</script>
</body>
</html>
