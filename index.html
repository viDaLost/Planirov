<!DOCTYPE html>
<html lang="ru" data-theme="glass">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Task Master Premium</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', '-apple-system', 'system-ui', 'sans-serif'] },
          colors: {
            glass: {
              bg: '#09090b',         /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
              panel: 'rgba(24, 24, 27, 0.6)', /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–∞–Ω–µ–ª—å */
              border: 'rgba(255, 255, 255, 0.08)',
              highlight: 'rgba(255, 255, 255, 0.03)',
              text: '#e4e4e7',
              muted: '#a1a1aa',
              accent: '#3b82f6',     /* –°–∏–Ω–∏–π –Ω–µ–æ–Ω */
              success: '#10b981',
              danger: '#ef4444'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out forwards',
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    body {
      background-color: #000;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.08), transparent 25%), 
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08), transparent 25%);
      color: #e4e4e7;
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow: hidden; /* App-like feel */
    }

    /* Glassmorphism Classes */
    .glass-panel {
      background: var(--tw-colors-glass-panel);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--tw-colors-glass-border);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
    
    .glass-input {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      transition: all 0.2s;
    }
    .glass-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      outline: none;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    /* Hide standard checkboxes */
    .custom-check {
      appearance: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #52525b;
      border-radius: 50%;
      display: grid;
      place-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .custom-check::before {
      content: "";
      width: 0.65rem;
      height: 0.65rem;
      transform: scale(0);
      transition: 120ms transform ease-in-out;
      box-shadow: inset 1em 1em white;
      transform-origin: center;
      clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }
    .custom-check:checked {
      background-color: #3b82f6;
      border-color: #3b82f6;
    }
    .custom-check:checked::before { transform: scale(1); }

    /* Animations */
    .premium-shimmer {
      background: linear-gradient(90deg, #ffd700, #fff3b0, #ffd700);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 3s linear infinite;
      font-weight: 700;
    }
    @keyframes shine { to { background-position: 200% center; } }

    /* Layout tweaks */
    .view-container { height: calc(100vh - 80px - var(--safe-area-top) - var(--safe-area-bottom)); overflow-y: auto; padding-bottom: 80px; }
  </style>
</head>
<body class="h-screen flex flex-col">

<div id="app" class="flex-1 flex flex-col relative max-w-2xl mx-auto w-full h-full shadow-2xl overflow-hidden bg-glass-bg">
  
  <header class="glass-panel sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b-0 border-b-glass-border">
    <div class="flex items-center gap-3">
      <div id="avatar-container" class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-blue-500/20 cursor-pointer">
        G
      </div>
      <div>
        <h1 class="text-base font-semibold leading-tight tracking-wide">Task Master</h1>
        <div id="premium-indicator" class="text-[10px] uppercase tracking-wider text-glass-muted">Basic Plan</div>
      </div>
    </div>
    <div class="flex gap-2">
      <button id="btn-focus" class="w-9 h-9 rounded-full glass-panel flex items-center justify-center text-glass-text hover:text-white transition active:scale-95" title="–§–æ–∫—É—Å —Ä–µ–∂–∏–º">
        <i class="fas fa-stopwatch"></i>
      </button>
      <button id="btn-settings" class="w-9 h-9 rounded-full glass-panel flex items-center justify-center text-glass-text hover:text-white transition active:scale-95">
        <i class="fas fa-cog"></i>
      </button>
    </div>
  </header>

  <main id="main-content" class="flex-1 relative overflow-hidden">
    
    <div id="view-dashboard" class="view-container px-4 py-4 space-y-6 animate-fade-in">
      
      <div class="flex justify-between items-end mb-2">
        <div>
          <h2 class="text-2xl font-bold text-white">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
          <p class="text-sm text-glass-muted" id="date-display">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 12 –º–∞—è</p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-blue-400" id="stat-done">0/0</div>
          <div class="text-[10px] text-glass-muted uppercase">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>
      </div>

      <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
        <button data-filter="all" class="filter-btn active px-4 py-1.5 rounded-full text-xs font-medium glass-panel bg-white/10 text-white border-white/20">–í—Å–µ</button>
        <button data-filter="today" class="filter-btn px-4 py-1.5 rounded-full text-xs font-medium glass-panel text-glass-muted">–°–µ–≥–æ–¥–Ω—è</button>
        <button data-filter="high" class="filter-btn px-4 py-1.5 rounded-full text-xs font-medium glass-panel text-glass-muted">–í–∞–∂–Ω—ã–µ</button>
        <button id="btn-add-habit" class="ml-auto px-3 py-1.5 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><i class="fas fa-plus mr-1"></i> –ü—Ä–∏–≤—ã—á–∫–∞</button>
      </div>

      <div id="habits-section" class="hidden">
        <h3 class="text-xs font-bold text-glass-muted uppercase mb-2 tracking-wider">–ü—Ä–∏–≤—ã—á–∫–∏</h3>
        <div id="habits-grid" class="grid grid-cols-4 gap-2"></div>
      </div>

      <div id="task-list" class="space-y-3 pb-20">
        </div>
      
      <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-glass-muted">
        <i class="fas fa-clipboard-check text-4xl mb-3 opacity-20"></i>
        <p class="text-sm">–ó–∞–¥–∞—á –Ω–µ—Ç. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</p>
      </div>
    </div>

    <div id="view-focus" class="hidden view-container flex flex-col items-center justify-center text-center px-6">
      <div class="w-64 h-64 rounded-full border-4 border-white/5 flex items-center justify-center relative mb-8">
        <svg class="absolute inset-0 w-full h-full transform -rotate-90 text-blue-500" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="46" fill="transparent" stroke="currentColor" stroke-width="4" stroke-dasharray="289" stroke-dashoffset="0" id="timer-progress" class="transition-all duration-1000 ease-linear"></circle>
        </svg>
        <div class="text-5xl font-mono font-bold text-white" id="timer-display">25:00</div>
      </div>
      <h3 class="text-xl font-medium text-white mb-2" id="focus-status">–í—Ä–µ–º—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏</h3>
      <p class="text-sm text-glass-muted mb-8 max-w-xs">–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ. –û—Ç–ª–æ–∂–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</p>
      
      <div class="flex gap-4">
        <button id="timer-toggle" class="w-16 h-16 rounded-full bg-white text-black flex items-center justify-center text-xl shadow-lg hover:scale-105 transition">
          <i class="fas fa-play ml-1"></i>
        </button>
        <button id="timer-reset" class="w-16 h-16 rounded-full glass-panel text-white flex items-center justify-center text-xl hover:bg-white/10 transition">
          <i class="fas fa-redo"></i>
        </button>
      </div>
    </div>

  </main>

  <button id="fab-add" class="absolute bottom-6 right-6 w-14 h-14 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-full shadow-lg shadow-blue-600/40 flex items-center justify-center text-white text-2xl z-30 transition transform hover:scale-110 active:scale-90 ring-4 ring-black/50">
    <i class="fas fa-plus"></i>
  </button>

  <div id="modal-task" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[#18181b] rounded-t-3xl border-t border-glass-border shadow-2xl p-6 animate-slide-up pb-[env(safe-area-inset-bottom,20px)]">
      <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
      
      <input type="text" id="inp-task-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" class="w-full bg-transparent text-xl font-medium text-white placeholder-glass-muted mb-4 border-none focus:ring-0 p-0" autocomplete="off">
      
      <div class="flex gap-3 mb-6">
        <div class="flex-1">
          <label class="block text-xs text-glass-muted mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="inp-task-project" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
            <option value="work">–†–∞–±–æ—Ç–∞</option>
            <option value="personal">–õ–∏—á–Ω–æ–µ</option>
            <option value="shopping">–ü–æ–∫—É–ø–∫–∏</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-xs text-glass-muted mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <div class="flex bg-white/5 rounded-lg p-1 border border-white/10">
            <button data-prio="low" class="prio-select flex-1 py-1 rounded text-xs text-center hover:bg-white/10">Wait</button>
            <button data-prio="high" class="prio-select flex-1 py-1 rounded text-xs text-center text-red-400 bg-white/10 font-bold">ASAP</button>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <button id="btn-save-task" class="w-full py-3.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-medium transition shadow-lg shadow-blue-900/20">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É
        </button>
      </div>
    </div>
  </div>

  <div id="modal-settings" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md"></div>
    <div class="absolute inset-x-4 top-10 bottom-10 glass-panel rounded-2xl overflow-hidden flex flex-col animate-fade-in max-w-lg mx-auto">
      <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
        <h2 class="font-semibold text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <button id="close-settings" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-4 space-y-6">
        
        <div class="glass-panel p-4 rounded-xl bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border-yellow-500/20">
          <div class="flex justify-between items-start mb-2">
            <div>
              <h3 class="text-yellow-500 font-bold text-sm"><i class="fas fa-crown mr-1"></i> Premium Status</h3>
              <p class="text-xs text-glass-muted mt-1" id="settings-prem-status">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</p>
            </div>
            <button id="btn-buy-premium" class="text-xs bg-yellow-500/20 text-yellow-400 px-3 py-1.5 rounded-lg border border-yellow-500/30 hover:bg-yellow-500/30">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
          </div>
        </div>

        <div class="space-y-2">
          <h3 class="text-xs font-bold text-glass-muted uppercase tracking-wider">–î–∞–Ω–Ω—ã–µ</h3>
          <button id="btn-backup" class="w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 flex items-center gap-3 transition">
            <i class="fas fa-cloud-download-alt text-blue-400"></i>
            <div class="flex-1">
              <div class="text-sm font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</div>
              <div class="text-[10px] text-glass-muted">–°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª —Å –∑–∞–¥–∞—á–∞–º–∏</div>
            </div>
          </button>
          <label class="w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 flex items-center gap-3 transition cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-green-400"></i>
            <div class="flex-1">
              <div class="text-sm font-medium">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</div>
              <div class="text-[10px] text-glass-muted">–ó–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
            </div>
            <input type="file" id="inp-restore" class="hidden" accept=".json">
          </label>
        </div>

        <div id="admin-section" class="hidden space-y-2 pt-4 border-t border-white/10">
          <h3 class="text-xs font-bold text-red-400 uppercase tracking-wider">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h3>
          <div class="glass-panel p-4 rounded-xl space-y-3">
            <div class="text-sm font-medium mb-2">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Å—ã–ª–æ–∫ –¥–æ—Å—Ç—É–ø–∞</div>
            <select id="adm-duration" class="w-full glass-input rounded-lg px-3 py-2 text-sm">
              <option value="1">1 –î–µ–Ω—å (–¢–µ—Å—Ç)</option>
              <option value="30">1 –ú–µ—Å—è—Ü</option>
              <option value="365">1 –ì–æ–¥</option>
              <option value="9999">–ù–∞–≤—Å–µ–≥–¥–∞</option>
            </select>
            <button id="adm-gen-link" class="w-full py-2 rounded-lg bg-white text-black font-semibold text-sm hover:bg-gray-200">–°–æ–∑–¥–∞—Ç—å Magic Link</button>
            <div id="adm-result" class="hidden mt-2 p-2 bg-black/40 rounded text-xs break-all font-mono select-all cursor-pointer text-glass-muted"></div>
          </div>
        </div>
        
        <div class="text-center text-[10px] text-glass-muted pt-4">
          ID: <span id="user-id-display">Guest</span> ‚Ä¢ v2.0 Glass
        </div>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  /* ================= CONFIG & CONSTANTS ================= */
  const ADMIN_IDS = [1288379477]; // –í–ø–∏—à–∏—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π ID
  const SECRET_KEY = "TaskMaster_S3cr3t_K3y"; // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!
  const LS_KEY = "tm_data_v2";
  
  const tg = window.Telegram?.WebApp;
  const user = tg?.initDataUnsafe?.user || { id: 0, first_name: 'Guest', username: 'guest' };

  /* ================= STATE MANAGEMENT ================= */
  let state = {
    tasks: [],
    habits: [
      { id: 'h1', icon: 'üíß', name: '–í–æ–¥–∞', doneDates: [] },
      { id: 'h2', icon: 'üìñ', name: '–ß—Ç–µ–Ω–∏–µ', doneDates: [] },
    ],
    premium: { active: false, until: null },
    usedPromoIds: [], // To prevent reuse of same UUID link by same user
    settings: { theme: 'glass' }
  };

  /* ================= PERSISTENCE (AUTO-SAVE) ================= */
  function loadData() {
    try {
      const raw = localStorage.getItem(LS_KEY + `_${user.id}`);
      if (raw) {
        const data = JSON.parse(raw);
        state = { ...state, ...data };
        // Migrate legacy tasks if needed
        if(!state.habits) state.habits = [];
      }
    } catch (e) { console.error("Load failed", e); }
    checkPremiumValidity();
  }

  // Debounced Save
  let saveTimeout;
  function saveData() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      localStorage.setItem(LS_KEY + `_${user.id}`, JSON.stringify(state));
    }, 500); // Save 0.5s after last change
  }

  function backupData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "task_master_backup_" + new Date().toISOString().slice(0,10) + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  function restoreData(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (data.tasks) {
          state = data;
          saveData();
          renderDashboard();
          alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!");
        } else { throw new Error("Invalid format"); }
      } catch (err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞: " + err.message); }
    };
    reader.readAsText(file);
  }

  /* ================= PREMIUM SYSTEM (MAGIC LINKS) ================= */
  // Encryption logic (Simulated for client-side)
  function signData(payload) {
    // Simple mock signature. In real app, use HMAC-SHA256
    return btoa(JSON.stringify(payload) + "|" + SECRET_KEY);
  }

  function verifyLink(token) {
    try {
      const parts = atob(token).split('|');
      if (parts[1] !== SECRET_KEY) return null;
      return JSON.parse(parts[0]);
    } catch { return null; }
  }

  function generatePremiumLink(days) {
    const uuid = Math.random().toString(36).substring(2) + Date.now().toString(36);
    const payload = {
      d: days,    // Duration
      u: uuid,    // Unique ID of this link
      t: Date.now() // Created at
    };
    const token = signData(payload);
    // Format: https://t.me/YourBotName/AppName?startapp=promo_TOKEN
    // For demo we use a query param format if user is not in TG, but TG uses startapp
    return `https://t.me/D_a_n_Vi?startapp=promo__${token}`;
  }

  function checkStartParam() {
    // Check Telegram start_param or URL Query
    let param = tg?.initDataUnsafe?.start_param;
    if (!param) {
      const urlParams = new URLSearchParams(window.location.search);
      param = urlParams.get('startapp');
    }

    if (param && param.startsWith('promo__')) {
      const token = param.split('promo__')[1];
      const data = verifyLink(token);
      
      if (data) {
        if (state.usedPromoIds.includes(data.u)) {
          alert("–≠—Ç–∞ —Å—Å—ã–ª–∫–∞ —É–∂–µ –±—ã–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤–∞–º–∏.");
          return;
        }
        
        // Apply Premium
        const now = new Date();
        const currentEnd = state.premium.until ? new Date(state.premium.until) : now;
        const base = currentEnd > now ? currentEnd : now;
        base.setDate(base.getDate() + parseInt(data.d));
        
        state.premium.active = true;
        state.premium.until = base.toISOString();
        state.usedPromoIds.push(data.u);
        saveData();
        
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        alert(`Premium –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${data.d} –¥–Ω–µ–π!`);
        
        // Clear param to avoid re-trigger on reload (UI only)
        if(history.pushState) {
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.pushState({path:newurl},'',newurl);
        }
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω–∞—è –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞.");
      }
    }
  }

  function checkPremiumValidity() {
    if (state.premium.active && state.premium.until) {
      if (new Date(state.premium.until) < new Date()) {
        state.premium.active = false;
        saveData();
      }
    }
    updatePremiumUI();
  }

  /* ================= UI RENDERERS ================= */
  function renderDashboard() {
    const list = document.getElementById('task-list');
    const doneCountEl = document.getElementById('stat-done');
    const filter = document.querySelector('.filter-btn.active').dataset.filter;
    
    list.innerHTML = '';
    
    const tasks = state.tasks.filter(t => !t.deleted);
    let filtered = tasks;

    // Filter Logic
    const todayStr = new Date().toISOString().slice(0,10);
    if (filter === 'today') filtered = tasks.filter(t => (t.due || '').startsWith(todayStr));
    if (filter === 'high') filtered = tasks.filter(t => t.prio === 'high');

    // Sort: Pending first, then by priority
    filtered.sort((a,b) => {
      if (a.done === b.done) return (b.prio === 'high' ? 1 : 0) - (a.prio === 'high' ? 1 : 0);
      return a.done ? 1 : -1;
    });

    if (filtered.length === 0) {
      document.getElementById('empty-state').classList.remove('hidden');
    } else {
      document.getElementById('empty-state').classList.add('hidden');
      filtered.forEach(task => {
        const el = document.createElement('div');
        // Task Card Styling
        el.className = `glass-panel rounded-xl p-3 flex items-center gap-3 transition-all duration-300 ${task.done ? 'opacity-50' : 'hover:bg-white/5'}`;
        el.innerHTML = `
          <div class="custom-check ${task.done ? 'checked' : ''}" data-id="${task.id}"></div>
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium truncate ${task.done ? 'line-through text-glass-muted' : 'text-white'}">${escapeHtml(task.title)}</div>
            <div class="flex gap-2 mt-1">
              <span class="text-[10px] px-1.5 py-0.5 rounded bg-white/5 text-glass-muted border border-white/5 uppercase tracking-wide">${task.project}</span>
              ${task.prio === 'high' ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-400 border border-red-500/20">–í–∞–∂–Ω–æ</span>' : ''}
            </div>
          </div>
          <button class="text-glass-muted hover:text-red-400 w-8 h-8 flex items-center justify-center transition" onclick="deleteTask('${task.id}')">
            <i class="fas fa-trash-alt text-xs"></i>
          </button>
        `;
        
        // Click Logic
        const check = el.querySelector('.custom-check');
        check.addEventListener('click', () => toggleTask(task.id));
        if (task.done) check.classList.add('checked');
        
        list.appendChild(el);
      });
    }

    // Stats
    const done = tasks.filter(t => t.done).length;
    doneCountEl.textContent = `${done}/${tasks.length}`;
    
    // Habits Render
    renderHabits();
  }

  function renderHabits() {
    const grid = document.getElementById('habits-grid');
    grid.innerHTML = '';
    const today = new Date().toISOString().slice(0,10);
    
    state.habits.forEach(h => {
      const isDone = h.doneDates.includes(today);
      const btn = document.createElement('button');
      btn.className = `flex flex-col items-center justify-center p-2 rounded-xl border transition active:scale-95 ${isDone ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-white/5 border-white/5 hover:bg-white/10'}`;
      btn.innerHTML = `
        <div class="text-xl mb-1 filter ${isDone ? 'grayscale-0' : 'grayscale opacity-70'}">${h.icon}</div>
        <div class="text-[9px] font-medium ${isDone ? 'text-emerald-400' : 'text-glass-muted'}">${h.name}</div>
      `;
      btn.onclick = () => toggleHabit(h.id);
      grid.appendChild(btn);
    });
  }

  /* ================= LOGIC ACTIONS ================= */
  window.toggleTask = (id) => {
    const t = state.tasks.find(x => x.id === id);
    if (t) {
      t.done = !t.done;
      if (t.done) confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#3b82f6', '#ffffff'] });
      saveData();
      renderDashboard();
    }
  };

  window.deleteTask = (id) => {
    if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
      state.tasks = state.tasks.filter(x => x.id !== id);
      saveData();
      renderDashboard();
    }
  };

  function toggleHabit(id) {
    const today = new Date().toISOString().slice(0,10);
    const h = state.habits.find(x => x.id === id);
    if (h) {
      if (h.doneDates.includes(today)) {
        h.doneDates = h.doneDates.filter(d => d !== today);
      } else {
        h.doneDates.push(today);
        confetti({ shapes: ['star'], colors: ['#10b981'] });
      }
      saveData();
      renderHabits();
    }
  }

  function addTask(title, project, prio) {
    state.tasks.unshift({
      id: Math.random().toString(36).substr(2, 9),
      title,
      project,
      prio,
      done: false,
      created: new Date().toISOString()
    });
    saveData();
    renderDashboard();
  }

  /* ================= FOCUS TIMER (POMODORO) ================= */
  let timerInterval;
  let timeLeft = 25 * 60;
  let isTimerRunning = false;

  function updateTimerDisplay() {
    const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
    const s = (timeLeft % 60).toString().padStart(2,'0');
    document.getElementById('timer-display').textContent = `${m}:${s}`;
    
    // Circle progress
    const circle = document.getElementById('timer-progress');
    const radius = 46;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (timeLeft / (25 * 60)) * circumference;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
  }

  function toggleTimer() {
    const btn = document.getElementById('timer-toggle');
    if (isTimerRunning) {
      clearInterval(timerInterval);
      isTimerRunning = false;
      btn.innerHTML = '<i class="fas fa-play ml-1"></i>';
    } else {
      isTimerRunning = true;
      btn.innerHTML = '<i class="fas fa-pause"></i>';
      timerInterval = setInterval(() => {
        if (timeLeft > 0) {
          timeLeft--;
          updateTimerDisplay();
        } else {
          clearInterval(timerInterval);
          isTimerRunning = false;
          btn.innerHTML = '<i class="fas fa-play ml-1"></i>';
          alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –û—Ç–¥–æ—Ö–Ω–∏.");
          confetti();
          timeLeft = 25 * 60;
          updateTimerDisplay();
        }
      }, 1000);
    }
  }

  /* ================= EVENT LISTENERS ================= */
  
  // Navigation (Simple View Switcher)
  document.getElementById('btn-focus').addEventListener('click', () => {
    document.getElementById('view-dashboard').classList.add('hidden');
    document.getElementById('view-focus').classList.remove('hidden');
    document.getElementById('fab-add').classList.add('hidden');
  });

  // Back to Dashboard logic could be added, but for now clicking Header title resets
  document.querySelector('h1').addEventListener('click', () => {
    document.getElementById('view-dashboard').classList.remove('hidden');
    document.getElementById('view-focus').classList.add('hidden');
    document.getElementById('fab-add').classList.remove('hidden');
  });

  // Add Task UI
  const modalTask = document.getElementById('modal-task');
  const inpTitle = document.getElementById('inp-task-title');
  
  document.getElementById('fab-add').addEventListener('click', () => {
    modalTask.classList.remove('hidden');
    inpTitle.focus();
  });
  
  document.getElementById('modal-backdrop').addEventListener('click', () => {
    modalTask.classList.add('hidden');
  });

  let selectedPrio = 'low';
  document.querySelectorAll('.prio-select').forEach(btn => {
    btn.addEventListener('click', (e) => {
      selectedPrio = e.target.dataset.prio;
      document.querySelectorAll('.prio-select').forEach(b => b.classList.remove('ring-2', 'ring-white'));
      e.target.classList.add('ring-2', 'ring-white');
    });
  });

  document.getElementById('btn-save-task').addEventListener('click', () => {
    const title = inpTitle.value.trim();
    if (title) {
      addTask(title, document.getElementById('inp-task-project').value, selectedPrio);
      inpTitle.value = '';
      modalTask.classList.add('hidden');
    }
  });

  // Settings & Admin
  const modalSettings = document.getElementById('modal-settings');
  document.getElementById('btn-settings').addEventListener('click', () => {
    modalSettings.classList.remove('hidden');
    document.getElementById('user-id-display').textContent = `ID: ${user.id}`;
    
    // Check Admin
    if (ADMIN_IDS.includes(user.id)) {
      document.getElementById('admin-section').classList.remove('hidden');
    }
    updatePremiumUI();
  });

  document.getElementById('close-settings').addEventListener('click', () => modalSettings.classList.add('hidden'));

  function updatePremiumUI() {
    const ind = document.getElementById('premium-indicator');
    const st = document.getElementById('settings-prem-status');
    const habits = document.getElementById('habits-section');
    
    if (state.premium.active) {
      ind.textContent = "Premium";
      ind.classList.add('premium-shimmer', 'text-yellow-400');
      st.innerHTML = `–ê–∫—Ç–∏–≤–µ–Ω –¥–æ <span class="text-white">${new Date(state.premium.until).toLocaleDateString()}</span>`;
      st.className = "text-xs text-green-400 mt-1";
      habits.classList.remove('hidden'); // Habits is a Premium feature example
    } else {
      ind.textContent = "Basic";
      ind.classList.remove('premium-shimmer', 'text-yellow-400');
      st.textContent = "–ù–µ –∞–∫—Ç–∏–≤–µ–Ω. –ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.";
      st.className = "text-xs text-glass-muted mt-1";
      habits.classList.add('hidden');
    }
  }

  // Backup / Restore
  document.getElementById('btn-backup').addEventListener('click', backupData);
  document.getElementById('inp-restore').addEventListener('change', function(e) {
    if(this.files[0]) restoreData(this.files[0]);
  });

  // Admin Generator
  document.getElementById('adm-gen-link').addEventListener('click', () => {
    const days = document.getElementById('adm-duration').value;
    const link = generatePremiumLink(days);
    const res = document.getElementById('adm-result');
    res.textContent = link;
    res.classList.remove('hidden');
    navigator.clipboard.writeText(link);
    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
  });

  // Filters
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active', 'bg-white/10', 'text-white', 'border-white/20');
        b.classList.add('text-glass-muted');
      });
      btn.classList.add('active', 'bg-white/10', 'text-white', 'border-white/20');
      btn.classList.remove('text-glass-muted');
      renderDashboard();
    });
  });

  // Focus Timer
  document.getElementById('timer-toggle').addEventListener('click', toggleTimer);
  document.getElementById('timer-reset').addEventListener('click', () => {
    isTimerRunning = false;
    clearInterval(timerInterval);
    timeLeft = 25 * 60;
    updateTimerDisplay();
    document.getElementById('timer-toggle').innerHTML = '<i class="fas fa-play ml-1"></i>';
  });

  document.getElementById('btn-add-habit').addEventListener('click', () => {
    if(!state.premium.active) { alert("–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ Premium"); return; }
    const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏:");
    if(name) {
      state.habits.push({ id: 'h'+Date.now(), name, icon: 'üåü', doneDates:[] });
      saveData();
      renderHabits();
    }
  });

  /* ================= INIT ================= */
  tg?.ready();
  tg?.expand();
  
  // Set theme colors for Telegram header
  tg?.setHeaderColor('#09090b');
  tg?.setBackgroundColor('#09090b');

  // Init
  document.getElementById('date-display').textContent = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
  loadData();
  checkStartParam();
  renderDashboard();
  updateTimerDisplay();

  // Avatar Init
  if (user.first_name) {
    document.getElementById('avatar-container').textContent = user.first_name[0].toUpperCase();
  }

})();

// Escape HTML utility
function escapeHtml(text) {
  if (!text) return text;
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
</script>
</body>
</html>
