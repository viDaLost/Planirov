<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Планировщик задач</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* === ТЕМЫ (light/dark + 5 тёплых градиентных + OLIVE) === */
    :root{
      --bg:#ffffff;
      --text:#111827;
      --hint:#6b7280;
      --secondary:#f3f4f6;
      --button:#2563eb;
      --button-text:#ffffff;
      --ring:rgba(37,99,235,.35);
      --header-gradient:linear-gradient(90deg,#ffffff,#ffffff);
      --badge-ok:#10b981; --badge-warn:#f59e0b; --badge-err:#ef4444;
    }
    html[data-theme="dark"]{
      --bg:#0f1115; --text:#e5e7eb; --hint:#9ca3af; --secondary:#171a21;
      --button:#5b74f9; --button-text:#ffffff; --ring:rgba(91,116,249,.35);
      --header-gradient:linear-gradient(90deg,#10131a,#171a21);
    }
    html[data-theme="sunset"]{
      --bg:#fff7ed; --text:#1f2937; --hint:#6b7280; --secondary:#ffe9d6;
      --button:#f97316; --button-text:#1f2937; --ring:rgba(249,115,22,.35);
      --header-gradient:linear-gradient(90deg,#ffedd5,#fecaca,#fde68a);
    }
    html[data-theme="peach"]{
      --bg:#fff1f2; --text:#1f2937; --hint:#6b7280; --secondary:#ffe4e6;
      --button:#fb7185; --button-text:#1f2937; --ring:rgba(251,113,133,.35);
      --header-gradient:linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68a);
    }
    html[data-theme="sand"]{
      --bg:#faf6f0; --text:#1f2937; --hint:#6b7280; --secondary:#f1ebe2;
      --button:#d97706; --button-text:#111827; --ring:rgba(217,119,6,.35);
      --header-gradient:linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a);
    }
    html[data-theme="coral"]{
      --bg:#fff5f0; --text:#1f2937; --hint:#6b7280; --secondary:#ffe8e0;
      --button:#f43f5e; --button-text:#fff; --ring:rgba(244,63,94,.35);
      --header-gradient:linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5);
    }
    html[data-theme="plum"]{
      --bg:#f9f5ff; --text:#1f2937; --hint:#6b7280; --secondary:#f3e8ff;
      --button:#a855f7; --button-text:#fff; --ring:rgba(168,85,247,.35);
      --header-gradient:linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6);
    }
    html[data-theme="olive"]{
      --bg:#f5f7f2; --text:#1f2937; --hint:#6b7280; --secondary:#e8efe1;
      --button:#7da453; --button-text:#111827; --ring:rgba(125,164,83,.35);
      --header-gradient:linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6);
    }

    /* === БАЗОВЫЕ СТИЛИ === */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg); color:var(--text);
      transition:background-color .25s,color .25s;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Inter',system-ui,sans-serif
    }
    .ring-focus:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .task-card{transition:box-shadow .15s, background-color .15s}
    .task-card:hover{box-shadow:0 4px 10px rgb(0 0 0 /.08)}
    .task-card.selected{outline:2px solid var(--ring); outline-offset:2px}
    .priority-low{background:rgba(52,211,153,.12);color:rgb(16,185,129)}
    .priority-medium{background:rgba(96,165,250,.12);color:rgb(59,130,246)}
    .priority-high{background:rgba(251,191,36,.12);color:rgb(234,179,8)}
    .priority-critical{background:rgba(239,68,68,.12);color:rgb(239,68,68)}
    .status-backlog{background:rgba(156,163,175,.12);color:rgb(156,163,175)}
    .status-in-progress{background:rgba(59,130,246,.12);color:rgb(59,130,246)}
    .status-review{background:rgba(168,85,247,.12);color:rgb(168,85,247)}
    .status-done{background:rgba(16,185,129,.12);color:rgb(16,185,129)}
    .kanban-column{min-height:60vh}
    .calendar-day{min-height:100px}
    .calendar-day.today{outline:2px solid var(--ring);outline-offset:-2px;background:rgba(0,0,0,.04)}
    .calendar-day.dragover{outline:2px dashed var(--ring); outline-offset:-2px}
    .command-palette{backdrop-filter:blur(10px)}
    .subtask-checkbox:checked+.subtask-label{text-decoration:line-through;color:var(--hint)}
    @media (max-width:640px){ .kanban-column{min-height:auto;max-height:60vh;overflow-y:auto} }
    .popover{position:absolute;z-index:30;background:var(--bg);border:1px solid var(--secondary);box-shadow:0 8px 24px rgb(0 0 0 / .12);border-radius:.75rem;min-width:240px}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .progress-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--button);width:0%}
    .title-input{background:transparent;border:1px dashed var(--secondary);padding:2px 6px;border-radius:6px;width:100%}

    .header-gradient{background-image:var(--header-gradient)}
    .bg-secondary{background:var(--secondary)}
    .btn-main{background:var(--button);color:var(--button-text)}
    .border-secondary{border-color:var(--secondary)}
    .text-hint{color:var(--hint)}

    /* Пин-панель проектов */
    .pin-chip{background:var(--secondary); border:1px solid var(--secondary)}
    .pin-chip.dragging{opacity:.5}

    /* === Premium shimmer === */
    .shimmer{
      background: linear-gradient(90deg,#C6A240,#F4E28A,#C6A240);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text;
      color: transparent;
      animation: shine 2.5s linear infinite;
      font-weight: 800;
      letter-spacing:.3px;
    }
    @keyframes shine{
      0%{background-position:0% 50%} 100%{background-position:200% 50%}
    }

    /* Toast */
    .toast{
      position: fixed; left:50%; transform:translateX(-50%);
      bottom: 24px; max-width: 92vw;
      background: var(--bg); border:1px solid var(--secondary);
      box-shadow: 0 10px 30px rgba(0,0,0,.14);
      padding: 10px 14px; border-radius: 12px; z-index: 60; font-size: 14px;
    }
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 border-b border-secondary header-gradient">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="menu-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Открыть меню">
            <i class="fas fa-bars"></i>
          </button>
          <!-- Side menu -->
          <aside id="side-menu" class="hidden fixed top-0 left-0 h-full w-80 bg-[var(--bg)] shadow-xl z-20 border-r border-secondary">
            <div class="p-4 border-b border-secondary flex justify-between items-center">
              <h2 class="text-lg font-semibold">Меню</h2>
              <button id="close-menu" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Закрыть">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Профиль -->
            <div id="profile-box" class="p-4 border-b border-secondary flex items-center gap-3">
              <div id="profile-avatar" class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-sm font-semibold">?</div>
              <div class="min-w-0">
                <div id="profile-name" class="font-medium truncate">Гость</div>
                <div id="profile-username" class="text-xs text-hint truncate">autologin: off</div>
              </div>
            </div>

            <div class="p-3 space-y-1" id="menu-buttons">
              <button id="btn-settings" class="w-full text-left px-4 py-2 rounded-lg hover:bg-secondary">
                <i class="fas fa-gear mr-2"></i>Настройки
              </button>
              <!-- будет добавлена кнопка Премиум -->
              <!-- только для админа добавим кнопку Админ-панель -->
            </div>
          </aside>
        </div>
        <h1 class="text-xl font-semibold">Планировщик задач</h1>

        <!-- Бейдж подписки -->
        <div id="sub-badge" class="ml-3 select-none text-sm px-2 py-1 rounded-lg border border-secondary bg-secondary cursor-default"
             title="Длинное нажатие — показать статус">
          Подписка | <span id="sub-label">Базовая</span>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="search-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Поиск">
          <i class="fas fa-search"></i>
        </button>
        <button id="add-task-button" class="p-2 rounded-full btn-main ring-focus" aria-label="Новая задача">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-4">

    <!-- View Selector -->
    <div class="flex justify-center mb-4">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button data-view="list" class="view-selector px-4 py-2 text-sm font-medium rounded-l-lg border border-secondary hover:bg-secondary">
          <i class="fas fa-list mr-2"></i> Список
        </button>
        <button data-view="kanban" class="view-selector px-4 py-2 text-sm font-medium border-y border-secondary hover:bg-secondary">
          <i class="fas fa-columns mr-2"></i> Доска
        </button>
        <button data-view="calendar" class="view-selector px-4 py-2 text-sm font-medium rounded-r-lg border border-secondary hover:bg-secondary">
          <i class="fas fa-calendar-alt mr-2"></i> Календарь
        </button>
      </div>
    </div>

    <!-- Mini dashboard -->
    <div id="stats-bar" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4"></div>

    <!-- Project Selector -->
    <div class="mb-2 flex items-center gap-2">
      <select id="project-selector" class="bg-secondary rounded-lg px-4 py-2 ring-focus">
        <option value="all">Все проекты</option>
      </select>
      <button id="add-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Новый проект">
        <i class="fas fa-folder-plus"></i>
      </button>
      <button id="delete-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus" title="Удалить выбранный проект">
        <i class="fas fa-trash"></i>
      </button>
    </div>

    <!-- PINNED PROJECTS STRIP -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-hint">Закреплённые проекты</div>
        <div class="text-xs text-hint">Перетаскивайте для изменения порядка</div>
      </div>
      <div id="pinned-strip" class="flex gap-2 overflow-x-auto pb-1"></div>
    </div>

    <!-- List View -->
    <section id="list-view" class="view-content">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">Задачи</h2>
        <div class="relative flex items-center gap-2">
          <input id="search-input" placeholder="Поиск..." class="hidden md:block px-3 py-2 rounded-lg bg-secondary ring-focus"/>
          <button id="filter-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">
            <i class="fas fa-filter mr-1"></i> Фильтр
          </button>
          <div id="filter-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">Фильтры</div>
            <label class="block text-sm mb-1">По сроку</label>
            <select id="filter-due" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">Все</option>
              <option value="today">Сегодня</option>
              <option value="week">Эта неделя</option>
              <option value="overdue">Просроченные</option>
            </select>
            <label class="block text-sm mb-1">Приоритет</label>
            <select id="filter-priority" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">Все</option>
              <option value="critical">Критичный</option>
              <option value="high">Высокий</option>
              <option value="medium">Средний</option>
              <option value="low">Низкий</option>
            </select>
            <label class="block text sm mb-1">Статус</label>
            <select id="filter-status" class="w-full px-3 py-2 rounded bg-secondary ring-focus">
              <option value="all">Все</option>
              <option value="backlog">Бэклог</option>
              <option value="in-progress">В работе</option>
              <option value="review">Проверка</option>
              <option value="done">Готово</option>
            </select>
          </div>

          <button id="sort-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">
            <i class="fas fa-sort mr-1"></i> Сортировка
          </button>
          <div id="sort-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">Сортировать по</div>
            <select id="sort-select" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus">
              <option value="due-asc">Сроку (раньше → позже)</option>
              <option value="due-desc">Сроку (позже → раньше)</option>
              <option value="priority-desc">Приоритету (высокий → низкий)</option>
              <option value="priority-asc">Приоритету (низкий → высокий)</option>
              <option value="project-asc">Проекту (А→Я)</option>
              <option value="status-asc">Статусу</option>
              <option value="title-asc">Названию (А→Я)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Быстрое добавление -->
      <div class="mb-3">
        <input id="quick-add-input"
               class="w-full px-4 py-3 rounded-lg bg-secondary ring-focus"
               placeholder="Быстро добавить задачу… Поддерживает: /сегодня /завтра /пн…/вс /высокий /критично, #теги, @Проект"/>
        <div class="text-xs text-hint mt-1">
          Примеры: «Созвон с клиентом /завтра @Работа #важно», «Купить молоко /сегодня #дом»
        </div>
      </div>

      <div id="list-container" class="space-y-3"></div>
    </section>

    <!-- Kanban View -->
    <section id="kanban-view" class="view-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div data-col="backlog" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Бэклог</h3>
            <span class="text-xs bg-gray-200 text-gray-800 rounded-full px-2 py-1" id="cnt-backlog">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="in-progress" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">В работе</h3>
            <span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-1" id="cnt-in-progress">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="review" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Проверка</h3>
            <span class="text-xs bg-purple-200 text-purple-800 rounded-full px-2 py-1" id="cnt-review">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="done" class="kanban-column bg-secondary rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Готово</h3>
            <span class="text-xs bg-green-200 text-green-800 rounded-full px-2 py-1" id="cnt-done">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
      </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="view-content hidden">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Предыдущий месяц">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h2 id="month-title" class="text-lg font-semibold">Месяц ГГГГ</h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Следующий месяц">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div>
          <button id="today-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">Сегодня</button>
        </div>
      </div>
      <div id="weekday-row" class="grid grid-cols-7 gap-1 mb-1"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
    </section>

  </main>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="md:hidden sticky bottom-0 border-t border-secondary header-gradient">
    <div class="flex justify-around py-2">
      <button data-view="list" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="Список">
        <i class="fas fa-list text-lg"></i>
      </button>
      <button data-view="kanban" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="Доска">
        <i class="fas fa-columns text-lg"></i>
      </button>
      <button data-view="calendar" class="view-selector p-2 rounded-full hover:bg-secondary" aria-label="Календарь">
        <i class="fas fa-calendar-alt text-lg"></i>
      </button>
      <button id="mobile-add-task-button" class="p-2 rounded-full btn-main" aria-label="Новая задача">
        <i class="fas fa-plus text-lg"></i>
      </button>
    </div>
  </nav>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="task-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 id="task-modal-title" class="text-xl font-semibold">Новая задача</h2>
        <button id="close-task-modal" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="task-id"/>
        <div class="mb-4">
          <input type="text" id="task-title" placeholder="Название задачи" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-hint mb-1">Приоритет</label>
            <select id="task-priority" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus">
              <option value="low">Низкий</option>
              <option value="medium" selected>Средний</option>
              <option value="high">Высокий</option>
              <option value="critical">Критичный</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-hint mb-1">Статус</label>
            <select id="task-status" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus">
              <option value="backlog">Бэклог</option>
              <option value="in-progress">В работе</option>
              <option value="review">Проверка</option>
              <option value="done">Готово</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-hint mb-1">Проект</label>
            <select id="task-project" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></select>
          </div>
          <div>
            <label class="block text-sm text-hint mb-1">Срок</label>
            <input type="date" id="task-due-date" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">Описание</label>
          <textarea id="task-description" rows="3" placeholder="Подробности..." class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">Подзадачи (через Enter)</label>
          <textarea id="task-subtasks" rows="2" placeholder="Напр.: Исследовать конкурентов&#10;Сделать план" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">Метки (через запятую)</label>
          <input id="task-tags" placeholder="Работа, Важно" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-task" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">Отмена</button>
          <button id="save-task" class="px-4 py-2 rounded-lg btn-main">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="project-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[80vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">Новый проект</h2>
        <button id="close-project-modal" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="project-id"/>
        <div class="mb-4">
          <input type="text" id="project-name" placeholder="Название проекта" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">Цвет</label>
          <input type="color" id="project-color" value="#3b82f6" class="w-16 h-10 p-1 bg-secondary rounded ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-hint mb-1">Описание</label>
          <textarea id="project-description" rows="3" placeholder="Короткое описание..." class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea>
        </div>
        <div class="flex justify-between mt-6">
          <button id="delete-project" class="px-4 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50/10">
            <i class="fas fa-trash mr-1"></i>Удалить
          </button>
          <div class="flex gap-2">
            <button id="cancel-project" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">Отмена</button>
            <button id="save-project" class="px-4 py-2 rounded-lg btn-main">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="settings-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[85vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">Настройки</h2>
        <button id="close-settings" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 space-y-6">
        <div>
          <div class="text-sm font-medium mb-2">Тема оформления</div>
          <div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
        </div>

        <!-- Премиум-блок -->
        <div id="premium-settings-block" class="p-3 rounded-lg border border-secondary bg-[var(--secondary)]">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="text-sm font-medium">Статус премиума</div>
              <div class="text-xs text-hint" id="premium-status-line">—</div>
            </div>
            <div class="flex gap-2">
              <button id="prem-manage" class="px-3 py-1 rounded-lg btn-main">Управление</button>
            </div>
          </div>
        </div>

        <!-- Слот под админ-панель больше не нужен здесь -->
        <div class="text-xs text-hint">Тема сохраняется локально для вашего профиля и применяется ко всему приложению.</div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative w-full max-w-md mx-4">
      <div class="command-palette bg-[var(--bg)] rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-secondary">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-hint"></i>
            </div>
            <input type="text" id="command-input" placeholder="Команда или поиск..." class="w-full pl-10 pr-4 py-2 bg-secondary rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="max-h-96 overflow-y-auto">
          <div class="px-4 py-2 text-sm text-hint">Задачи</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-blue-100 text-blue-800 mr-3"><i class="fas fa-plus"></i></div>
              <div>
                <div class="font-medium">Создать задачу</div>
                <div class="text-xs text-hint">Добавить новую задачу</div>
              </div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-purple-100 text-purple-800 mr-3"><i class="fas fa-search"></i></div>
              <div>
                <div class="font-medium">Поиск задач</div>
                <div class="text-xs text-hint">Искать по названию/описанию</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-hint">Проекты</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-green-100 text-green-800 mr-3"><i class="fas fa-folder-plus"></i></div>
              <div>
                <div class="font-medium">Создать проект</div>
                <div class="text-xs text-hint">Организовать задачи по проектам</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-hint">Виды</div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-yellow-100 text-yellow-800 mr-3"><i class="fas fa-list"></i></div>
              <div><div class="font-medium">Переключить на Список</div><div class="text-xs text-hint">Простой список задач</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-indigo-100 text-indigo-800 mr-3"><i class="fas fa-columns"></i></div>
              <div><div class="font-medium">Переключить на Доску</div><div class="text-xs text-hint">Канбан</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-red-100 text-red-800 mr-3"><i class="fas fa-calendar-alt"></i></div>
              <div><div class="font-medium">Переключить на Календарь</div><div class="text-xs text-hint">Показ задач по датам</div></div>
            </div>
          </div>
        </div>
        <div class="p-2 text-xs text-center text-hint border-t border-secondary">
          Esc — закрыть • N — новая задача • Ctrl/Cmd+K — палитра • F — поиск • 1/2/3 — виды • Del — удалить
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
    <div class="w-24 h-24 bg-secondary rounded-full flex items-center justify-center mb-4">
      <i class="fas fa-tasks text-3xl text-hint"></i>
    </div>
    <h3 class="text-lg font-medium mb-2">Пока нет задач</h3>
    <p class="text-sm text-hint mb-4 text-center max-w-md px-4">Создайте первую задачу — нажмите «+» или клавишу N.</p>
    <button id="empty-state-add-task" class="px-4 py-2 rounded-lg btn-main">Добавить задачу</button>
  </div>
</div>

<script>
(() => {
  /* ========= Только Telegram WebApp ========= */
  (function enforceTelegramOnly(){
    const isTg = !!(window.Telegram && Telegram.WebApp && Telegram.WebApp.initData);
    const platform = Telegram?.WebApp?.platform || '';
    if (!isTg || platform === '') {
      const gate = document.createElement('div');
      gate.style.position = 'fixed'; gate.style.inset = '0'; gate.style.zIndex = '9999';
      gate.style.background = 'var(--bg)';
      gate.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 text-center">
          <div class="max-w-md">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-secondary flex items-center justify-center">
              <i class="fas fa-lock text-2xl"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2">Доступ только через Telegram</h2>
            <p class="text-sm text-hint mb-4">Откройте приложение внутри Telegram — через кнопку мини-приложения или ссылку в чате.</p>
            <a href="https://t.me/D_a_n_Vi" target="_blank" class="px-4 py-2 rounded-lg btn-main inline-block">Написать администратору</a>
          </div>
        </div>
      `;
      document.body.appendChild(gate);
      throw new Error('Blocked: Not inside Telegram WebApp');
    }
  })();

  const tg = window.Telegram?.WebApp;
  const tgUser = tg?.initDataUnsafe?.user || null;
  try{ tg?.ready(); tg?.expand?.(); tg?.MainButton?.hide?.(); }catch(_){}

  /* ========= Ключи localStorage ========= */
  const LS_THEME_BASE = 'tp_theme_v2';
  const LS_DATA_BASE  = 'tp_data_default';
  const userSuffix    = tgUser?.id ? `tg_${tgUser.id}` : 'guest';
  const LS_THEME      = `${LS_THEME_BASE}_${userSuffix}`;
  const LS_DATA       = `${LS_DATA_BASE}_${userSuffix}`;

  // Миграция
  if (tgUser?.id) {
    try {
      if (!localStorage.getItem(LS_DATA) && localStorage.getItem(LS_DATA_BASE)) {
        localStorage.setItem(LS_DATA, localStorage.getItem(LS_DATA_BASE));
      }
      if (!localStorage.getItem(LS_THEME) && localStorage.getItem(LS_THEME_BASE)) {
        localStorage.setItem(LS_THEME, localStorage.getItem(LS_THEME_BASE));
      }
    } catch(e) { console.warn('migrate error', e); }
  }

  /* ========= Профиль в меню ========= */
  const avatarEl   = document.getElementById('profile-avatar');
  const nameEl     = document.getElementById('profile-name');
  const usernameEl = document.getElementById('profile-username');

  if (tgUser) {
    const fullName = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || 'Пользователь';
    const uname    = tgUser.username ? '@' + tgUser.username : `id:${tgUser.id}`;
    nameEl.textContent = fullName;
    usernameEl.textContent = 'autologin: on • ' + uname;

    if (tgUser.photo_url) {
      avatarEl.style.backgroundImage = `url('${tgUser.photo_url}')`;
      avatarEl.style.backgroundSize = 'cover';
      avatarEl.style.backgroundPosition = 'center';
      avatarEl.textContent = '';
    } else {
      const initials = (tgUser.first_name?.[0] || '?') + (tgUser.last_name?.[0] || '');
      avatarEl.textContent = initials.toUpperCase();
    }
  } else {
    nameEl.textContent = 'Гость';
    usernameEl.textContent = 'autologin: off';
  }

  /* ========= ТЕМЫ ========= */
  const THEMES = [
    { id:'light',  name:'Светлая',  grad:'linear-gradient(90deg,#ffffff,#f9fafb)' },
    { id:'dark',   name:'Тёмная',   grad:'linear-gradient(90deg,#0f1115,#171a21)' },
    { id:'sunset', name:'Sunset',   grad:'linear-gradient(90deg,#ffedd5,#fecaca,#fde68a)' },
    { id:'peach',  name:'Peach',    grad:'linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68a)' },
    { id:'sand',   name:'Sand',     grad:'linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a)' },
    { id:'coral',  name:'Coral',    grad:'linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5)' },
    { id:'plum',   name:'Plum',     grad:'linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6)' },
    { id:'olive',  name:'Olive',    grad:'linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6)' },
  ];

  const el  = (sel) => document.querySelector(sel);
  const els = (sel) => document.querySelectorAll(sel);

  /* ========= Премиум / Подписка ========= */
  const ADMIN_TG_ID = 1288379477; // ваш Telegram ID
  const PREMIUM_LS_KEY = tgUser?.id ? `tp_premium_${tgUser.id}` : null;
  const ADMIN_USERNAME = 'D_a_n_Vi'; // куда вести на оплату

  const premium = { tier:'free', expiresAt:null }; // 'free'|'premium'

  function isAdmin(){ return String(tgUser?.id) === String(ADMIN_TG_ID); }

  function fetchPremiumStatus(){
    // Админ всегда премиум без ограничений
    if (isAdmin()){
      premium.tier = 'premium';
      premium.expiresAt = '2099-12-31';
      reflectSubscriptionBadge();
      updatePremiumStatusLine();
      return;
    }
    premium.tier = 'free';
    premium.expiresAt = null;

    if (!PREMIUM_LS_KEY){ reflectSubscriptionBadge(); updatePremiumStatusLine(); return; }
    const rec = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY) || '{}');
    const now = new Date();
    if (rec.end_ts && new Date(rec.end_ts) > now){
      premium.tier = 'premium';
      premium.expiresAt = new Date(rec.end_ts).toISOString().slice(0,10);
    }
    reflectSubscriptionBadge();
    updatePremiumStatusLine();
  }

  // Бейдж «Подписка | ...» + long-press toast
  const subBadge = document.getElementById('sub-badge');
  const subLabel = document.getElementById('sub-label');
  function reflectSubscriptionBadge(){
    if (premium.tier==='premium'){
      subBadge.classList.remove('bg-secondary','border-secondary');
      subBadge.classList.add('bg-yellow-50');
      subLabel.innerHTML = `<i class="fas fa-crown mr-1"></i><span class="shimmer">Premium</span>`;
    } else {
      subBadge.classList.add('bg-secondary','border-secondary');
      subLabel.textContent = 'Базовая';
    }
  }

  // Long press (600ms) для показа статуса
  (function initLongPress(){
    let tId=null, down=false;
    const show = ()=>{
      const wrap = document.createElement('div');
      wrap.className='toast';
      const status = (premium.tier==='premium')
        ? `Ваш статус: Премиум подписка<br><span class="text-hint">Активна до: ${premium.expiresAt || '—'}</span>`
        : `Ваш статус: Базовая подписка`;
      wrap.innerHTML = status;
      document.body.appendChild(wrap);
      setTimeout(()=> wrap.remove(), 2500);
    };
    const start = ()=>{ down=true; tId=setTimeout(()=>{ if(down) show(); }, 600); };
    const end   = ()=>{ down=false; if(tId){ clearTimeout(tId); tId=null; } };
    subBadge.addEventListener('mousedown', start);
    subBadge.addEventListener('touchstart', start, {passive:true});
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(evt=> subBadge.addEventListener(evt, end));
  })();

  // Строка в Настройках
  function updatePremiumStatusLine(){
    const line = document.getElementById('premium-status-line');
    if (!line) return;
    line.textContent = (premium.tier==='premium')
      ? `Premium${premium.expiresAt?` • до ${premium.expiresAt}`:''}`
      : 'Базовая';
  }

  // Покупка — компактное меню выбора срока и переход в ЛС к админу с готовым текстом
  function openPurchaseMenu(){
    const id = 'buy-menu';
    document.getElementById(id)?.remove();
    const wrap = document.createElement('div');
    wrap.id=id;
    wrap.className='fixed inset-0 z-50';
    wrap.innerHTML = `
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl p-5 space-y-4">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Оформить подписку</h3>
          <button class="p-2 rounded-full hover:bg-secondary" id="buy-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2">
          <label class="block text-sm">Срок подписки</label>
          <div class="grid grid-cols-3 gap-2">
            <label class="flex items-center gap-2 px-3 py-2 border border-secondary rounded-lg cursor-pointer">
              <input type="radio" name="plan" value="1" checked>
              <span>1 месяц</span>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 border border-secondary rounded-lg cursor-pointer">
              <input type="radio" name="plan" value="3">
              <span>3 месяца</span>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 border border-secondary rounded-lg cursor-pointer">
              <input type="radio" name="plan" value="6">
              <span>6 месяцев</span>
            </label>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="buy-send" class="px-4 py-2 rounded-lg btn-main flex-1">Отправить</button>
        </div>
        <div class="text-xs text-hint">Будет открыт чат с администратором и подставлено сообщение с выбранным сроком.</div>
      </div>
    `;
    document.body.appendChild(wrap);
    wrap.querySelector('#buy-close').addEventListener('click', ()=> wrap.remove());
    wrap.querySelector('#buy-send').addEventListener('click', ()=>{
      const val = (document.querySelector('input[name="plan"]:checked')?.value || '1');
      const text = `Добрый день, хотел бы приобрести подписку на ${val==='1'?'1 месяц': val==='3'?'3 месяца':'6 месяцев'}.`;
      const url = `https://t.me/${ADMIN_USERNAME}?text=${encodeURIComponent(text)}`;
      try { tg?.openTelegramLink(url); } catch(_){ window.open(url, '_blank'); }
      wrap.remove();
    });
  }

  /* ========= Меню: кнопки Премиум и Админ-панель ========= */
  (function injectMenuButtons(){
    const container = document.getElementById('menu-buttons');
    // Премиум
    const btnPrem = document.createElement('button');
    btnPrem.id='btn-premium';
    btnPrem.className='w-full text-left px-4 py-2 rounded-lg hover:bg-secondary';
    btnPrem.innerHTML = `<i class="fas fa-crown mr-2"></i>Премиум`;
    btnPrem.addEventListener('click', openPremiumModal);
    container.appendChild(btnPrem);

    // Админ-панель — только для админа
    if (isAdmin()){
      const btnAdmin = document.createElement('button');
      btnAdmin.id='btn-admin';
      btnAdmin.className='w-full text-left px-4 py-2 rounded-lg hover:bg-secondary';
      btnAdmin.innerHTML = `<i class="fas fa-user-shield mr-2"></i>Админ-панель`;
      btnAdmin.addEventListener('click', openAdminPanel);
      container.appendChild(btnAdmin);
    }
  })();

  /* ========= Premium Modal (упрощённый) ========= */
  function openPremiumModal(){
    const id = 'premium-modal';
    document.getElementById(id)?.remove();
    const modal = document.createElement('div');
    modal.id=id; modal.className='fixed inset-0 z-50';
    modal.innerHTML = `
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl p-5 space-y-4 max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Премиум</h3>
          <button id="prem-close" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)]">
          <div class="text-sm">Статус: <b>${premium.tier==='premium' ? ('Активна' + (premium.expiresAt? ' до '+premium.expiresAt : '')) : 'Базовая'}</b></div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">Оформить подписку</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btn-buy" class="px-3 py-2 rounded-lg border border-secondary hover:bg-secondary">Купить</button>
            <a href="https://t.me/${ADMIN_USERNAME}" target="_blank" class="px-3 py-2 rounded-lg btn-main text-center">Связаться</a>
          </div>
          <div class="text-xs text-hint">После оплаты доступ активируется админом/промокодом.</div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">У меня есть промокод</div>
          <div class="flex gap-2">
            <input id="promo-input" class="flex-1 px-3 py-2 rounded-lg bg-secondary ring-focus" placeholder="TP1.xxxxx.yyyyy"/>
            <button id="btn-redeem" class="px-3 py-2 rounded-lg btn-main">Активировать</button>
          </div>
        </div>

        <div class="text-xs text-hint">Подписка привязана к вашему Telegram ID: <b>${tgUser?.id ?? '—'}</b></div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#prem-close').addEventListener('click', ()=> modal.remove());
    modal.querySelector('#btn-buy').addEventListener('click', openPurchaseMenu);
    modal.querySelector('#btn-redeem').addEventListener('click', ()=>{
      const code = modal.querySelector('#promo-input').value.trim();
      redeemPromo(code);
      modal.remove();
    });
  }

  /* ========= Промокоды (остались, но без «триала») ========= */
  const PREMIUM_SECRET = 'tp$S3cr3t@v1';
  function hashFn(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
    }
    return ('0000000' + (h>>>0).toString(16)).slice(-8);
  }
  function b64u(str){ return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function b64uDec(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return atob(s); }

  // payload: { tgId, plan:"M1"|"M3"|"M6", durDays:number, iat:number, expISO:string }
  function signPayload(obj){
    const payload = JSON.stringify(obj);
    const sig = hashFn(PREMIUM_SECRET + '|' + payload + '|v1');
    return `TP1.${b64u(payload)}.${sig}`;
  }
  function verifyAndParse(code){
    if (!code || typeof code!=='string') return null;
    const parts = code.trim().split('.');
    if (parts.length !== 3 || parts[0] !== 'TP1') return null;
    try{
      const payloadStr = b64uDec(parts[1]);
      const sig = parts[2];
      const ok = hashFn(PREMIUM_SECRET + '|' + payloadStr + '|v1') === sig;
      if (!ok) return null;
      return JSON.parse(payloadStr);
    }catch(e){ return null; }
  }
  function redeemPromo(code){
    const data = verifyAndParse(code);
    if (!data){ alert('Неверный промокод'); return; }
    if (!tgUser?.id){ alert('Нужен вход через Telegram'); return; }
    if (String(data.tgId) !== String(tgUser.id)){ alert('Этот промокод выдан для другого аккаунта'); return; }

    const days = data.durDays || (data.plan==='M6'? 183 : data.plan==='M3'? 92 : 31);
    const now = new Date();
    const store = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY) || '{}');

    let base = now;
    if (store.end_ts){
      const oldEnd = new Date(store.end_ts);
      if (oldEnd > now) base = oldEnd;
    }
    const newEnd = new Date(base);
    newEnd.setDate(newEnd.getDate() + days);
    store.end_ts = newEnd.toISOString();
    localStorage.setItem(PREMIUM_LS_KEY, JSON.stringify(store));

    fetchPremiumStatus();
    alert('Премиум активирован!');
  }

  /* ========= Админ-панель (только у админа в боковом меню) ========= */
  function openAdminPanel(){
    if (!isAdmin()) return;
    const id='admin-modal';
    document.getElementById(id)?.remove();
    const modal = document.createElement('div');
    modal.id=id; modal.className='fixed inset-0 z-50';
    modal.innerHTML = `
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl p-5 space-y-4 max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Админ-панель</h3>
          <button id="adm-close" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)] space-y-3">
          <div class="text-sm font-medium">Генерация промокодов</div>
          <div class="grid sm:grid-cols-3 gap-2">
            <input id="promo-user-id" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary" placeholder="User Telegram ID"/>
            <select id="promo-plan" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary">
              <option value="M1">1 месяц</option>
              <option value="M3">3 месяца</option>
              <option value="M6">6 месяцев</option>
            </select>
            <button id="promo-generate" class="px-3 py-2 rounded-lg btn-main">Сгенерировать</button>
          </div>
          <div>
            <label class="block text-xs text-hint mb-1">Сгенерированный промокод</label>
            <input id="promo-output" readonly class="w-full px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary"/>
          </div>
        </div>

        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)] space-y-3">
          <div class="text-sm font-medium">Генерация ссылки-приглашения</div>
          <div class="grid sm:grid-cols-2 gap-2">
            <input id="inv-title" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary" placeholder="Название (необязательно)"/>
            <select id="inv-default-plan" class="px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary">
              <option value="M1">1 мес</option>
              <option value="M3">3 мес</option>
              <option value="M6">6 мес</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="inv-generate" class="px-3 py-2 rounded-lg btn-main">Сгенерировать ссылку</button>
          </div>
          <div>
            <label class="block text-xs text-hint mb-1">Ссылка</label>
            <input id="inv-output" readonly class="w-full px-3 py-2 rounded-lg bg-[var(--bg)] border border-secondary"/>
            <div class="text-xs text-hint mt-1">Ссылка содержит base64-параметр с планом и меткой.</div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#adm-close').addEventListener('click', ()=> modal.remove());

    // Промокоды
    const uidInput = modal.querySelector('#promo-user-id');
    const planSel  = modal.querySelector('#promo-plan');
    const out      = modal.querySelector('#promo-output');
    if (!uidInput.value && tgUser?.id) uidInput.value = String(tgUser.id);
    modal.querySelector('#promo-generate').addEventListener('click', ()=>{
      const targetId = uidInput.value.trim();
      if (!/^\d+$/.test(targetId)) { alert('Укажите корректный Telegram ID'); return; }
      const plan = planSel.value;
      const days = plan==='M6'?183: plan==='M3'?92:31;
      const payload = {
        tgId:Number(targetId), plan, durDays:days,
        iat:Date.now(), expISO:new Date(Date.now()+days*86400000).toISOString()
      };
      const code = signPayload(payload);
      out.value = code; navigator.clipboard?.writeText(code).catch(()=>{});
    });

    // Ссылка-приглашение
    modal.querySelector('#inv-generate').addEventListener('click', ()=>{
      const title = (modal.querySelector('#inv-title').value||'').trim();
      const plan  = modal.querySelector('#inv-default-plan').value;
      const payload = b64u(JSON.stringify({ plan, title, iat:Date.now() }));
      const link = `${location.origin}${location.pathname}?invite=${payload}`;
      const field = modal.querySelector('#inv-output');
      field.value = link; navigator.clipboard?.writeText(link).catch(()=>{});
    });
  }

  /* ========= Тема (с блокировкой премиум-тем без статуса) ========= */
  const savedTheme = localStorage.getItem(LS_THEME) || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  function _setTheme(id){
    document.documentElement.setAttribute('data-theme', id);
    localStorage.setItem(LS_THEME, id);
  }
  function setTheme(id){
    const isFree = (id==='light' || id==='dark');
    if (!isFree && premium.tier!=='premium'){
      openPremiumModal(); return;
    }
    _setTheme(id);
    buildThemeCards();
  }
  function buildThemeCards(){
    const grid = document.getElementById('theme-grid');
    grid.innerHTML='';
    const current = document.documentElement.getAttribute('data-theme');
    THEMES.forEach(t=>{
      const isFree = (t.id==='light'||t.id==='dark');
      const locked = !isFree && premium.tier!=='premium';
      const card = document.createElement('button');
      card.className = 'w-full text-left rounded-xl border border-secondary p-3 ring-focus ' + (locked ? 'opacity-70 cursor-not-allowed' : 'hover:bg-secondary');
      card.setAttribute('data-theme-id', t.id);
      card.innerHTML = `
        <div class="h-10 w-full rounded-md mb-2" style="background:${t.grad}"></div>
        <div class="flex items-center justify-between">
          <div class="font-medium">${t.name} ${locked ? '<span class="text-xs ml-2">🔒</span>' : ''}</div>
          ${current===t.id ? '<i class="fas fa-check"></i>' : ''}
        </div>
      `;
      card.addEventListener('click', ()=> setTheme(t.id));
      grid.appendChild(card);
    });
  }

  /* ========= Остальная логика приложения (проект/задачи/канбан/календарь) ========= */
  const sideMenu = document.getElementById('side-menu');
  const menuBtnEl = document.getElementById('menu-button');
  const closeMenuEl = document.getElementById('close-menu');
  menuBtnEl.addEventListener('click', ()=> sideMenu.classList.remove('hidden'));
  closeMenuEl.addEventListener('click', ()=> sideMenu.classList.add('hidden'));
  document.addEventListener('click', (e)=>{
    if (!sideMenu.classList.contains('hidden')) {
      const inside = sideMenu.contains(e.target) || menuBtnEl.contains(e.target);
      if (!inside) sideMenu.classList.add('hidden');
    }
  });

  const statsBar = document.getElementById('stats-bar');
  const projectSelector = document.getElementById('project-selector');
  const addProjectButton = document.getElementById('add-project-button');
  const deleteProjectButton = document.getElementById('delete-project-button');
  const pinnedStrip = document.getElementById('pinned-strip');
  const searchButton = document.getElementById('search-button');
  const searchInput = document.getElementById('search-input');
  const quickAddInput = document.getElementById('quick-add-input');
  const filterButton = document.getElementById('filter-button');
  const filterPanel = document.getElementById('filter-panel');
  const filterDue = document.getElementById('filter-due');
  const filterPriority = document.getElementById('filter-priority');
  const filterStatus = document.getElementById('filter-status');
  const sortButton = document.getElementById('sort-button');
  const sortPanel = document.getElementById('sort-panel');
  const sortSelect = document.getElementById('sort-select');
  const listContainer = document.getElementById('list-container');
  const emptyState = document.getElementById('empty-state');
  const taskModal = document.getElementById('task-modal');
  const taskBackdrop = document.getElementById('task-backdrop');
  const taskModalTitle = document.getElementById('task-modal-title');
  const addTaskButtons = document.querySelectorAll('#add-task-button, #mobile-add-task-button, #empty-state-add-task');
  const closeTaskModal = document.getElementById('close-task-modal');
  const cancelTask = document.getElementById('cancel-task');
  const saveTaskBtn = document.getElementById('save-task');
  const projectModal = document.getElementById('project-modal');
  const projectBackdrop = document.getElementById('project-backdrop');
  const closeProjectModal = document.getElementById('close-project-modal');
  const cancelProject = document.getElementById('cancel-project');
  const saveProject = document.getElementById('save-project');
  const deleteProject = document.getElementById('delete-project');
  const projectNameInput = document.getElementById('project-name');
  const projectColorInput = document.getElementById('project-color');
  const settingsModal = document.getElementById('settings-modal');
  const settingsBackdrop = document.getElementById('settings-backdrop');
  const closeSettings = document.getElementById('close-settings');
  const themeGrid = document.getElementById('theme-grid');
  const commandPalette = document.getElementById('command-palette');
  const commandInput = document.getElementById('command-input');
  const commandOptions = document.querySelectorAll('.command-option');
  const prevMonth = document.getElementById('prev-month');
  const nextMonth = document.getElementById('next-month');
  const todayButton = document.getElementById('today-button');
  const monthTitle = document.getElementById('month-title');
  const weekdayRow = document.getElementById('weekday-row');
  const calendarGrid = document.getElementById('calendar-grid');
  const viewContents = document.querySelectorAll('.view-content');
  const viewSelectors = document.querySelectorAll('.view-selector');

  /* ========= Утилиты ========= */
  function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
  function todayISO(shift=0){ const d=new Date(); d.setDate(d.getDate()+shift); return d.toISOString().slice(0,10); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtDateHuman(iso){ if(!iso) return 'Без срока'; const d = new Date(iso+'T00:00:00'); return d.toLocaleDateString('ru-RU',{ day:'2-digit', month:'long' }); }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function projectById(id){ return state.projects.find(p=>p.id===id) || null; }
  function projectName(id){ return (projectById(id)?.name) || 'Без проекта'; }
  function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||''); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:59,g:130,b:246}; }
  function rgba(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function textColorForBg(hex){ const {r,g,b}=hexToRgb(hex); const yiq=(r*299+g*587+b*114)/1000; return yiq>=128?'#111827':'#f9fafb'; }
  function startOfWeek(d=new Date()){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-wd); return x; }
  function endOfWeek(d=new Date()){ const x=startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }

  /* ========= Состояние ========= */
  const state = {
    projects: [
      { id:'work',     name:'Работа',   color:'#3b82f6' },
      { id:'personal', name:'Личное',   color:'#10b981' },
      { id:'team',     name:'Команда',  color:'#8b5cf6' }
    ],
    pinned: ['work','personal','team'],
    tasks: [
      { id: uid(), title:'Подготовить предложение по проекту', priority:'high', status:'in-progress', project:'work', dueDate: todayISO(1), description:'Согласовать разделы', tags:['Работа'], subtasks:['Исследовать конкурентов','Скелет документа'], subtasksDone:[false,false], completed:false, createdAt: nowISO() },
      { id: uid(), title:'Командная встреча', priority:'medium', status:'backlog', project:'team', dueDate: todayISO(0), description:'Синк по задачам', tags:['Команда'], subtasks:[], subtasksDone:[], completed:false, createdAt: nowISO() },
      { id: uid(), title:'Купить продукты', priority:'low', status:'backlog', project:'personal', dueDate:'', description:'Хлеб, молоко', tags:['Личное'], subtasks:['Список'], subtasksDone:[false], completed:false, createdAt: nowISO() },
      { id: uid(), title:'Настроить CI/CD', priority:'high', status:'done', project:'team', dueDate: todayISO(-3), description:'GitHub Actions', tags:['DevOps'], subtasks:[], subtasksDone:[], completed:true, completedAt: todayISO(-2)+'T10:00:00Z', createdAt: nowISO() },
    ],
    view:'list',
    search:'',
    filters:{ due:'all', priority:'all', status:'all' },
    sort:'due-asc',
    currentMonth:new Date(),
    selectedTaskId:null
  };

  /* ========= Тема ========= */
  const savedTheme = localStorage.getItem(LS_THEME) || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);

  /* ========= Настройки ========= */
  const btnSettings = document.getElementById('btn-settings');
  btnSettings?.addEventListener('click', ()=> {
    settingsModal.classList.remove('hidden');
    buildThemeCards();
    updatePremiumStatusLine();
  });
  function closeSettingsModal(){ settingsModal.classList.add('hidden'); }
  document.getElementById('close-settings').addEventListener('click', closeSettingsModal);
  document.getElementById('settings-backdrop').addEventListener('click', closeSettingsModal);
  document.getElementById('prem-manage').addEventListener('click', openPremiumModal);

  /* ========= Premium init ========= */
  fetchPremiumStatus();

  /* ========= Загрузка/сохранение ========= */
  function load(){
    const raw = localStorage.getItem(LS_DATA);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if (Array.isArray(data.projects)) state.projects = data.projects;
      if (Array.isArray(data.pinned)) state.pinned = data.pinned.slice(0,6);
      if (Array.isArray(data.tasks)) {
        state.tasks = data.tasks.map(t=>{
          if (Array.isArray(t.subtasks) && !Array.isArray(t.subtasksDone)) {
            t.subtasksDone = t.subtasks.map(()=>false);
          }
          return t;
        });
      }
    }
