<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Планировщик задач</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --tg-theme-bg-color:#ffffff;
      --tg-theme-text-color:#000000;
      --tg-theme-hint-color:#707579;
      --tg-theme-link-color:#3390ec;
      --tg-theme-button-color:#3390ec;
      --tg-theme-button-text-color:#ffffff;
      --tg-theme-secondary-bg-color:#f4f4f5;
      --ring:rgba(51,144,236,.35)
    }
    .dark{
      --tg-theme-bg-color:#1c1c1d;
      --tg-theme-text-color:#fff;
      --tg-theme-hint-color:#aaa;
      --tg-theme-link-color:#5d9ce6;
      --tg-theme-button-color:#5d9ce6;
      --tg-theme-button-text-color:#fff;
      --tg-theme-secondary-bg-color:#2c2c2e;
      --ring:rgba(93,156,230,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--tg-theme-bg-color);
      color:var(--tg-theme-text-color);
      transition:background-color .25s,color .25s;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Inter',system-ui,sans-serif
    }
    .ring-focus:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .task-card{transition:box-shadow .15s, background-color .15s}
    .task-card:hover{box-shadow:0 4px 10px rgb(0 0 0 /.08)}
    .task-card.selected{outline:2px solid var(--ring); outline-offset:2px}
    .priority-low{background:rgba(52,211,153,.12);color:rgb(16,185,129)}
    .priority-medium{background:rgba(96,165,250,.12);color:rgb(59,130,246)}
    .priority-high{background:rgba(251,191,36,.12);color:rgb(234,179,8)}
    .priority-critical{background:rgba(239,68,68,.12);color:rgb(239,68,68)}
    .status-backlog{background:rgba(156,163,175,.12);color:rgb(156,163,175)}
    .status-in-progress{background:rgba(59,130,246,.12);color:rgb(59,130,246)}
    .status-review{background:rgba(168,85,247,.12);color:rgb(168,85,247)}
    .status-done{background:rgba(16,185,129,.12);color:rgb(16,185,129)}
    .kanban-column{min-height:60vh}
    .calendar-day{min-height:100px}
    .calendar-day.today{outline:2px solid var(--ring);outline-offset:-2px;background:rgba(59,130,246,.06)}
    .calendar-day.dragover{outline:2px dashed var(--ring); outline-offset:-2px}
    .command-palette{backdrop-filter:blur(10px)}
    .subtask-checkbox:checked+.subtask-label{text-decoration:line-through;color:var(--tg-theme-hint-color)}
    @media (max-width:640px){
      .kanban-column{min-height:auto;max-height:60vh;overflow-y:auto}
    }
    .popover{position:absolute;z-index:30;background:var(--tg-theme-bg-color);border:1px solid var(--tg-theme-secondary-bg-color);box-shadow:0 8px 24px rgb(0 0 0 / .12);border-radius:.75rem;min-width:240px}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .progress-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--tg-theme-button-color);width:0%}
    .title-input{background:transparent;border:1px dashed var(--tg-theme-secondary-bg-color);padding:2px 6px;border-radius:6px;width:100%}
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-[var(--tg-theme-bg-color)] border-b border-[var(--tg-theme-secondary-bg-color)]">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="menu-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Открыть меню">
            <i class="fas fa-bars"></i>
          </button>
          <!-- Side menu -->
          <aside id="side-menu" class="hidden fixed top-0 left-0 h-full w-72 bg-[var(--tg-theme-bg-color)] shadow-xl z-20 border-r border-[var(--tg-theme-secondary-bg-color)]">
            <div class="p-4 border-b border-[var(--tg-theme-secondary-bg-color)] flex justify-between items-center">
              <h2 class="text-lg font-semibold">Меню</h2>
              <button id="close-menu" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Закрыть">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="p-3 space-y-1">
              <button class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-user mr-2"></i><span id="menu-user">Профиль</span>
              </button>
              <button id="btn-theme-toggle" class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-moon mr-2"></i><span>Переключить тему</span>
              </button>
              <button id="btn-export" class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-file-export mr-2"></i>Экспортировать данные (JSON)
              </button>
              <button id="btn-export-docx" class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-file-word mr-2"></i>Экспортировать в DOCX
              </button>
              <button id="btn-import" class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-file-import mr-2"></i>Импортировать данные
              </button>
              <button id="btn-restore" class="w-full text-left px-4 py-2 rounded-lg hover:bg-[var(--tg-theme-secondary-bg-color)]">
                <i class="fas fa-rotate-left mr-2"></i>Восстановить из бэкапа
              </button>
            </div>
          </aside>
        </div>
        <h1 class="text-xl font-semibold">Планировщик задач</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="search-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Поиск">
          <i class="fas fa-search"></i>
        </button>
        <button id="add-task-button" class="p-2 rounded-full bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)] ring-focus" aria-label="Новая задача">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-4">
      <!-- View Selector -->
    <div class="flex justify-center mb-4">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button data-view="list" class="view-selector px-4 py-2 text-sm font-medium rounded-l-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-list mr-2"></i> Список
        </button>
        <button data-view="kanban" class="view-selector px-4 py-2 text-sm font-medium border-y border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-columns mr-2"></i> Доска
        </button>
        <button data-view="calendar" class="view-selector px-4 py-2 text-sm font-medium rounded-r-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
          <i class="fas fa-calendar-alt mr-2"></i> Календарь
        </button>
      </div>
    </div>

    <!-- Mini dashboard -->
    <div id="stats-bar" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4"></div>

    <!-- Project Selector -->
    <div class="mb-4 flex items-center gap-2">
      <select id="project-selector" class="bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] rounded-lg px-4 py-2 ring-focus">
        <option value="all">Все проекты</option>
      </select>
      <button id="add-project-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Новый проект">
        <i class="fas fa-folder-plus"></i>
      </button>
      <button id="delete-project-button" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" title="Удалить выбранный проект">
        <i class="fas fa-trash"></i>
      </button>
    </div>

    <!-- List View -->
    <section id="list-view" class="view-content">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">Задачи</h2>
        <div class="relative flex items-center gap-2">
          <input id="search-input" placeholder="Поиск..." class="hidden md:block px-3 py-2 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] ring-focus"/>
          <button id="filter-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
            <i class="fas fa-filter mr-1"></i> Фильтр
          </button>
          <div id="filter-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">Фильтры</div>
            <label class="block text-sm mb-1">По сроку</label>
            <select id="filter-due" class="w-full mb-2 px-3 py-2 rounded bg-[var(--tg-theme-secondary-bg-color)] ring-focus">
              <option value="all">Все</option>
              <option value="today">Сегодня</option>
              <option value="week">Эта неделя</option>
              <option value="overdue">Просроченные</option>
            </select>
            <label class="block text-sm mb-1">Приоритет</label>
            <select id="filter-priority" class="w-full mb-2 px-3 py-2 rounded bg-[var(--tg-theme-secondary-bg-color)] ring-focus">
              <option value="all">Все</option>
              <option value="critical">Критичный</option>
              <option value="high">Высокий</option>
              <option value="medium">Средний</option>
              <option value="low">Низкий</option>
            </select>
            <label class="block text-sm mb-1">Статус</label>
            <select id="filter-status" class="w-full px-3 py-2 rounded bg-[var(--tg-theme-secondary-bg-color)] ring-focus">
              <option value="all">Все</option>
              <option value="backlog">Бэклог</option>
              <option value="in-progress">В работе</option>
              <option value="review">Проверка</option>
              <option value="done">Готово</option>
            </select>
          </div>

          <button id="sort-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
            <i class="fas fa-sort mr-1"></i> Сортировка
          </button>
          <div id="sort-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">Сортировать по</div>
            <select id="sort-select" class="w-full mb-2 px-3 py-2 rounded bg-[var(--tg-theme-secondary-bg-color)] ring-focus">
              <option value="due-asc">Сроку (раньше → позже)</option>
              <option value="due-desc">Сроку (позже → раньше)</option>
              <option value="priority-desc">Приоритету (высокий → низкий)</option>
              <option value="priority-asc">Приоритету (низкий → высокий)</option>
              <option value="project-asc">Проекту (А→Я)</option>
              <option value="status-asc">Статусу</option>
              <option value="title-asc">Названию (А→Я)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Быстрое добавление -->
      <div class="mb-3">
        <input id="quick-add-input"
               class="w-full px-4 py-3 rounded-lg bg-[var(--tg-theme-secondary-bg-color)] ring-focus"
               placeholder="Быстро добавить задачу… Поддерживает: /сегодня /завтра /пн…/вс /высокий /критично, #теги, @Проект"/>
        <div class="text-xs text-[var(--tg-theme-hint-color)] mt-1">
          Примеры: «Созвон с клиентом /завтра @Работа #важно», «Купить молоко /сегодня #дом»
        </div>
      </div>

      <div id="list-container" class="space-y-3"></div>
    </section>

    <!-- Kanban View -->
    <section id="kanban-view" class="view-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div data-col="backlog" class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Бэклог</h3>
            <span class="text-xs bg-gray-200 text-gray-800 rounded-full px-2 py-1" id="cnt-backlog">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="in-progress" class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">В работе</h3>
            <span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-1" id="cnt-in-progress">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="review" class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Проверка</h3>
            <span class="text-xs bg-purple-200 text-purple-800 rounded-full px-2 py-1" id="cnt-review">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
        <div data-col="done" class="kanban-column bg-[var(--tg-theme-secondary-bg-color)] rounded-lg p-3">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-medium">Готово</h3>
            <span class="text-xs bg-green-200 text-green-800 rounded-full px-2 py-1" id="cnt-done">0</span>
          </div>
          <div class="space-y-3 column-body"></div>
        </div>
      </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="view-content hidden">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Предыдущий месяц">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h2 id="month-title" class="text-lg font-semibold">Месяц ГГГГ</h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Следующий месяц">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div>
          <button id="today-button" class="px-3 py-1 text-sm rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">
            Сегодня
          </button>
        </div>
      </div>
      <div id="weekday-row" class="grid grid-cols-7 gap-1 mb-1"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
    </section>

  </main>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="md:hidden sticky bottom-0 bg-[var(--tg-theme-bg-color)] border-t border-[var(--tg-theme-secondary-bg-color)]">
    <div class="flex justify-around py-2">
      <button data-view="list" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Список">
        <i class="fas fa-list text-lg"></i>
      </button>
      <button data-view="kanban" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Доска">
        <i class="fas fa-columns text-lg"></i>
      </button>
      <button data-view="calendar" class="view-selector p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)]" aria-label="Календарь">
        <i class="fas fa-calendar-alt text-lg"></i>
      </button>
      <button id="mobile-add-task-button" class="p-2 rounded-full bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]" aria-label="Новая задача">
        <i class="fas fa-plus text-lg"></i>
      </button>
    </div>
  </nav>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="task-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 id="task-modal-title" class="text-xl font-semibold">Новая задача</h2>
        <button id="close-task-modal" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="task-id"/>
        <div class="mb-4">
          <input type="text" id="task-title" placeholder="Название задачи" class="w-full px-4 py-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"/>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Приоритет</label>
            <select id="task-priority" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus">
              <option value="low">Низкий</option>
              <option value="medium" selected>Средний</option>
              <option value="high">Высокий</option>
              <option value="critical">Критичный</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Статус</label>
            <select id="task-status" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus">
              <option value="backlog">Бэклог</option>
              <option value="in-progress">В работе</option>
              <option value="review">Проверка</option>
              <option value="done">Готово</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Проект</label>
            <select id="task-project" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"></select>
          </div>
          <div>
            <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Срок</label>
            <input type="date" id="task-due-date" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Описание</label>
          <textarea id="task-description" rows="3" placeholder="Подробности..." class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Подзадачи (через Enter)</label>
          <textarea id="task-subtasks" rows="2" placeholder="Напр.: Исследовать конкурентов&#10;Сделать план" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Метки (через запятую)</label>
          <input id="task-tags" placeholder="Работа, Важно" class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"/>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-task" class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Отмена</button>
          <button id="save-task" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="project-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[80vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-xl font-semibold">Новый проект</h2>
        <button id="close-project-modal" class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <input type="hidden" id="project-id"/>
        <div class="mb-4">
          <input type="text" id="project-name" placeholder="Название проекта" class="w-full px-4 py-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Цвет</label>
          <input type="color" id="project-color" value="#3b82f6" class="w-16 h-10 p-1 bg-[var(--tg-theme-secondary-bg-color)] rounded ring-focus"/>
        </div>
        <div class="mb-4">
          <label class="block text-sm text-[var(--tg-theme-hint-color)] mb-1">Описание</label>
          <textarea id="project-description" rows="3" placeholder="Короткое описание..." class="w-full px-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"></textarea>
        </div>
        <div class="flex justify-between mt-6">
          <button id="delete-project" class="px-4 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50/10">
            <i class="fas fa-trash mr-1"></i>Удалить
          </button>
          <div class="flex gap-2">
            <button id="cancel-project" class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Отмена</button>
            <button id="save-project" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative w-full max-w-md mx-4">
      <div class="command-palette bg-[var(--tg-theme-bg-color)] rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-[var(--tg-theme-secondary-bg-color)]">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-[var(--tg-theme-hint-color)]"></i>
            </div>
            <input type="text" id="command-input" placeholder="Команда или поиск..." class="w-full pl-10 pr-4 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus"/>
          </div>
        </div>
        <div class="max-h-96 overflow-y-auto">
          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Задачи</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-blue-100 text-blue-800 mr-3"><i class="fas fa-plus"></i></div>
              <div>
                <div class="font-medium">Создать задачу</div>
                <div class="text-xs text-[var(--tg-theme-hint-color)]">Добавить новую задачу</div>
              </div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-purple-100 text-purple-800 mr-3"><i class="fas fa-search"></i></div>
              <div>
                <div class="font-medium">Поиск задач</div>
                <div class="text-xs text-[var(--tg-theme-hint-color)]">Искать по названию/описанию</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Проекты</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-green-100 text-green-800 mr-3"><i class="fas fa-folder-plus"></i></div>
              <div>
                <div class="font-medium">Создать проект</div>
                <div class="text-xs text-[var(--tg-theme-hint-color)]">Организовать задачи по проектам</div>
              </div>
            </div>
          </div>

          <div class="px-4 py-2 text-sm text-[var(--tg-theme-hint-color)]">Виды</div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-yellow-100 text-yellow-800 mr-3"><i class="fas fa-list"></i></div>
              <div><div class="font-medium">Переключить на Список</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Простой список задач</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-indigo-100 text-indigo-800 mr-3"><i class="fas fa-columns"></i></div>
              <div><div class="font-medium">Переключить на Доску</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Канбан</div></div>
            </div>
          </div>
          <div class="command-option px-4 py-3 hover:bg-[var(--tg-theme-secondary-bg-color)] cursor-pointer">
            <div class="flex items-center">
              <div class="p-2 rounded-full bg-red-100 text-red-800 mr-3"><i class="fas fa-calendar-alt"></i></div>
              <div><div class="font-medium">Переключить на Календарь</div><div class="text-xs text-[var(--tg-theme-hint-color)]">Показ задач по датам</div></div>
            </div>
          </div>
        </div>
        <div class="p-2 text-xs text-center text-[var(--tg-theme-hint-color)] border-t border-[var(--tg-theme-secondary-bg-color)]">
          Esc — закрыть • N — новая задача • Ctrl/Cmd+K — палитра • F — поиск • 1/2/3 — виды • Del — удалить
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
    <div class="w-24 h-24 bg-[var(--tg-theme-secondary-bg-color)] rounded-full flex items-center justify-center mb-4">
      <i class="fas fa-tasks text-3xl text-[var(--tg-theme-hint-color)]"></i>
    </div>
    <h3 class="text-lg font-medium mb-2">Пока нет задач</h3>
    <p class="text-sm text-[var(--tg-theme-hint-color)] mb-4 text-center max-w-md px-4">Создайте первую задачу — нажмите «+» или клавишу N.</p>
    <button id="empty-state-add-task" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Добавить задачу</button>
  </div>

  <!-- NEW: Export JSON Modal (Telegram-friendly) -->
  <div id="export-json-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop" data-close="export-json-modal"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[85vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-lg font-semibold">Экспорт данных (JSON)</h2>
        <button class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" data-close="export-json-modal" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 space-y-3">
        <p class="text-sm text-[var(--tg-theme-hint-color)]">В Telegram WebApp иногда блокируется авто-скачивание. Скопируйте JSON или нажмите «Скачать» ниже.</p>
        <textarea id="export-json-text" class="w-full h-48 px-3 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus" readonly></textarea>
        <div class="flex gap-2">
          <button id="export-json-copy" class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]">Скопировать</button>
          <a id="export-json-download" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Скачать</a>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Import JSON Modal (Telegram-friendly) -->
  <div id="import-json-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop" data-close="import-json-modal"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl max-h-[85vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-lg font-semibold">Импорт данных (вставьте JSON)</h2>
        <button class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" data-close="import-json-modal" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 space-y-3">
        <textarea id="import-json-text" class="w-full h-48 px-3 py-2 bg-[var(--tg-theme-secondary-bg-color)] rounded-lg ring-focus" placeholder='Вставьте сюда содержимое файла planner-data.json'></textarea>
        <div class="flex justify-end gap-2">
          <button class="px-4 py-2 rounded-lg border border-[var(--tg-theme-secondary-bg-color)] hover:bg-[var(--tg-theme-secondary-bg-color)]" data-close="import-json-modal">Отмена</button>
          <button id="import-json-apply" class="px-4 py-2 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]">Импортировать</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: File Link Modal (for DOCX / Telegram) -->
  <div id="file-link-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop" data-close="file-link-modal"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--tg-theme-bg-color)] rounded-t-3xl shadow-xl">
      <div class="sticky top-0 bg-[var(--tg-theme-bg-color)] p-4 flex justify-between items-center border-b border-[var(--tg-theme-secondary-bg-color)]">
        <h2 class="text-lg font-semibold">Скачать файл</h2>
        <button class="p-2 rounded-full hover:bg-[var(--tg-theme-secondary-bg-color)] ring-focus" data-close="file-link-modal" aria-label="Закрыть">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 space-y-3">
        <p class="text-sm text-[var(--tg-theme-hint-color)]">Нажмите по ссылке, чтобы сохранить файл. Если ссылка не открывается, нажмите и удерживайте, затем выберите «Открыть».</p>
        <a id="file-link-href" class="block w-full text-center px-4 py-3 rounded-lg bg-[var(--tg-theme-button-color)] text-[var(--tg-theme-button-text-color)]" download>Скачать</a>
      </div>
    </div>
  </div>
  <script>
(() => {
  // --- Telegram + тема ---
  const tg = window.Telegram?.WebApp;
  const inTelegram = !!tg?.initDataUnsafe || !!tg?.initData;
  if (tg?.expand) tg.expand();

  const user = tg?.initDataUnsafe?.user || null;
  const LS_THEME = 'tp_theme';
  const LS_DATA_PREFIX = 'tp_data_';
  const STORAGE_KEY = LS_DATA_PREFIX + (user?.id || 'default');

  const applyTheme = (mode) => {
    if (inTelegram) { localStorage.setItem(LS_THEME, mode); return; }
    document.documentElement.classList.toggle('dark', mode === 'dark');
    localStorage.setItem(LS_THEME, mode);
  };
  const initialMode = inTelegram ? (tg?.colorScheme === 'dark' ? 'dark' : 'light')
                                 : (localStorage.getItem(LS_THEME) || 'light');
  applyTheme(initialMode);

  if (inTelegram && tg?.onEvent) {
    tg.onEvent('themeChanged', () => { renderAll(); });
  }

  // --- Элементы ---
  const sideMenu = document.getElementById('side-menu');
  const menuBtn = document.getElementById('menu-button');
  const closeMenu = document.getElementById('close-menu');
  const themeToggle = document.getElementById('btn-theme-toggle');
  const btnExport = document.getElementById('btn-export');
  const btnExportDocx = document.getElementById('btn-export-docx');
  const btnImport = document.getElementById('btn-import');
  const btnRestore = document.getElementById('btn-restore');

  const viewContents = document.querySelectorAll('.view-content');
  const viewSelectors = document.querySelectorAll('.view-selector');

  const statsBar = document.getElementById('stats-bar');

  const listContainer = document.getElementById('list-container');
  const projectSelector = document.getElementById('project-selector');
  const addProjectButton = document.getElementById('add-project-button');
  const deleteProjectButton = document.getElementById('delete-project-button');

  const searchButton = document.getElementById('search-button');
  const searchInput = document.getElementById('search-input');
  const quickAddInput = document.getElementById('quick-add-input');

  const filterButton = document.getElementById('filter-button');
  const filterPanel = document.getElementById('filter-panel');
  const filterDue = document.getElementById('filter-due');
  const filterPriority = document.getElementById('filter-priority');
  const filterStatus = document.getElementById('filter-status');

  const sortButton = document.getElementById('sort-button');
  const sortPanel = document.getElementById('sort-panel');
  const sortSelect = document.getElementById('sort-select');

  const taskModal = document.getElementById('task-modal');
  const taskBackdrop = document.getElementById('task-backdrop');
  const taskModalTitle = document.getElementById('task-modal-title');
  const addTaskButtons = document.querySelectorAll('#add-task-button, #mobile-add-task-button, #empty-state-add-task');
  const closeTaskModal = document.getElementById('close-task-modal');
  const cancelTask = document.getElementById('cancel-task');
  const saveTaskBtn = document.getElementById('save-task');

  const projectModal = document.getElementById('project-modal');
  const projectBackdrop = document.getElementById('project-backdrop');
  const closeProjectModal = document.getElementById('close-project-modal');
  const cancelProject = document.getElementById('cancel-project');
  const saveProject = document.getElementById('save-project');
  const deleteProject = document.getElementById('delete-project');

  const projectNameInput = document.getElementById('project-name');
  const projectColorInput = document.getElementById('project-color');

  const commandPalette = document.getElementById('command-palette');
  const commandInput = document.getElementById('command-input');
  const commandOptions = document.querySelectorAll('.command-option');

  const emptyState = document.getElementById('empty-state');

  // Календарь
  const prevMonth = document.getElementById('prev-month');
  const nextMonth = document.getElementById('next-month');
  const todayButton = document.getElementById('today-button');
  const monthTitle = document.getElementById('month-title');
  const weekdayRow = document.getElementById('weekday-row');
  const calendarGrid = document.getElementById('calendar-grid');

  // NEW: Модалки для Telegram-импорта/экспорта
  const exportJsonModal = document.getElementById('export-json-modal');
  const exportJsonText = document.getElementById('export-json-text');
  const exportJsonCopy = document.getElementById('export-json-copy');
  const exportJsonDownload = document.getElementById('export-json-download');

  const importJsonModal = document.getElementById('import-json-modal');
  const importJsonText = document.getElementById('import-json-text');
  const importJsonApply = document.getElementById('import-json-apply');

  const fileLinkModal = document.getElementById('file-link-modal');
  const fileLinkHref = document.getElementById('file-link-href');

  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;

  // Утилиты модалок
  function openModal(el){ el?.classList?.remove('hidden'); }
  function closeModal(el){ el?.classList?.add('hidden'); }
  document.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.getAttribute('data-close');
      const m = document.getElementById(id);
      closeModal(m);
    });
  });

  // --- Модель/состояние ---
  const state = {
    projects: [
      { id: 'work',     name: 'Работа',   color: '#3b82f6' },
      { id: 'personal', name: 'Личное',   color: '#10b981' },
      { id: 'team',     name: 'Команда',  color: '#8b5cf6' }
    ],
    tasks: [
      { id: uid(), title: 'Подготовить предложение по проекту', priority:'high', status:'in-progress', project:'work', dueDate: todayISO(1), description:'Согласовать разделы', tags:['Работа'], subtasks:['Исследовать конкурентов','Скелет документа'], subtasksDone:[false,false], completed:false, createdAt: nowISO() },
      { id: uid(), title: 'Командная встреча', priority:'medium', status:'backlog', project:'team', dueDate: todayISO(0), description:'Синк по задачам', tags:['Команда'], subtasks:[], subtasksDone:[], completed:false, createdAt: nowISO() },
      { id: uid(), title: 'Купить продукты', priority:'low', status:'backlog', project:'personal', dueDate:'', description:'Хлеб, молоко', tags:['Личное'], subtasks:['Список'], subtasksDone:[false], completed:false, createdAt: nowISO() },
      { id: uid(), title: 'Настроить CI/CD', priority:'high', status:'done', project:'team', dueDate: todayISO(-3), description:'GitHub Actions', tags:['DevOps'], subtasks:[], subtasksDone:[], completed:true, completedAt: todayISO(-2)+'T10:00:00Z', createdAt: nowISO() },
    ],
    view: 'list',
    search: '',
    filters: { due:'all', priority:'all', status:'all' },
    sort: 'due-asc',
    currentMonth: new Date(),
    selectedTaskId: null
  };

  // --- IndexedDB autobackup ---
  const BACKUP_DB = 'tp_backups_db';
  const BACKUP_STORE = 'snapshots';
  const BACKUP_EVERY_MIN = 5;
  const MAX_BACKUPS = 10;
  let idb;

  function openBackupDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(BACKUP_DB, 1);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains(BACKUP_STORE)){
          const store = db.createObjectStore(BACKUP_STORE, { keyPath:'ts' });
          store.createIndex('ts_idx', 'ts', { unique:true });
        }
      };
      req.onsuccess = ()=>{ idb = req.result; resolve(idb); };
      req.onerror = ()=> reject(req.error);
    });
  }
  function putBackup(dataObj){
    if(!idb) return;
    const tx = idb.transaction(BACKUP_STORE, 'readwrite');
    const store = tx.objectStore(BACKUP_STORE);
    store.put({ ts: Date.now(), data: dataObj });
    tx.oncomplete = ()=> pruneBackups();
  }
  function pruneBackups(){
    const tx = idb.transaction(BACKUP_STORE, 'readwrite');
    const store = tx.objectStore(BACKUP_STORE);
    const idx = store.index('ts_idx');
    const req = idx.getAllKeys();
    req.onsuccess = ()=>{
      const keys = req.result.sort((a,b)=>a-b);
      const toDelete = Math.max(0, keys.length - MAX_BACKUPS);
      for(let i=0;i<toDelete;i++){ store.delete(keys[i]); }
    };
  }
  function getLatestBackup(){
    return new Promise((resolve)=>{
      if(!idb) return resolve(null);
      const tx = idb.transaction(BACKUP_STORE, 'readonly');
      const store = tx.objectStore(BACKUP_STORE);
      const idx = store.index('ts_idx');
      const req = idx.getAll();
      req.onsuccess = ()=>{
        const arr = req.result;
        if(!arr.length) return resolve(null);
        arr.sort((a,b)=>b.ts-a.ts);
        resolve(arr[0]);
      };
      req.onerror = ()=> resolve(null);
    });
  }
  function scheduleAutobackup(){
    setInterval(()=> {
      const snapshot = { projects: state.projects, tasks: state.tasks, when: new Date().toISOString() };
      putBackup(snapshot);
    }, BACKUP_EVERY_MIN*60*1000);
  }

  // --- Загрузка/Сохранение ---
  const load = () => {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed.projects)) state.projects = parsed.projects;
      if (Array.isArray(parsed.tasks)) {
        state.tasks = parsed.tasks.map(t=>{
          if (Array.isArray(t.subtasks) && !Array.isArray(t.subtasksDone)) {
            t.subtasksDone = t.subtasks.map(()=>false);
          }
          return t;
        });
      }
    } catch(e){ console.warn('Ошибка загрузки:', e); }
  };
  const save = () => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      projects: state.projects,
      tasks: state.tasks
    }));
    updateAppBadge();
  };

  // --- Утилиты ---
  function uid(){ return Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
  function todayISO(shift=0){ const d=new Date(); d.setDate(d.getDate()+shift); return d.toISOString().slice(0,10); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtDateHuman(iso){ if(!iso) return 'Без срока'; const d = new Date(iso+'T00:00:00'); return d.toLocaleDateString('ru-RU',{ day:'2-digit', month:'long' }); }
  function projectById(id){ return state.projects.find(p=>p.id===id) || null; }
  function projectName(id){ return (projectById(id)?.name) || 'Без проекта'; }
  function priorityRu(p){ return ({low:'Низкий', medium:'Средний', high:'Высокий', critical:'Критичный'})[p] || p; }
  function statusRu(s){ return ({'backlog':'Бэклог','in-progress':'В работе','review':'Проверка','done':'Готово'})[s] || s; }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function hexToRgb(hex){ const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex || ''); return m ? { r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16) } : {r:59,g:130,b:246}; }
  function rgba(hex, a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function textColorForBg(hex){ const {r,g,b} = hexToRgb(hex); const yiq = (r*299 + g*587 + b*114)/1000; return yiq >= 128 ? '#111827' : '#f9fafb'; }
  function startOfWeek(d=new Date()){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-wd); return x; }
  function endOfWeek(d=new Date()){ const x=startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
  function parseRussianWeekdayToken(tok){ const map = { '/пн':1,'/вт':2,'/ср':3,'/чт':4,'/пт':5,'/сб':6,'/вс':0 }; return map[tok] ?? null; }
  function nextWeekdayISO(target){ const d=new Date(); const today=d.getDay(); let delta=(target-today+7)%7; if(delta===0) delta=7; d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }

  // --- Инициализация ---
  load();
  openBackupDB().then(()=> scheduleAutobackup()).catch(()=>{});
  hydrateProjectSelector();
  hydrateTaskProjectSelect();
  showView('list');
  renderAll();
  updateAppBadge();

  // --- Меню/темы ---
  menuBtn.addEventListener('click', ()=> sideMenu.classList.remove('hidden'));
  closeMenu.addEventListener('click', ()=> sideMenu.classList.add('hidden'));
  if (inTelegram) {
    document.getElementById('btn-theme-toggle').style.display = 'none';
  } else {
    themeToggle.addEventListener('click', ()=>{
      const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(next);
      renderAll();
    });
  }

  // --- Экспорт JSON (двухрежимный) ---
  btnExport.addEventListener('click', ()=>{
    const json = localStorage.getItem(STORAGE_KEY) || '{}';

    if (inTelegram) {
      exportJsonText.value = json;
      // Генерируем data: URL (надёжно для вебвью)
      const dataUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(json);
      exportJsonDownload.setAttribute('href', dataUrl);
      exportJsonDownload.setAttribute('download', 'planner-data.json');
      openModal(exportJsonModal);
    } else {
      // Классический Blob + клик по якорю (якорь добавляем в DOM)
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'planner-data.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
  });

  exportJsonCopy?.addEventListener('click', async ()=>{
    try {
      await navigator.clipboard.writeText(exportJsonText.value || '');
      if (tg?.showPopup) tg.showPopup({ message:'Скопировано!', buttons:[{type:'ok'}] });
      else alert('Скопировано!');
    } catch {
      alert('Не удалось скопировать');
    }
  });

  // --- Импорт JSON (двухрежимный) ---
  btnImport.addEventListener('click', ()=>{
    if (inTelegram) {
      importJsonText.value = '';
      openModal(importJsonModal);
    } else {
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = (e)=>{
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const data = JSON.parse(reader.result);
            if (data.projects) state.projects = data.projects;
            if (data.tasks) state.tasks = data.tasks;
            save(); renderAll();
            alert('Импортировано успешно');
          }catch(err){ alert('Ошибка импорта'); }
        };
        reader.readAsText(f);
      };
      inp.click();
    }
  });

  importJsonApply?.addEventListener('click', ()=>{
    try{
      const data = JSON.parse(importJsonText.value || '{}');
      if (data.projects) state.projects = data.projects;
      if (data.tasks) state.tasks = data.tasks;
      save(); hydrateProjectSelector(); hydrateTaskProjectSelect(); renderAll();
      closeModal(importJsonModal);
      if (tg?.showPopup) tg.showPopup({ message:'Импортировано успешно', buttons:[{type:'ok'}] });
      else alert('Импортировано успешно');
    } catch(e){
      if (tg?.showPopup) tg.showPopup({ message:'Ошибка импорта', buttons:[{type:'ok'}] });
      else alert('Ошибка импорта');
    }
  });

  // --- Бэкап из IndexedDB ---
  btnRestore.addEventListener('click', async ()=>{
    const last = await getLatestBackup();
    if (!last) { alert('Бэкапов пока нет'); return; }
    if (confirm(`Восстановить из бэкапа от ${new Date(last.ts).toLocaleString('ru-RU')}? Текущие данные будут заменены.`)) {
      try{
        const data = last.data || {};
        if (data.projects) state.projects = data.projects;
        if (data.tasks) state.tasks = data.tasks;
        save(); hydrateProjectSelector(); hydrateTaskProjectSelect(); renderAll();
        alert('Восстановлено из бэкапа');
      }catch(e){ alert('Не удалось восстановить'); }
    }
  });
    // --- Экспорт DOCX ---
  if (btnExportDocx) {
    btnExportDocx.addEventListener('click', exportDocx);
  }

  async function exportDocx(){
    if (!window.docx) { alert('Библиотека DOCX не загружена.'); return; }
    const {
      Document, Packer, Paragraph, HeadingLevel, TextRun, Table, TableRow, TableCell, AlignmentType, WidthType
    } = window.docx;

    const tasks = [...state.tasks];
    const projectsById = Object.fromEntries(state.projects.map(p => [p.id, p]));
    tasks.sort((a, b) => {
      const pa = projectsById[a.project]?.name || '';
      const pb = projectsById[b.project]?.name || '';
      const pn = pa.localeCompare(pb, 'ru');
      if (pn !== 0) return pn;
      const da = a.dueDate || '9999-12-31';
      const db = b.dueDate || '9999-12-31';
      if (da !== db) return da < db ? -1 : 1;
      return (a.title || '').localeCompare(b.title || '', 'ru');
    });
    const groups = {};
    for (const t of tasks) {
      const key = projectsById[t.project]?.name || 'Без проекта';
      (groups[key] ||= []).push(t);
    }

    const total = tasks.length;
    const done = tasks.filter(t => t.completed).length;
    const today = new Date().toISOString().slice(0,10);
    const overdue = tasks.filter(t => t.dueDate && !t.completed && t.dueDate < today).length;

    const docChildren = [];
    docChildren.push(new Paragraph({ text: 'Экспорт задач — Планировщик', heading: HeadingLevel.TITLE }));
    docChildren.push(new Paragraph(new TextRun({ text: new Date().toLocaleString('ru-RU'), italic: true })));
    docChildren.push(new Paragraph(' '));
    docChildren.push(new Paragraph({ text: `Всего задач: ${total}` }));
    docChildren.push(new Paragraph({ text: `Выполнено: ${done}` }));
    docChildren.push(new Paragraph({ text: `Просрочено: ${overdue}` }));
    docChildren.push(new Paragraph(' '));

    for (const [projName, arr] of Object.entries(groups)) {
      docChildren.push(new Paragraph({ text: projName, heading: HeadingLevel.HEADING_2 }));
      if (!arr.length) {
        docChildren.push(new Paragraph({ text: 'Нет задач' }));
        docChildren.push(new Paragraph(' '));
        continue;
      }
      const header = new TableRow({
        children: [
          new TableCell({ children:[new Paragraph('Задача')] }),
          new TableCell({ children:[new Paragraph('Срок')] }),
          new TableCell({ children:[new Paragraph('Приоритет')] }),
          new TableCell({ children:[new Paragraph('Статус')] }),
          new TableCell({ children:[new Paragraph('Метки')] }),
          new TableCell({ children:[new Paragraph('Подзадачи')] }),
        ]
      });
      const rows = arr.map(t => {
        const tags = (t.tags || []).join(', ');
        const due = t.dueDate ? t.dueDate.split('-').reverse().join('.') : '—';
        const subtasks = (t.subtasks || []).map((s, i) => {
          const done = Array.isArray(t.subtasksDone) ? !!t.subtasksDone[i] : false;
          return `${done ? '[x]' : '[ ]'} ${s}`;
        }).join('\n');
        return new TableRow({
          children: [
            new TableCell({ children:[new Paragraph(t.title || '—')] }),
            new TableCell({ children:[new Paragraph(due)] }),
            new TableCell({ children:[new Paragraph(priorityRu(t.priority || 'medium'))] }),
            new TableCell({ children:[new Paragraph(statusRu(t.status || 'backlog'))] }),
            new TableCell({ children:[new Paragraph(tags || '—')] }),
            new TableCell({ children:[new Paragraph(subtasks || '—')] }),
          ]
        });
      });
      const table = new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        alignment: AlignmentType.CENTER,
        rows: [header, ...rows]
      });
      docChildren.push(table);
      docChildren.push(new Paragraph(' '));
    }

    const doc = new Document({ sections: [{ children: docChildren }] });
    const blob = await Packer.toBlob(doc);

    if (inTelegram) {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        fileLinkHref.href = dataUrl;
        fileLinkHref.download = `tasks-export-${new Date().toISOString().slice(0,10)}.docx`;
        openModal(fileLinkModal);
      };
      reader.readAsDataURL(blob);
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks-export-${new Date().toISOString().slice(0,10)}.docx`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }
  }

  // --- Общий рендер и др. функции здесь (renderList, renderKanban, renderCalendar и т.д.) ---
  // (оставил их без изменений, кроме вызова save()/renderAll)

  // Пользователь
  const menuUser = document.getElementById('menu-user');
  if (user) menuUser.textContent = `${user.first_name || 'Профиль'}${user.last_name?' '+user.last_name:''} (@${user.username || 'id:'+user.id})`;

})();
</script>
</body>
</html>
