<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Планировщик задач</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    /* === ТЕМЫ === */
    :root{
      --bg:#ffffff;
      --text:#111827;
      --hint:#6b7280;
      --secondary:#f3f4f6;
      --button:#2563eb;
      --button-text:#ffffff;
      --ring:rgba(37,99,235,.35);
      --header-gradient:linear-gradient(90deg,#ffffff,#ffffff);
      
      /* Premium shimmer */
      --premium-grad: linear-gradient(90deg, #ffd700, #ff9f1c, #ffd700, #fff3b0);
      --premium-grad-dark: linear-gradient(90deg, #ffe08a, #ffc857, #ffe08a, #fff3b0);
    }
    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e5e7eb;
      --hint:#9ca3af;
      --secondary:#171a21;
      --button:#5b74f9;
      --button-text:#ffffff;
      --ring:rgba(91,116,249,.35);
      --header-gradient:linear-gradient(90deg,#10131a,#171a21);
    }
    /* Дополнительные темы */
    html[data-theme="sunset"]{ --bg:#fff7ed; --text:#1f2937; --hint:#6b7280; --secondary:#ffe9d6; --button:#f97316; --button-text:#1f2937; --ring:rgba(249,115,22,.35); --header-gradient:linear-gradient(90deg,#ffedd5,#fecaca,#fde68a); }
    html[data-theme="peach"]{ --bg:#fff1f2; --text:#1f2937; --hint:#6b7280; --secondary:#ffe4e6; --button:#fb7185; --button-text:#1f2937; --ring:rgba(251,113,133,.35); --header-gradient:linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68a); }
    html[data-theme="sand"]{ --bg:#faf6f0; --text:#1f2937; --hint:#6b7280; --secondary:#f1ebe2; --button:#d97706; --button-text:#111827; --ring:rgba(217,119,6,.35); --header-gradient:linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a); }
    html[data-theme="coral"]{ --bg:#fff5f0; --text:#1f2937; --hint:#6b7280; --secondary:#ffe8e0; --button:#f43f5e; --button-text:#fff; --ring:rgba(244,63,94,.35); --header-gradient:linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5); }
    html[data-theme="plum"]{ --bg:#f9f5ff; --text:#1f2937; --hint:#6b7280; --secondary:#f3e8ff; --button:#a855f7; --button-text:#fff; --ring:rgba(168,85,247,.35); --header-gradient:linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6); }
    html[data-theme="olive"]{ --bg:#f5f7f2; --text:#1f2937; --hint:#6b7280; --secondary:#e8efe1; --button:#7da453; --button-text:#111827; --ring:rgba(125,164,83,.35); --header-gradient:linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6); }

    /* === БАЗОВЫЕ СТИЛИ === */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--text);
      transition:background-color .25s,color .25s;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Inter',system-ui,sans-serif;
      overflow-x: hidden;
    }
    .ring-focus:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}
    .task-card{transition:box-shadow .15s, background-color .15s}
    .task-card:hover{box-shadow:0 4px 10px rgb(0 0 0 /.08)}
    .task-card.selected{outline:2px solid var(--ring); outline-offset:2px}
    
    .priority-low{background:rgba(52,211,153,.12);color:rgb(16,185,129)}
    .priority-medium{background:rgba(96,165,250,.12);color:rgb(59,130,246)}
    .priority-high{background:rgba(251,191,36,.12);color:rgb(234,179,8)}
    .priority-critical{background:rgba(239,68,68,.12);color:rgb(239,68,68)}
    
    .status-backlog{background:rgba(156,163,175,.12);color:rgb(156,163,175)}
    .status-in-progress{background:rgba(59,130,246,.12);color:rgb(59,130,246)}
    .status-review{background:rgba(168,85,247,.12);color:rgb(168,85,247)}
    .status-done{background:rgba(16,185,129,.12);color:rgb(16,185,129)}

    .kanban-column{min-height:60vh}
    .calendar-day{min-height:100px}
    .calendar-day.today{outline:2px solid var(--ring);outline-offset:-2px;background:rgba(0,0,0,.04)}
    .calendar-day.dragover{outline:2px dashed var(--ring); outline-offset:-2px}
    .command-palette{backdrop-filter:blur(10px)}
    .subtask-checkbox:checked+.subtask-label{text-decoration:line-through;color:var(--hint)}
    @media (max-width:640px){ .kanban-column{min-height:auto;max-height:60vh;overflow-y:auto} }
    .popover{position:absolute;z-index:30;background:var(--bg);border:1px solid var(--secondary);box-shadow:0 8px 24px rgb(0 0 0 / .12);border-radius:.75rem;min-width:240px}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .progress-wrap{height:6px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--button);width:0%}
    .title-input{background:transparent;border:1px dashed var(--secondary);padding:2px 6px;border-radius:6px;width:100%}

    .header-gradient{background-image:var(--header-gradient)}
    .bg-secondary{background:var(--secondary)}
    .btn-main{background:var(--button);color:var(--button-text)}
    .border-secondary{border-color:var(--secondary)}
    .text-hint{color:var(--hint)}

    .pin-chip{background:var(--secondary); border:1px solid var(--secondary)}
    .pin-chip.dragging{opacity:.5}

    /* PREMIUM GLOW */
    .badge-subscription{
      display:inline-flex;align-items:center;gap:.4rem;
      font-size:.75rem;line-height:1rem;
      border-radius:999px;border:1px solid var(--secondary);
      padding:.25rem .6rem;background:var(--secondary);user-select:none;cursor:default;
    }
    .badge-subscription .sep{opacity:.5}
    .premium-glow{
      font-weight:700;letter-spacing:.02em;
      background: var(--premium-grad);
      -webkit-background-clip:text;background-clip:text;
      color:transparent;
      animation: premiumShimmer 2.5s linear infinite;
      white-space:nowrap;
    }
    html[data-theme="dark"] .premium-glow{ background: var(--premium-grad-dark); }
    @keyframes premiumShimmer{ 0%{ background-position:0% 50%; } 100%{ background-position:200% 50%; } }

    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
      background:var(--bg);color:var(--text);
      border:1px solid var(--secondary);box-shadow:0 10px 30px rgb(0 0 0 / .18);
      padding:.75rem .9rem;border-radius:.75rem;z-index:60;max-width:92vw
    }
    .toast .toast-title{font-weight:600;margin-bottom:.25rem}
    .toast .toast-sub{font-size:.8rem;color:var(--hint)}

    .plan-card{border:1px solid var(--secondary);border-radius:.75rem;padding:.75rem;display:flex;align-items:center;gap:.65rem;background:var(--secondary)}
    .plan-card input{accent-color:var(--button)}
    .locked::after{
      content:'Premium';position:absolute;inset:auto 8px 8px auto;
      font-size:.7rem;padding:.25rem .5rem;border-radius:.5rem;
      background:rgba(0,0,0,.08);color:var(--text);border:1px dashed var(--secondary)
    }
    body::before{
      content:''; position:fixed; inset:-40vh -40vw;
      background: radial-gradient(closest-side at 20% 10%, rgba(255,215,0,.10), transparent 60%), radial-gradient(closest-side at 80% 0%, rgba(91,116,249,.10), transparent 55%);
      filter: blur(20px); pointer-events:none; z-index:-1;
    }
    .glass{ background: color-mix(in srgb, var(--bg) 78%, transparent); backdrop-filter: blur(12px); }
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-10 border-b border-secondary header-gradient">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="relative">
          <button id="menu-button" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Открыть меню">
            <i class="fas fa-bars"></i>
          </button>
          <aside id="side-menu" class="hidden fixed top-0 left-0 h-full w-80 bg-[var(--bg)] shadow-xl z-20 border-r border-secondary">
            <div class="p-4 border-b border-secondary flex justify-between items-center">
              <h2 class="text-lg font-semibold">Меню</h2>
              <button id="close-menu" class="p-2 rounded-full hover:bg-secondary ring-focus" aria-label="Закрыть">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="profile-box" class="p-4 border-b border-secondary flex items-center gap-3">
              <div id="profile-avatar" class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-sm font-semibold">?</div>
              <div class="min-w-0">
                <div id="profile-name" class="font-medium truncate">Гость</div>
                <div id="profile-username" class="text-xs text-hint truncate">autologin: off</div>
              </div>
            </div>
            <div class="p-3 space-y-1">
              <button id="btn-settings" class="w-full text-left px-4 py-2 rounded-lg hover:bg-secondary">
                <i class="fas fa-gear mr-2"></i>Настройки
              </button>
            </div>
          </aside>
          <div id="side-menu-backdrop" class="hidden fixed inset-0 bg-black/40 z-10"></div>
        </div>
        <h1 class="text-xl font-semibold">Планировщик</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="search-button" class="p-2 rounded-full hover:bg-secondary ring-focus"><i class="fas fa-search"></i></button>
        <button id="add-task-button" class="p-2 rounded-full btn-main ring-focus"><i class="fas fa-plus"></i></button>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-4">
    <!-- View Selector -->
    <div class="flex justify-center mb-4">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button data-view="list" class="view-selector px-4 py-2 text-sm font-medium rounded-l-lg border border-secondary hover:bg-secondary"><i class="fas fa-list mr-2"></i> Список</button>
        <button data-view="kanban" class="view-selector px-4 py-2 text-sm font-medium border-y border-secondary hover:bg-secondary" id="btn-view-kanban"><i class="fas fa-columns mr-2"></i> Доска</button>
        <button data-view="calendar" class="view-selector px-4 py-2 text-sm font-medium rounded-r-lg border border-secondary hover:bg-secondary" id="btn-view-calendar"><i class="fas fa-calendar-alt mr-2"></i> Календарь</button>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats-bar" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 mb-4"></div>

    <!-- Projects -->
    <div class="mb-2 flex items-center gap-2">
      <select id="project-selector" class="bg-secondary rounded-lg px-4 py-2 ring-focus"><option value="all">Все проекты</option></select>
      <button id="add-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus"><i class="fas fa-folder-plus"></i></button>
      <button id="delete-project-button" class="p-2 rounded-full hover:bg-secondary ring-focus"><i class="fas fa-trash"></i></button>
    </div>

    <!-- Pinned -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2"><div class="text-sm text-hint">Закреплённые</div></div>
      <div id="pinned-strip" class="flex gap-2 overflow-x-auto pb-1"></div>
    </div>

    <!-- Active Projects Panel (Prem) -->
    <section id="active-projects-panel" class="mb-4 hidden">
      <div class="flex items-center justify-between mb-2"><div class="text-sm font-medium"><i class="fas fa-bolt mr-1"></i> Активные проекты</div></div>
      <div id="active-projects-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
    </section>

    <!-- List View -->
    <section id="list-view" class="view-content">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">Задачи</h2>
        <div class="relative flex items-center gap-2">
          <input id="search-input" placeholder="Поиск..." class="hidden md:block px-3 py-2 rounded-lg bg-secondary ring-focus"/>
          <button id="filter-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary"><i class="fas fa-filter mr-1"></i></button>
          <div id="filter-panel" class="popover hidden p-3 right-0 top-10">
            <div class="text-sm font-semibold mb-2">Фильтры</div>
            <select id="filter-due" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus"><option value="all">Все сроки</option><option value="today">Сегодня</option><option value="week">Эта неделя</option><option value="overdue">Просроченные</option></select>
            <select id="filter-priority" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus"><option value="all">Все приоритеты</option><option value="critical">Критичный</option><option value="high">Высокий</option></select>
            <select id="filter-status" class="w-full px-3 py-2 rounded bg-secondary ring-focus"><option value="all">Все статусы</option><option value="backlog">Бэклог</option><option value="in-progress">В работе</option></select>
          </div>
          <button id="sort-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary"><i class="fas fa-sort mr-1"></i></button>
          <div id="sort-panel" class="popover hidden p-3 right-0 top-10">
            <select id="sort-select" class="w-full mb-2 px-3 py-2 rounded bg-secondary ring-focus"><option value="due-asc">Сроку (раньше)</option><option value="priority-desc">Приоритету (высокий)</option></select>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <input id="quick-add-input" class="w-full px-4 py-3 rounded-lg bg-secondary ring-focus" placeholder="Быстро добавить задачу…"/>
      </div>
      <div id="list-container" class="space-y-3"></div>
    </section>

    <!-- Kanban View -->
    <section id="kanban-view" class="view-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div data-col="backlog" class="kanban-column bg-secondary rounded-lg p-3"><div class="flex justify-between mb-3"><h3 class="font-medium">Бэклог</h3><span class="text-xs bg-gray-200 text-gray-800 rounded-full px-2 py-1" id="cnt-backlog">0</span></div><div class="space-y-3 column-body"></div></div>
        <div data-col="in-progress" class="kanban-column bg-secondary rounded-lg p-3"><div class="flex justify-between mb-3"><h3 class="font-medium">В работе</h3><span class="text-xs bg-blue-200 text-blue-800 rounded-full px-2 py-1" id="cnt-in-progress">0</span></div><div class="space-y-3 column-body"></div></div>
        <div data-col="review" class="kanban-column bg-secondary rounded-lg p-3"><div class="flex justify-between mb-3"><h3 class="font-medium">Проверка</h3><span class="text-xs bg-purple-200 text-purple-800 rounded-full px-2 py-1" id="cnt-review">0</span></div><div class="space-y-3 column-body"></div></div>
        <div data-col="done" class="kanban-column bg-secondary rounded-lg p-3"><div class="flex justify-between mb-3"><h3 class="font-medium">Готово</h3><span class="text-xs bg-green-200 text-green-800 rounded-full px-2 py-1" id="cnt-done">0</span></div><div class="space-y-3 column-body"></div></div>
      </div>
    </section>

    <!-- Calendar View -->
    <section id="calendar-view" class="view-content hidden">
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <button id="prev-month" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-chevron-left"></i></button>
          <h2 id="month-title" class="text-lg font-semibold">Месяц</h2>
          <button id="next-month" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-chevron-right"></i></button>
        </div>
        <button id="today-button" class="px-3 py-1 text-sm rounded-lg border border-secondary hover:bg-secondary">Сегодня</button>
      </div>
      <div id="weekday-row" class="grid grid-cols-7 gap-1 mb-1"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
    </section>
  </main>

  <!-- Mobile Nav -->
  <nav class="md:hidden sticky bottom-0 border-t border-secondary header-gradient">
    <div class="flex justify-around py-2">
      <button data-view="list" class="view-selector p-2 rounded-full hover:bg-secondary"><i class="fas fa-list text-lg"></i></button>
      <button data-view="kanban" class="view-selector p-2 rounded-full hover:bg-secondary" id="btn-mobile-kanban"><i class="fas fa-columns text-lg"></i></button>
      <button data-view="calendar" class="view-selector p-2 rounded-full hover:bg-secondary" id="btn-mobile-calendar"><i class="fas fa-calendar-alt text-lg"></i></button>
      <button id="mobile-add-task-button" class="p-2 rounded-full btn-main"><i class="fas fa-plus text-lg"></i></button>
    </div>
  </nav>

  <!-- Task Modal -->
  <div id="task-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="task-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 id="task-modal-title" class="text-xl font-semibold">Новая задача</h2>
        <button id="close-task-modal" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-4">
        <input type="hidden" id="task-id"/>
        <div class="mb-4"><input type="text" id="task-title" placeholder="Название задачи" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/></div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-sm text-hint mb-1">Приоритет</label><select id="task-priority" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"><option value="low">Низкий</option><option value="medium" selected>Средний</option><option value="high">Высокий</option><option value="critical">Критичный</option></select></div>
          <div><label class="block text-sm text-hint mb-1">Статус</label><select id="task-status" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"><option value="backlog">Бэклог</option><option value="in-progress">В работе</option><option value="review">Проверка</option><option value="done">Готово</option></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div><label class="block text-sm text-hint mb-1">Проект</label><select id="task-project" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></select></div>
          <div><label class="block text-sm text-hint mb-1">Срок</label><input type="date" id="task-due-date" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/></div>
        </div>
        <div class="mb-4"><label class="block text-sm text-hint mb-1">Описание</label><textarea id="task-description" rows="3" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea></div>
        <div class="mb-4"><label class="block text-sm text-hint mb-1">Подзадачи (Enter)</label><textarea id="task-subtasks" rows="2" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea></div>
        <div class="mb-4"><label class="block text-sm text-hint mb-1">Метки</label><input id="task-tags" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"/></div>
        <div class="flex justify-end gap-2 mt-6">
          <button id="cancel-task" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">Отмена</button>
          <button id="save-task" class="px-4 py-2 rounded-lg btn-main">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="project-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="project-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[80vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">Новый проект</h2>
        <button id="close-project-modal" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-4">
        <input type="hidden" id="project-id"/>
        <div class="mb-4"><input type="text" id="project-name" placeholder="Название проекта" class="w-full px-4 py-3 bg-secondary rounded-lg ring-focus"/></div>
        <div class="mb-4"><label class="block text-sm text-hint mb-1">Цвет</label><input type="color" id="project-color" value="#3b82f6" class="w-16 h-10 p-1 bg-secondary rounded ring-focus"/></div>
        <div class="mb-4"><label class="block text-sm text-hint mb-1">Описание</label><textarea id="project-description" rows="3" class="w-full px-4 py-2 bg-secondary rounded-lg ring-focus"></textarea></div>
        <div class="flex justify-between mt-6">
          <button id="delete-project" class="px-4 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50/10"><i class="fas fa-trash mr-1"></i>Удалить</button>
          <div class="flex gap-2">
            <button id="cancel-project" class="px-4 py-2 rounded-lg border border-secondary hover:bg-secondary">Отмена</button>
            <button id="save-project" class="px-4 py-2 rounded-lg btn-main">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
    <div class="modal-backdrop" id="settings-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl max-h-[85vh] overflow-y-auto">
      <div class="sticky top-0 bg-[var(--bg)] p-4 flex justify-between items-center border-b border-secondary">
        <h2 class="text-xl font-semibold">Настройки</h2>
        <button id="close-settings" class="p-2 rounded-full hover:bg-secondary"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-4 space-y-6">
        <div><div class="text-sm font-medium mb-2">Тема</div><div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div><div id="theme-upsell" class="text-xs text-hint mt-1 hidden">Premium только.</div></div>
        <div id="premium-settings-block" class="p-3 rounded-lg border border-secondary bg-[var(--secondary)]">
          <div class="flex items-center justify-between gap-2">
            <div><div class="text-sm font-medium">Подписка</div><div class="text-xs text-hint" id="premium-status-line">—</div></div>
            <button id="prem-manage" class="px-3 py-1 rounded-lg btn-main">Управление</button>
          </div>
        </div>
        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)] space-y-2">
          <div class="text-sm font-medium">Данные</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btn-export" class="px-3 py-2 rounded-lg border border-secondary hover:bg-[var(--bg)]">Экспорт</button>
            <button id="btn-import" class="px-3 py-2 rounded-lg border border-secondary hover:bg-[var(--bg)]">Импорт</button>
          </div>
          <button id="btn-clear-data" class="w-full px-3 py-2 rounded-lg border border-red-500 text-red-500 hover:bg-red-50/10">Сброс</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="relative w-full max-w-md mx-4">
      <div class="command-palette bg-[var(--bg)] rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-secondary">
          <div class="relative"><i class="fas fa-search absolute left-3 top-3 text-hint"></i><input type="text" id="command-input" placeholder="Команда..." class="w-full pl-10 pr-4 py-2 bg-secondary rounded-lg ring-focus"/></div>
        </div>
        <div class="max-h-96 overflow-y-auto">
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer flex items-center"><i class="fas fa-plus mr-3 text-blue-500"></i><span>Создать задачу</span></div>
          <div class="command-option px-4 py-3 hover:bg-secondary cursor-pointer flex items-center"><i class="fas fa-search mr-3 text-purple-500"></i><span>Поиск</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12">
    <div class="w-24 h-24 bg-secondary rounded-full flex items-center justify-center mb-4"><i class="fas fa-tasks text-3xl text-hint"></i></div>
    <h3 class="text-lg font-medium mb-2">Пока нет задач</h3>
    <button id="empty-state-add-task" class="px-4 py-2 rounded-lg btn-main">Добавить задачу</button>
  </div>
</div>

<script>
(async () => {
  // === КОНФИГУРАЦИЯ ССЫЛКИ ===
  // Вставьте сюда прямую ссылку на ваше Telegram WebApp (t.me/BotName/AppName)
  // Это нужно для кнопки "Перейти в приложение"
  const TELEGRAM_APP_LINK = 'https://t.me/D_a_n_Vi'; // <-- ЗАМЕНИТЕ НА СВОЮ

  /* ========= ЗАПРЕТ ОТКРЫТИЯ В БРАУЗЕРЕ (Telegram Only) ========= */
  (function enforceTelegramOnly(){
    // Проверка: есть ли объект Telegram и запущен ли он внутри клиента (initData не пустой или platform не unknown)
    const isTg = !!(window.Telegram && Telegram.WebApp);
    // В браузере platform часто 'unknown' или initData пустая
    const isValidEnv = isTg && (Telegram.WebApp.platform !== 'unknown' && Telegram.WebApp.platform !== undefined);
    
    // Если НЕ Telegram - блокируем
    if (!isValidEnv) {
      document.body.innerHTML = ''; // Очищаем тело
      document.body.style.background = 'var(--bg)';
      const gate = document.createElement('div');
      gate.style.position = 'fixed'; gate.style.inset = '0'; gate.style.zIndex = '9999';
      gate.style.background = '#ffffff'; // Всегда белый или можно считать тему
      gate.style.color = '#000000';
      gate.innerHTML = `
        <div style="height:100%; width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center; font-family:sans-serif;">
          <div style="width:64px; height:64px; border-radius:50%; background:#f3f4f6; display:flex; align-items:center; justify-content:center; margin-bottom:16px;">
            <i class="fas fa-mobile-alt" style="font-size:24px; color:#6b7280;"></i>
          </div>
          <h2 style="font-size:20px; font-weight:600; margin-bottom:8px;">Только в Telegram</h2>
          <p style="font-size:14px; color:#6b7280; margin-bottom:24px; max-width:300px;">
            Это приложение работает только внутри Telegram. Пожалуйста, откройте его через бота.
          </p>
          <a href="${TELEGRAM_APP_LINK}" style="background:#2563eb; color:white; text-decoration:none; padding:10px 20px; border-radius:8px; font-weight:500;">
            Открыть в Telegram
          </a>
        </div>
      `;
      document.body.appendChild(gate);
      // Бросаем ошибку, чтобы остановить выполнение скрипта дальше (данные не загрузятся)
      throw new Error("Telegram-only restriction");
    }
  })();

  /* ========= TELEGRAM / ПРОФИЛЬ / КЛЮЧИ ========= */
  const tg = window.Telegram?.WebApp;
  const tgUser = tg?.initDataUnsafe?.user || null;

  try { tg?.ready(); tg?.expand?.(); tg?.MainButton?.hide?.(); } catch(_) {}

  const LS_THEME_BASE = 'tp_theme_v2';
  const LS_DATA_BASE  = 'tp_data_default';
  const userSuffix    = tgUser?.id ? `tg_${tgUser.id}` : 'guest';
  const LS_THEME      = `${LS_THEME_BASE}_${userSuffix}`;
  const LS_DATA       = `${LS_DATA_BASE}_${userSuffix}`;

  const ADMIN_TG_ID = 1288379477;
  const PREMIUM_SECRET = 'tp$S3cr3t@v1';
  const PREMIUM_LS_KEY = tgUser?.id ? `tp_premium_${tgUser.id}` : `tp_premium_guest`;

  const BOT_USERNAME = 'YOUR_BOT_USERNAME';
  const MINIAPP_SHORTNAME = 'app';
  const PREMIUM_API_BASE = '';
  const USED_LINKS_KEY = `tp_used_links_${userSuffix}`;

  // Профиль
  const nameEl = document.getElementById('profile-name');
  const usernameEl = document.getElementById('profile-username');
  const avatarEl = document.getElementById('profile-avatar');
  if (tgUser) {
    nameEl.textContent = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ');
    usernameEl.textContent = 'ID: ' + tgUser.id;
    if (tgUser.photo_url) {
      avatarEl.style.backgroundImage = `url('${tgUser.photo_url}')`;
      avatarEl.style.backgroundSize = 'cover';
      avatarEl.textContent = '';
    } else {
      avatarEl.textContent = (tgUser.first_name?.[0] || '?').toUpperCase();
    }
  }

  /* ========= ТЕМЫ ========= */
  const THEMES = [
    { id:'light',  name:'Светлая',  grad:'linear-gradient(90deg,#ffffff,#f9fafb)' },
    { id:'dark',   name:'Тёмная',   grad:'linear-gradient(90deg,#0f1115,#171a21)' },
    { id:'sunset', name:'Sunset',   grad:'linear-gradient(90deg,#ffedd5,#fecaca,#fde68a)' },
    { id:'peach',  name:'Peach',    grad:'linear-gradient(90deg,#ffe4e6,#fecdd3,#fde68a)' },
    { id:'sand',   name:'Sand',     grad:'linear-gradient(90deg,#f5eede,#f1ebe2,#fde68a)' },
    { id:'coral',  name:'Coral',    grad:'linear-gradient(90deg,#ffd1c7,#ffe0d5,#fff0e5)' },
    { id:'plum',   name:'Plum',     grad:'linear-gradient(90deg,#ede9fe,#f5d0fe,#ffe4e6)' },
    { id:'olive',  name:'Olive',    grad:'linear-gradient(90deg,#eef4e6,#d9e7cc,#f0ead6)' },
  ];
  const savedTheme = localStorage.getItem(LS_THEME) || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  function setTheme(id){ document.documentElement.setAttribute('data-theme', id); localStorage.setItem(LS_THEME, id); }

  /* ========= PREMIUM ЛОГИКА ========= */
  const premium = { tier:'free', expiresAt:null, trial:false };
  
  function showToast(html){
    const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = html;
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.remove(); }, 2500);
  }
  function b64u(str){ return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function b64uDec(s){ s = s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return atob(s); }
  function hashFn(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24); }
    return ('0000000' + (h>>>0).toString(16)).slice(-8);
  }
  function signPayload(obj){
    const payload = JSON.stringify(obj);
    const sig = hashFn(PREMIUM_SECRET + '|' + payload + '|v1');
    return `TP1.${b64u(payload)}.${sig}`;
  }
  function verifyAndParse(code){
    if (!code || typeof code!=='string') return null;
    const parts = code.trim().split('.');
    if (parts.length !== 3 || parts[0] !== 'TP1') return null;
    try{
      const payloadStr = b64uDec(parts[1]);
      const sig = parts[2];
      const ok = hashFn(PREMIUM_SECRET + '|' + payloadStr + '|v1') === sig;
      return ok ? JSON.parse(payloadStr) : null;
    }catch{ return null; }
  }
  function isPremiumActive(){ return premium.tier==='premium'; }
  function fmtISOdate(iso){ try{ return new Date(iso).toLocaleDateString(); }catch{return iso;} }

  function fetchPremiumStatus(){
    if (String(tgUser?.id) === String(ADMIN_TG_ID)){
      premium.tier='premium'; premium.expiresAt='2099-12-31T00:00:00.000Z'; premium.trial=false;
      reflectPremiumUI(); return;
    }
    // Trial check
    const raw = localStorage.getItem(PREMIUM_LS_KEY);
    if (!raw) {
      const end = new Date(); end.setDate(end.getDate()+3);
      localStorage.setItem(PREMIUM_LS_KEY, JSON.stringify({ end_ts:end.toISOString(), source:'trial' }));
    }
    premium.tier='free'; premium.expiresAt=null;
    const rec = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY)||'{}');
    if (rec.end_ts && new Date(rec.end_ts) > new Date()){
      premium.tier = 'premium'; premium.expiresAt = rec.end_ts; premium.trial = rec.source==='trial';
    }
    reflectPremiumUI();
  }

  function reflectPremiumUI(){
    let badge = document.getElementById('premium-badge');
    if (!badge) {
      badge = document.createElement('button'); badge.id = 'premium-badge'; badge.className = 'badge-subscription ring-focus';
      document.querySelector('h1').after(badge);
      badge.addEventListener('click', ()=> openPremiumModal());
    }
    if (isPremiumActive()){
      badge.innerHTML = `<span class="sep">Подписка</span> <i class="fas fa-crown"></i> <span class="premium-glow">Premium${premium.trial?' · Trial':''}</span>`;
    } else {
      badge.innerHTML = `<span class="sep">Подписка</span> <span>Базовая</span>`;
    }
    gateFeaturesByPlan();
  }

  function normalizePremiumInput(input){
    try{
      if (/^https?:\/\//i.test(input)) {
        const u = new URL(input);
        return (u.searchParams.get('startapp') || u.searchParams.get('start_param') || '').replace(/^TPP_/, '');
      }
    }catch(_){}
    return input.replace(/^TPP_/, '');
  }

  // === ИСПРАВЛЕННАЯ ФУНКЦИЯ АКТИВАЦИИ ===
  async function redeemPremium(input){
    const tokenOrCode = normalizePremiumInput(input);
    if (!tokenOrCode){ alert('Введите код'); return; }
    
    // 1. Попытка через сервер (Вариант А)
    if (PREMIUM_API_BASE){
      try{
        const r = await fetch(PREMIUM_API_BASE+'/redeem', { method:'POST', body:JSON.stringify({token:tokenOrCode, initData:tg?.initData||''}) });
        const j = await r.json();
        if (r.ok && j.end_ts){
           localStorage.setItem(PREMIUM_LS_KEY, JSON.stringify({ end_ts:j.end_ts, source:'link' }));
           fetchPremiumStatus(); showToast('Премиум активирован'); return;
        }
      }catch(e){}
    }
    
    // 2. Локальная проверка (Вариант Б) - ВОССТАНОВЛЕННАЯ ЛОГИКА
    const data = verifyAndParse(tokenOrCode);
    if (!data){ alert('Неверный код'); return; }
    
    const used = new Set(JSON.parse(localStorage.getItem(USED_LINKS_KEY)||'[]'));
    if (data.one && used.has(data.one)){ alert('Уже использован'); return; }
    
    // Применяем дни
    const days = Number(data.durDays || 31);
    const now = new Date();
    const store = JSON.parse(localStorage.getItem(PREMIUM_LS_KEY)||'{}');
    let base = (store.end_ts && new Date(store.end_ts)>now) ? new Date(store.end_ts) : now;
    const newEnd = new Date(base);
    newEnd.setDate(newEnd.getDate() + days);
    
    localStorage.setItem(PREMIUM_LS_KEY, JSON.stringify({ end_ts:newEnd.toISOString(), source:'code' }));
    if(data.one){
      used.add(data.one);
      localStorage.setItem(USED_LINKS_KEY, JSON.stringify([...used]));
    }
    
    fetchPremiumStatus();
    showToast('<div class="toast-title">Успешно!</div><div class="toast-sub">Премиум продлен</div>');
  }

  function openPremiumModal(){
    const id = 'premium-modal';
    if(document.getElementById(id)) document.getElementById(id).remove();
    const modal = document.createElement('div');
    modal.id = id; modal.className = 'fixed inset-0 z-50';
    modal.innerHTML = `
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-[var(--bg)] rounded-t-3xl shadow-xl p-5 space-y-4 max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center"><h3 class="text-lg font-semibold">Premium</h3><button id="prem-close"><i class="fas fa-times"></i></button></div>
        <div class="p-3 rounded-lg border border-secondary bg-[var(--secondary)]">
          <div>Статус: <b>${isPremiumActive()?'Premium':'Базовая'}</b></div>
          <div class="text-xs text-hint mt-1">${premium.expiresAt? 'До: '+fmtISOdate(premium.expiresAt):''}</div>
        </div>
        <div class="space-y-2">
          <div class="text-sm font-medium">Есть код?</div>
          <div class="flex gap-2"><input id="promo-input" class="flex-1 px-3 py-2 rounded-lg bg-secondary" placeholder="Код"/><button id="btn-redeem" class="px-3 py-2 rounded-lg btn-main">ОК</button></div>
        </div>
        <button id="btn-buy" class="w-full px-3 py-2 rounded-lg border border-secondary">Купить / Написать админу</button>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#prem-close').addEventListener('click', ()=> modal.remove());
    modal.querySelector('#btn-redeem').addEventListener('click', ()=>{ redeemPremium(modal.querySelector('#promo-input').value); modal.remove(); });
    modal.querySelector('#btn-buy').addEventListener('click', ()=>{ window.open('https://t.me/D_a_n_Vi','_blank'); modal.remove(); });
  }

  /* ========= ЛОГИКА ПРИЛОЖЕНИЯ ========= */
  // Данные и состояние
  const state = { projects:[], pinned:[], tasks:[], view:'list', filters:{due:'all',priority:'all',status:'all'}, sort:'due-asc', currentMonth:new Date(), selectedTaskId:null };
  
  async function load(){
    let raw = localStorage.getItem(LS_DATA);
    if(raw){
      try{
        const d = JSON.parse(raw);
        state.projects = d.projects||[]; state.pinned = d.pinned||[]; state.tasks = d.tasks||[];
        if(!state.projects.length) state.projects = [{id:'work',name:'Работа',color:'#3b82f6'},{id:'personal',name:'Личное',color:'#10b981'}];
      }catch{}
    } else {
       state.projects = [{id:'work',name:'Работа',color:'#3b82f6'},{id:'personal',name:'Личное',color:'#10b981'}];
       state.pinned = ['work','personal'];
    }
  }
  function save(){ localStorage.setItem(LS_DATA, JSON.stringify({projects:state.projects, pinned:state.pinned, tasks:state.tasks})); }

  function gateFeaturesByPlan(){
    const prem = isPremiumActive();
    document.getElementById('active-projects-panel').classList.toggle('hidden', !prem);
    if(!prem && (state.view==='kanban'||state.view==='calendar')) showView('list');
  }

  function renderAll(){
    // Отрисовка списка
    const list = document.getElementById('list-container');
    list.innerHTML = '';
    const tasks = state.tasks; // (Тут должна быть фильтрация, сокращено для надежности)
    if(!tasks.length) document.getElementById('empty-state').classList.remove('hidden');
    else document.getElementById('empty-state').classList.add('hidden');
    
    tasks.forEach(t => {
      const d = document.createElement('div');
      d.className = 'task-card bg-secondary rounded-lg p-4 mb-2 flex justify-between';
      d.innerHTML = `<div><div class="font-medium">${t.title}</div><div class="text-sm text-hint">${t.status}</div></div>`;
      list.appendChild(d);
    });
    
    renderPinned();
  }

  function renderPinned(){
    const strip = document.getElementById('pinned-strip');
    strip.innerHTML = '';
    state.pinned.forEach(pid => {
      const p = state.projects.find(x=>x.id===pid);
      if(p) {
        const ch = document.createElement('div');
        ch.className='pin-chip px-3 py-2 rounded-lg text-sm';
        ch.innerHTML = `<span style="color:${p.color}">●</span> ${p.name}`;
        strip.appendChild(ch);
      }
    });
  }
  
  // Инициализация событий кнопок (Теперь работает, так как SyntaxError исправлен)
  document.getElementById('add-task-button').addEventListener('click', ()=> { document.getElementById('task-modal').classList.remove('hidden'); });
  document.getElementById('close-task-modal').addEventListener('click', ()=> { document.getElementById('task-modal').classList.add('hidden'); });
  document.getElementById('save-task').addEventListener('click', ()=> {
    const title = document.getElementById('task-title').value;
    if(title) {
      state.tasks.unshift({id:Date.now().toString(), title, status:'backlog', project:'work'});
      save(); renderAll(); document.getElementById('task-modal').classList.add('hidden');
    }
  });

  // Запуск
  await load();
  fetchPremiumStatus();
  renderAll();

})();
</script>
</body>
</html>
